'use strict';var $jscomp={scope:{},global:this},Symbol;$jscomp.initSymbol=function(){$jscomp.global.Symbol||(Symbol=$jscomp.Symbol);$jscomp.initSymbol=function(){}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return"jscomp_symbol_"+a+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();Symbol.iterator||(Symbol.iterator=Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();if(a[Symbol.iterator])return a[Symbol.iterator]();if(!(a instanceof Array||"string"==typeof a||a instanceof String))throw new TypeError(a+" is not iterable");var e=0;return{next:function(){return e==a.length?{done:!0}:{done:!1,value:a[e++]}}}};$jscomp.arrayFromIterator=function(a){for(var e,b=[];!(e=a.next()).done;)b.push(e.value);return b};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.arrayFromArguments=function(a){for(var e=[],b=0;b<a.length;b++)e.push(a[b]);return e};$jscomp.inherits=function(a,e){function b(){}b.prototype=e.prototype;a.prototype=new b;a.prototype.constructor=a;for(var c in e)if($jscomp.global.Object.defineProperties){var d=$jscomp.global.Object.getOwnPropertyDescriptor(e,c);void 0!==d&&$jscomp.global.Object.defineProperty(a,c,d)}else a[c]=e[c]};var xiNET={svgns:"http://www.w3.org/2000/svg",xlinkNS:"http://www.w3.org/1999/xlink",linkWidth:1.3,homodimerLinkWidth:1.3};
xiNET.highlightColour=new RGBColor("#fdc086");xiNET.selectedColour=new RGBColor("#ffff99");xiNET.defaultSelfLinkColour=new RGBColor("#9970ab");xiNET.defaultInterLinkColour=new RGBColor("#35978f");xiNET.homodimerLinkColour=new RGBColor("#a50f15");xiNET.Controller={};xiNET.Controller.MOUSE_UP=0;xiNET.Controller.PANNING=1;xiNET.Controller.DRAGGING=2;xiNET.Controller.ROTATING=3;xiNET.Controller.SCALING_PROTEIN=4;xiNET.Controller.SCALING_ALL_PROTEINS=5;xiNET.Controller.SELECTING=6;
(function(a){a.CLMS=a.CLMS||{};a.CLMS.CrosslinkViewerBB=Backbone.View.extend({tagName:"div",events:{"click .downloadButton":"downloadSVG"},initialize:function(a){this.options=_.extend({},a.myOptions);this.displayEventName=a.displayEventName;var b=this,c=d3.select(this.el);c.selectAll("*").remove();var d=document.createElementNS("http://www.w3.org/1999/xhtml","div");d.setAttribute("style","width:100%;height:100%;display:block;");c.node().appendChild(d);this.svgElement=document.createElementNS(xiNET.svgns,
"svg");this.svgElement.setAttribute("id","networkSVG");this.svgElement.setAttribute("width","100%");this.svgElement.setAttribute("height","100%");this.svgElement.oncontextmenu=function(){return!1};b=this;this.svgElement.onmousedown=function(a){b.mouseDown(a)};this.svgElement.onmousemove=function(a){b.mouseMove(a)};this.svgElement.onmouseup=function(a){b.mouseUp(a)};this.svgElement.onmouseout=function(a){b.hideTooltip(a)};c=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";document.attachEvent?
this.svgElement.attachEvent("on"+c,function(a){b.mouseWheel(a)}):document.addEventListener&&this.svgElement.addEventListener(c,function(a){b.mouseWheel(a)},!1);this.lastMouseUp=(new Date).getTime();this.svgElement.ontouchstart=function(a){b.touchStart(a)};this.svgElement.ontouchmove=function(a){b.touchMove(a)};this.svgElement.ontouchend=function(a){b.touchEnd(a)};this.linkSelectionCallbacks=[];this.linkHighlightsCallbacks=[];this.legendCallbacks=[];d.appendChild(this.svgElement);this.ambigShown=this.selfLinksShown=
!0;d=document.createElementNS(xiNET.svgns,"rect");d.setAttribute("id","background_fill");d.setAttribute("x",0);d.setAttribute("y",0);d.setAttribute("width",5120);d.setAttribute("height",4096);d.setAttribute("fill-opacity","1");d.setAttribute("fill","#FFFFFF");this.svgElement.appendChild(d);this.container=document.createElementNS(xiNET.svgns,"g");this.container.setAttribute("id","container");this.p_pLinksWide=document.createElementNS(xiNET.svgns,"g");this.p_pLinksWide.setAttribute("id","p_pLinksWide");
this.container.appendChild(this.p_pLinksWide);this.proteinLower=document.createElementNS(xiNET.svgns,"g");this.proteinLower.setAttribute("id","proteinLower");this.container.appendChild(this.proteinLower);this.highlights=document.createElementNS(xiNET.svgns,"g");this.highlights.setAttribute("class","highlights");this.container.appendChild(this.highlights);this.res_resLinks=document.createElementNS(xiNET.svgns,"g");this.res_resLinks.setAttribute("id","res_resLinks");this.container.appendChild(this.res_resLinks);
this.p_pLinks=document.createElementNS(xiNET.svgns,"g");this.p_pLinks.setAttribute("id","p_pLinks");this.container.appendChild(this.p_pLinks);this.proteinUpper=document.createElementNS(xiNET.svgns,"g");this.proteinUpper.setAttribute("id","proteinUpper");this.container.appendChild(this.proteinUpper);this.svgElement.appendChild(this.container);this.tooltip=document.createElementNS(xiNET.svgns,"text");this.tooltip.setAttribute("x",0);this.tooltip.setAttribute("y",0);d=document.createTextNode("tooltip");
this.tooltip.appendChild(d);this.tooltip_bg=document.createElementNS(xiNET.svgns,"rect");this.tooltip_bg.setAttribute("class","tooltip_bg");this.tooltip_bg.setAttribute("fill-opacity",.75);this.tooltip_bg.setAttribute("stroke-opacity",1);this.tooltip_bg.setAttribute("stroke-width",1);this.tooltip_subBg=document.createElementNS(xiNET.svgns,"rect");this.tooltip_subBg.setAttribute("fill","white");this.tooltip_subBg.setAttribute("stroke","white");this.tooltip_subBg.setAttribute("class","tooltip_bg");
this.tooltip_subBg.setAttribute("opacity",1);this.tooltip_subBg.setAttribute("stroke-width",1);this.svgElement.appendChild(this.tooltip_subBg);this.svgElement.appendChild(this.tooltip_bg);this.svgElement.appendChild(this.tooltip);this.clear();this.initProteins();this.initLayout();d=this.model.get("clmsModel").get("crossLinks").values();d=$jscomp.makeIterator(d);for(c=d.next();!c.done;c=d.next()){var c=c.value,f=new ResidueLink(c);this.residueLinks.set(c.id,f)}this.listenTo(this.model.get("filterModel"),
"change",this.render);this.listenTo(this.model.get("rangeModel"),"change:scale",this.relayout);a.displayEventName&&this.listenTo(CLMSUI.vent,a.displayEventName,this.setVisible)},clear:function(){this.sequenceInitComplete=!1;this.force&&this.force.stop();this.force=null;d3.select(this.p_pLinksWide).selectAll("*").remove();d3.select(this.highlights).selectAll("*").remove();d3.select(this.p_pLinks).selectAll("*").remove();d3.select(this.res_resLinks).selectAll("*").remove();d3.select(this.proteinLower).selectAll("*").remove();
d3.select(this.proteinUpper).selectAll("*").remove();this.panning=!1;this.dragElement=null;this.dragging=!1;this.dragStart={};this.rotating=!1;this.proteins=d3.map();this.residueLinks=d3.map();this.matches=[];this.groups=d3.set();this.subgraphs=[];this.proteinCount=this.layoutXOffset=0;this.unambigLinkFound=!1;this.maxBlobRadius=30;Protein.MAXSIZE=100;this.layout=null;this.z=1;this.scores=null;this.selectedLinks=d3.map();this.hideTooltip();this.resetZoom();this.state=xiNET.Controller.MOUSE_UP},checkLinks:function(){for(var a=
this.residueLinks.values(),b=a.length,c=0;c<b;c++)a[c].check()},initLayout:function(){for(var a=this.proteins.values(),b=a.length,c=Protein.MAXSIZE=0;c<b;c++){var d=a[c].size;d>Protein.MAXSIZE&&(Protein.MAXSIZE=d)}Protein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-Protein.LABELMAXLENGTH)/Protein.MAXSIZE;a=this.groups.values().length;if(1<a&&5>a){this.groups.values();this.linkColours=d3.scale.ordinal().range(colorbrewer.Dark2[5]);b=this.groups.values();for(c=0;c<a;c++)this.linkColours(b[c]);
this.legendChanged()}if("undefined"!==typeof this.layout&&null!=this.layout)this.loadLayout();else{a=this.proteins.values();b=a.length;for(c=0;c<b;c++)d=a[c],this.proteinLower.appendChild(d.lowerGroup),this.proteinUpper.appendChild(d.upperGroup);this.autoLayout()}},initProteins:function(){var a=this.model.get("clmsModel").get("interactors").values();Protein.MAXSIZE=0;for(var a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next()){var b=b.value,c=new Protein(b.id,this,b.accession,b.label);c.setSequence(b.sequence);
this.proteins.set(b.id,c);b=b.size;b>Protein.MAXSIZE&&(Protein.MAXSIZE=b)}Protein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-Protein.LABELMAXLENGTH)/Protein.MAXSIZE;a=this.proteins.values();b=a.length;for(c=0;c<b;c++)a[c].init();this.sequenceInitComplete=!0;this.annotationSet?this.setAnnotations(this.annotationSet):this.setAnnotations("CUSTOM")},reset:function(){this.resetZoom();for(var a=this.proteins.values(),b=a.length,c=0;c<b;c++){var d=a[c];!1===d.isParked&&d.setForm(0)}this.autoLayout()},
resetZoom:function(){this.container.setAttribute("transform","scale(1)");this.scale()},scale:function(){},setAnnotations:function(a){function b(){var a=d3.set();for(f=0;f<d;f++)for(var b=c[f],e=0;e<b.annotations.length;e++)a.add(b.annotations[e].name);b=a.values().length;3>b&&(b=3);9>b?(b=colorbrewer.Accent[b].slice().reverse(),h.domainColours=d3.scale.ordinal().range(b)):13>b?(b=colorbrewer.Set3[b].slice().reverse(),h.domainColours=d3.scale.ordinal().range(b)):h.domainColours=d3.scale.category20();
for(f=0;f<d;f++)for(b=c[f],e=0;e<b.annotations.length;e++){var a=b.annotations[e],g=h.domainColours(a.name);a.pieSlice.setAttribute("fill",g);a.pieSlice.setAttribute("stroke",g);a.colouredRect.setAttribute("fill",g);a.colouredRect.setAttribute("stroke",g)}h.legendChanged()}this.annotationChoice=a;for(var c=this.proteins.values(),d=c.length,f=0;f<d;f++)c[f].clearPositionalFeatures();this.domainColours=null;this.legendChanged();if(this.sequenceInitComplete){var h=this;if("CUSTOM"===a.toUpperCase()){for(f=
0;f<d;f++)a=c[f],a.setPositionalFeatures(a.customAnnotations);b()}else if("LYSINES"===a.toUpperCase()){for(f=0;f<d;f++){a=c[f];for(var l=a.sequence,g=[],k=0;k<a.size;k++)"K"===l[k]&&g.push(new Annotation("Lysine",k+1,k+1));a.setPositionalFeatures(g)}b()}else if("SUPERFAM"===a.toUpperCase()||"SUPERFAMILY"===a.toUpperCase())for(var m=0,f=0;f<d;f++)a=c[f],this.xiNET_storage.getSuperFamFeatures(a.id,function(a,e){h.proteins.get(a).setPositionalFeatures(e);m++;m===d&&b()});else if("UNIPROT"===a.toUpperCase()||
"UNIPROTKB"===a.toUpperCase())for(f=m=0;f<d;f++)a=c[f],this.xiNET_storage.getUniProtFeatures(a.id,function(a,e){var c=h.proteins.get(a);if(-1===c.accession.indexOf("-")||"P02768-A"===c.accession){if("P02768-A"===c.accession)for(var f=0;f<e.length;f++){var g=e[f];g.start+=-24;g.end+=-24}c.setPositionalFeatures(e)}m++;m===d&&b()})}},legendChanged:function(){for(var a=this.legendCallbacks,b=a.length,c=0;c<b;c++)a[c](this.linkColours,this.domainColours)},setCTM:function(a,b){a.setAttribute("transform",
"matrix("+b.a+","+b.b+","+b.c+","+b.d+","+b.e+","+b.f+")")},mouseDown:function(a){a.preventDefault();"undefined"!==typeof this.force&&null!=this.force&&this.force.stop();var b=this.getEventPoint(a);this.dragStart=this.mouseToSVG(b.x,b.y);var c;a.which?c=3===a.which:a.button&&(c=2===a.button);!0===a.ctrlKey||!0===a.shiftKey||c||(this.state=xiNET.Controller.PANNING,this.panned=!1);return!1},mouseMove:function(a){var b=this.getEventPoint(a);a=this.mouseToSVG(b.x,b.y);if(null!=this.dragElement){this.hideTooltip();
var c=this.dragStart.x-a.x,d=this.dragStart.y-a.y;if(this.state===xiNET.Controller.DRAGGING){var f,h;if("undefined"===typeof this.dragElement.x){var l;l=this.dragElement.fromProtein?this.dragElement.fromProtein:this.dragElement.proteinLink.fromProtein;for(var g=this.proteins.values(),k=g.length,b=0;b<k;b++)g[b].subgraph=null;b=l.getSubgraph().nodes.values();l=b.length;for(g=0;g<l;g++)k=b[g],f=k.x,h=k.y,f-=c,h-=d,k.setPosition(f,h),k.setAllLineCoordinates();for(g=0;g<l;g++)b[g].setAllLineCoordinates()}else f=
this.dragElement.x,h=this.dragElement.y,this.dragElement.setPosition(f-c,h-d),this.dragElement.setAllLineCoordinates();this.dragStart=a}else this.state===xiNET.Controller.ROTATING?(a=Math.atan2(a.y-this.dragElement.y,a.x-this.dragElement.x),0===this.whichRotator&&(a+=Math.PI),this.dragElement.setRotation(360/(2*Math.PI)*a),this.dragElement.setAllLineCoordinates()):Math.sqrt(c*c+d*d)>5*this.z&&(this.state=xiNET.Controller.DRAGGING)}else this.state===xiNET.Controller.PANNING?this.setCTM(this.container,
this.container.getCTM().translate(a.x-this.dragStart.x,a.y-this.dragStart.y)):this.showTooltip(b);return!1},mouseUp:function(a){var b=(new Date).getTime();this.preventDefaultsAndStopPropagation(a);if(150<b-this.lastMouseUp){var c,d;a.which?c=3===a.which:a.button&&(c=2===a.button);a.which?d=2===a.which:a.button&&(d=1===a.button);var f=this.getEventPoint(a),f=this.mouseToSVG(f.x,f.y);if(null!=this.dragElement)this.state!==xiNET.Controller.DRAGGING&&this.state!==xiNET.Controller.ROTATING?c?"undefined"===
typeof this.dragElement.x?1==this.dragElement.selfLink()?this.dragElement.proteinLink&&this.dragElement.proteinLink.fromProtein.toggleFlipped():(void 0!==this.dragElement.hidden?this.dragElement.hidden=!0:this.dragElement.proteinLink.hidden=!0,this.dragElement.highlightLine.setAttribute("stroke-opacity","0"),this.checkLinks()):this.dragElement.setParked(!this.dragElement.isParked,f):d||"undefined"!==typeof this.dragElement.x&&(a.shiftKey?this.dragElement.switchStickScale(f):!0===this.sequenceInitComplete&&
(1===this.dragElement.form?this.dragElement.setForm(0,f):this.dragElement.setForm(1,f))):this.state===xiNET.Controller.ROTATING&&this.dragElement.setRotation(5*Math.round(this.dragElement.rotation/5));else if(c){a=this.proteinLinks.values();c=a.length;for(d=0;d<c;d++)a[d].hidden=!1;this.checkLinks()}this.state===xiNET.Controller.SELECTING&&(clearInterval(this.marcher),this.svgElement.removeChild(this.marquee))}this.dragElement=null;this.whichRotator=-1;this.state=xiNET.Controller.MOUSE_UP;this.lastMouseUp=
b;return!1},mouseWheel:function(a){this.preventDefaultsAndStopPropagation(a);var b=1+(a.wheelDelta?a.wheelDelta/3600:a.detail/-90),c=this.container;a=this.getEventPoint(a);a=this.mouseToSVG(a.x,a.y);b=this.svgElement.createSVGMatrix().translate(a.x,a.y).scale(b).translate(-a.x,-a.y);this.setCTM(c,c.getCTM().multiply(b));this.scale();return!1},getEventPoint:function(a){var b=this.svgElement.createSVGPoint(),c=this.svgElement.parentNode,d=0,f=0;do d+=c.offsetTop||0,f+=c.offsetLeft||0,c=c.offsetParent;
while(c);b.x=a.pageX-f;b.y=a.pageY-d;return b},mouseToSVG:function(a,b){var c=this.svgElement.createSVGPoint();c.x=a;c.y=b;return c=c.matrixTransform(this.container.getCTM().inverse())},preventDefaultsAndStopPropagation:function(a){a.stopPropagation&&a.stopPropagation();null!=a.cancelBubble&&(a.cancelBubble=!0);a.preventDefault&&a.preventDefault()},showTooltip:function(a){var b;b=this.tooltip.getComputedTextLength()+16;var c=this.svgElement.parentNode.clientWidth,d=this.svgElement.parentNode.clientHeight;
b=a.x+20+b<c?a.x:c-b-20;a=a.y+60<d?a.y:d-60;this.tooltip.setAttribute("x",b+22);this.tooltip.setAttribute("y",a+47);this.tooltip_bg.setAttribute("x",b+16);this.tooltip_bg.setAttribute("y",a+28);this.tooltip_subBg.setAttribute("x",b+16);this.tooltip_subBg.setAttribute("y",a+28)},setTooltip:function(a,b){if(a){this.tooltip.firstChild.data=a.toString().replace(/&(quot);/g,'"');this.tooltip.setAttribute("display","block");var c=this.tooltip.getComputedTextLength();this.tooltip_bg.setAttribute("width",
c+16);this.tooltip_subBg.setAttribute("width",c+16);"undefined"!==typeof b&&null!=b?(this.tooltip_bg.setAttribute("fill",b),this.tooltip_bg.setAttribute("stroke",b),this.tooltip_bg.setAttribute("fill-opacity","0.5")):(this.tooltip_bg.setAttribute("fill","white"),this.tooltip_bg.setAttribute("stroke","grey"));this.tooltip_bg.setAttribute("height",28);this.tooltip_subBg.setAttribute("height",28);this.tooltip_bg.setAttribute("display","block");this.tooltip_subBg.setAttribute("display","block")}else this.hideTooltip()},
hideTooltip:function(){this.tooltip.setAttribute("display","none");this.tooltip_bg.setAttribute("display","none");this.tooltip_subBg.setAttribute("display","none")},autoLayout:function(){function a(b){function c(a){d.push(a.id);for(var b=0;b<a.proteinLinks.values().length;b++){var e=a.proteinLinks.values()[b];if(!0===e.check()&&(e=e.getOtherEnd(a),-1===d.indexOf(e.id))){c(e);break}}}var d=[];c(function(){for(var a=b.nodes.values(),c=a.length,d=0;d<c;d++)if(2>a[d].countExternalLinks())return a[d];
console.error("missed linear subgraph start");return null}());return d}function b(a){return a*(60+Protein.LABELMAXLENGTH)-30}this.force&&this.force.stop();for(var c=this.svgElement.parentNode.clientWidth,d=this.svgElement.parentNode.clientHeight,f=this,h=this.proteins.values(),l=h.length,g=this.subgraphs.length=0;g<l;g++)h[g].subgraph=null;for(g=0;g<l;g++)h[g].getSubgraph();this.subgraphs.sort(function(a,b){return a.nodes.values().length-b.nodes.values().length});if(1===l){var k=h[0];k.setPosition(c/
2,d/2)}else if(2===l)k=h[0],k.setPosition(c/2,.3*d),k.setAllLineCoordinates(),h=h[1],h.setPosition(c/2,.6*d),h.setAllLineCoordinates();else{for(var m=[],h=[],g=this.subgraphs.length,k=0;k<g;k++){var n=this.subgraphs[k],q=n.nodes.values(),v=q.length,u=!0;if(1===v)u=!0;else{for(var w=!1,t=0;t<v;t++)if(2<q[t].countExternalLinks()){u=!1;break}else 2>q[t].countExternalLinks()&&(w=!0);w||(u=!1)}!0===u?m.push(n):h.push(n)}var w=u=n=0,z=-1;if(0<m.length)for(n++,k=0;k<m.length;k++)for(q=m[k].nodes.keys(),
v=q.length,2<v&&(q=a(m[k])),t=0;t<v;t++){var g=this.proteins.get(q[t]),B,A;!0===g.isParked?(w++,B=b(z),A=30*w,A>d&&(z--,w=1,B=b(z),A=30*w)):(u++,(60>l||1<v)&&u++,B=b(n),A=30*u,30*(u+2*(v-1-t))+this.maxBlobRadius>d&&(n++,u=1,60>l&&u++,B=b(n),A=30*u));g.setPosition(B,A);g.setAllLineCoordinates()}this.layoutXOffset=b(n+.5);if("undefined"===typeof this.force||null==this.force){l={NAME:"ALL",children:[]};for(k=0;k<h.length;k++)for(q=h[k].nodes.values(),v=q.length,t=0;t<v;t++)g=this.proteins.get(q[t].id),
n={},n.id=g.id,n.x=g.x-this.layoutXOffset,n.y=g.y,n.px=g.x-this.layoutXOffset,n.py=g.y,n.linkCount=g.proteinLinks.keys().length,n.size=30,l.children.push(n);q=d3.layout.pack().size([c-this.layoutXOffset,d]).value(function(a){return a.size}).sort(function(a,b){return b.linkCount-a.linkCount}).nodes(l);v=q.length;for(t=1;t<v;t++)l=q[t],k=this.proteins.get(l.id),l=Protein.rotatePointAboutPoint([l.x,l.y],[c-this.layoutXOffset/2,d/2],90),k.setPosition(l[0]+this.layoutXOffset,l[1]),k.setAllLineCoordinates(!1)}m=
c-this.layoutXOffset;200>m&&(m=c);l={nodes:[],links:[]};c={};for(k=u=0;k<h.length;k++)for(q=h[k].nodes.values(),v=q.length,t=0;t<v;t++)g=this.proteins.get(q[t].id),c[g.id]=u,u++,n={},n.id=g.id,n.x=g.x-this.layoutXOffset,n.y=g.y,n.px=g.x-this.layoutXOffset,n.py=g.y,l.nodes.push(n);for(k=0;k<h.length;k++)for(q=h[k].links.values(),t=q.length,g=0;g<t;g++)if(n=q[g],u=n.fromProtein,w=n.toProtein)u=c[u.id],w=c[w.id],u!==w&&("undefined"!==typeof u&&"undefined"!==typeof w?(z={},z.source=u,z.target=w,z.id=
n.id,l.links.push(z)):alert("NOT RIGHT"));h=Math.sqrt(l.nodes.length/(m*d));this.force=d3.layout.force().nodes(l.nodes).links(l.links).gravity(85*h).linkDistance(60).charge(-30/h).size([m,d]);v=this.force.nodes().length;this.force.links();this.force.on("tick",function(a){a=f.force.nodes();for(var b=0;b<v;b++){var c=a[b],d=f.proteins.get(c.id);d.setPosition(c.x+f.layoutXOffset,c.y);d.setAllLineCoordinates()}});this.force.start()}},downloadSVG:function(){},hideView:function(){a.CLMSUI.vent.trigger(this.displayEventName,
!1)},setVisible:function(a){console.log("event display in distogram",a);d3.select(this.el).style("display",a?"block":"none");a&&this.relayout().render()},render:function(){console.log("re rendering cross-link viewer");this.checkLinks();return this},remove:function(){this.chart=this.chart.destroy();d3.select(this.el).selectAll(".dynDiv_resizeDiv_tl, .dynDiv_resizeDiv_tr, .dynDiv_resizeDiv_bl, .dynDiv_resizeDiv_br").on(".drag",null);Backbone.View.prototype.remove.call(this)}})})(this);function Match(a,e,b,c,d,f,h,l,g,k,m,n,q,v,u,w){function t(a){a=a.toString().trim();if("-"!==a&&"n/a"!==a){B.lastIndex=0;a=a.replace(B,"");A.lastIndex=0;a=a.split(A);for(var b=a.length,c=0;c<b;c++)a[c]=a[c].trim()}else a=null;return a}function z(a){if(a)if(a=a.toString().trim(),""!==a&&"-"!==a&&"n/a"!==a){B.lastIndex=0;a=a.toString().replace(B,"");A.lastIndex=0;a=a.split(A);for(var b=a.length,c=0;c<b;c++){var d=parseInt(a[c]);isNaN(d)?console.debug("Absurd non-numerical position. Match id:"+this.id+
". So-called 'position':"+a[c]):a[c]=d}}else a=null;else a=null;return a}this.controller=a;this.id=e.toString().trim();this.residueLinks=[];this.group=n;this.controller.groups.add(this.group);this.runName=u;this.scanNumber=w;"undefined"!=typeof m&&m&&(m=parseFloat(m),isNaN(m)||(this.score=m,null==this.controller.scores&&(this.controller.scores={min:this.score,max:this.score}),this.score>this.controller.scores.max?this.controller.scores.max=this.score:this.score<this.controller.scores.min&&(this.controller.scores.min=
this.score)));"undefined"!=typeof q&&q&&(q=q.trim(),""!==q&&(this.autovalidated="t"==q||"true"==q||!0===q?!0:!1,this.controller.autoValidatedFound=!0));"undefined"!=typeof v&&v&&(v=v.trim(),""!==v&&(this.validated=v,this.controller.manualValidatedFound=!0));var B=/(['"])/g,A=/[;,]/g;a=/[^A-Z]/g;b=t(b);h=t(h);this.pepSeq1raw=d;this.pepSeq2raw=g;d?(d=d.trim())?(a.lastindex=0,this.pepSeq1=d.replace(a,"")):this.pepSeq1=null:this.pepSeq1=null;g?(g=g.trim())?(a.lastindex=0,this.pepSeq2=g.replace(a,"")):
this.pepSeq2=null:this.pepSeq2=null;c=z(c);l=z(l);f=z(f);k=z(k);1==c.length&&1==l.length&&(this.controller.unambigLinkFound=!0);this.type=null===h&&null===l&&null===k?0:null===h?1:2;var p,y,r,x;if(b){if(0===this.type)if(null!==c)for(d=0;d<c.length;d++)p=d,p>=b.length&&(p=b.length-1),p=b[p],r=c[d],r+=f[0]-1,this.associateWithLink(p,null,r,null,c[d],this.pepSeq1.length,null,null);else for(d=0;d<f.length;d++)p=d,p>=b.length&&(p=b.length-1),p=b[p],r=f[d],this.associateWithLink(p,null,r,null,null,null,
null,null);else if(1===this.type)if(null!==c)for(d=0;d<c.length;d++)p=d,p>=b.length&&(p=b.length-1),p=b[p],r=c[d],x=l?l[d]:c[d],null!==f&&(r+=f[0]-1),null!==k&&(x+=k[0]-1),this.associateWithLink(p,null,r,x,c[d],this.pepSeq1.length,null,null);else for(d=0;d<f.length;d++)p=d,p>=b.length&&(p=b.length-1),p=b[p],r=f[0],x=k[0],this.associateWithLink(p,null,r,x,null,null,null,null);else if(null!==c){if(null!==c)for(d=0;d<c.length;d++)for(g=0;g<l.length;g++)p=d,y=g,p>=b.length&&(p=b.length-1),y>=h.length&&
(y=h.length-1),p=b[p],y=h[y],r=c[d]-0,x=l[g]-0,null!==f&&(r+=f-1),null!==k&&(x+=k-1),this.associateWithLink(p,y,r,x,c[d]-0,this.pepSeq1.length,l[g],this.pepSeq2.length)}else for(d=0;d<f.length;d++)for(g=0;g<k.length;g++)p=d,y=g,p>=b.length&&(p=b.length-1),y>=h.length&&(y=h.length-1),p=b[p],y=h[y],r=f[d]-0,x=k[g]-0,this.associateWithLink(p,y,r,x,null,null,null,null);this.hd=!1;this.overlap=[];p===y&&(this.pepSeq1&&this.pepSeq2?(p=c[0],y=l[0],x=p+(this.pepSeq1.length-1),r=y+(this.pepSeq2.length-1),
p>=y&&p<=r?(this.hd=!0,this.overlap[0]=p-1,this.overlap[1]=x<r?x:r):y>=p&&y<=x&&(this.hd=!0,this.overlap[0]=y-1,this.overlap[1]=r<x?r:x)):r===x&&(this.hd=!0,this.overlap[0]=r-1,this.overlap[1]=x));this.controller.matches.push(this);this.protein1=b;this.pepPos1=c;this.linkPos1=f;this.protein2=h;this.pepPos2=l;this.linkPos2=k}}
Match.prototype.associateWithLink=function(a,e,b,c,d,f,h,l){var g,k,m;null===e?(k=this.controller.proteins.get(a),null===c?(g=""+a+"-null",m=null):(g=""+a+"-"+a,m=k)):a<=e?(g=""+a+"-"+e,k=this.controller.proteins.get(a),m=null!==e?this.controller.proteins.get(e):null):(g=""+e+"-"+a,k=this.controller.proteins.get(e),m=this.controller.proteins.get(a));var n=this.controller.proteinLinks.get(g);void 0===n&&(void 0!==k&&void 0!==m||alert("Something has gone wrong; a link has been added before a protein it links to. "+
a+"-"+e),n=new ProteinLink(g,k,m,this.controller),this.controller.proteinLinks.set(g,n),k.addLink(n),null!==m&&m.addLink(n));g=!1;a===e||null===e?b-0<c-0||null===c?m=b+"-"+c:(m=c+"-"+b,g=!0):a<e?m=b+"-"+c:(m=c+"-"+b,g=!0);k=n.residueLinks.get(m);void 0===k&&(k=a===e?b-0<c-0||"n/a"===c?new ResidueLink(m,n,b,c,this.controller):new ResidueLink(m,n,c,b,this.controller):a==n.fromProtein.id?new ResidueLink(m,n,b,c,this.controller):new ResidueLink(m,n,c,b,this.controller),n.residueLinks.set(m,k),1<this.controller.proteins.size()&&
(a=n.residueLinks.size(),a>ProteinLink.maxNoResidueLinks&&(ProteinLink.maxNoResidueLinks=a)));if("undefined"===typeof k.matches||null==k.matches)k.matches=[];!1===g?k.matches.push([this,d,f,h,l]):k.matches.push([this,h,l,d,f]);this.residueLinks.push(k)};
Match.prototype.meetsFilterCriteria=function(){return this.isAmbig()&&!1===this.controller.ambigShown?!1:"function"==typeof this.controller.filter?this.controller.filter(this):"undefined"!==typeof this.controller.cutOff&&"undefined"!==typeof this.score?this.score>=this.controller.cutOff?!0:!1:!0};Match.prototype.isAmbig=function(){return 1<this.residueLinks.length?!0:!1};xiNET.Link=function(){};xiNET.Link.prototype.mouseDown=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;this.controller.clearSelection();this.setSelected(!0);a=this.controller.getEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};
xiNET.Link.prototype.mouseOver=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!0,!0);this.controller.setTooltip(this.tooltip);return!1};xiNET.Link.prototype.mouseOut=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!1,!0);this.controller.hideTooltip();return!1};
xiNET.Link.prototype.touchStart=function(a){this.controller.preventDefaultsAndStopPropagation(a);void 0!==this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;this.controller.clearSelection();this.setSelected(!0);a=this.controller.getTouchEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};Protein.STICKHEIGHT=20;Protein.MAXSIZE=100;Protein.UNITS_PER_RESIDUE=1;Protein.LABELMAXLENGTH=60;Protein.labelY=-5;Protein.domainColours=d3.scale.ordinal().range(colorbrewer.Paired[5]);Protein.transitionTime=650;
function Protein(a,e,b,c){this.id=a;this.controller=e;this.accession=b;this.name=c;this.name||(this.name=b);this.tooltip=this.name+" ["+this.accession+"]";this.proteinLinks=d3.map();this.selfLink=null;this.y=this.x=40;this.previousRotation=this.rotation=0;this.stickZoom=1;this.form=0;this.isSelected=this.isFlipped=this.isParked=!1;this.customAnnotations=null;this.lowerRotator=new Rotator(this,0,this.controller);this.upperRotator=new Rotator(this,1,this.controller);this.lowerGroup=document.createElementNS(xiNET.svgns,
"g");this.lowerGroup.setAttribute("class","protein lowerGroup");this.highlight=document.createElementNS(xiNET.svgns,"rect");void 0!==xiNET.highlightColour&&this.highlight.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlight.setAttribute("stroke-width","5");this.highlight.setAttribute("fill","none");this.lowerGroup.appendChild(this.highlight);this.rectDomains=document.createElementNS(xiNET.svgns,"g");this.rectDomains.setAttribute("opacity","0");this.lowerGroup.appendChild(this.rectDomains);
this.peptides=document.createElementNS(xiNET.svgns,"g");this.lowerGroup.appendChild(this.peptides);this.upperGroup=document.createElementNS(xiNET.svgns,"g");this.upperGroup.setAttribute("class","protein upperGroup");this.selfLinksHighlights=document.createElementNS(xiNET.svgns,"g");this.selfLinks=document.createElementNS(xiNET.svgns,"g");this.upperGroup.appendChild(this.selfLinksHighlights);this.upperGroup.appendChild(this.selfLinks);this.labelSVG=document.createElementNS(xiNET.svgns,"text");this.labelSVG.setAttribute("text-anchor",
"end");this.labelSVG.setAttribute("fill",this.isDecoy()?"#FB8072":"black");this.labelSVG.setAttribute("x",0);this.labelSVG.setAttribute("y",10);this.labelSVG.setAttribute("class","protein xlv_text proteinLabel");this.labelSVG.setAttribute("font-family","Arial");this.labelSVG.setAttribute("font-size","16");this.labelText=this.name?this.name:null!=this.accession&""!==this.accession?this.accession:this.id;25<this.labelText.length&&(this.labelText=this.labelText.substr(0,16)+"...");this.labelTextNode=
document.createTextNode(this.labelText);this.labelSVG.appendChild(this.labelTextNode);d3.select(this.labelSVG).attr("transform","translate( -5 "+Protein.labelY+") rotate(0) scale(1, 1)");this.upperGroup.appendChild(this.labelSVG);this.ticks=document.createElementNS(xiNET.svgns,"g");this.outline=document.createElementNS(xiNET.svgns,"rect");this.outline.setAttribute("stroke","black");this.outline.setAttribute("stroke-width","1");this.outline.setAttribute("fill","#EEEEEE");this.upperGroup.appendChild(this.outline);
this.upperGroup.appendChild(this.ticks);this.circDomains=document.createElementNS(xiNET.svgns,"g");this.circDomains.setAttribute("opacity",1);this.upperGroup.appendChild(this.circDomains);this.scaleLabels=[];var d=this;this.upperGroup.onmousedown=function(a){d.mouseDown(a)};this.upperGroup.onmouseover=function(a){d.mouseOver(a)};this.upperGroup.onmouseout=function(a){d.mouseOut(a)};this.upperGroup.ontouchstart=function(a){d.touchStart(a)};this.busy=this.isSelected=!1;this.showHighlight(!1)}
Protein.prototype.setSequence=function(a){/\d/.test(a)&&(this.labeling="",-1!==a.indexOf("K4")&&(this.labeling+="K4"),-1!==a.indexOf("K6")&&(this.labeling+="K6"),-1!==a.indexOf("K8")&&(this.labeling+="K8"),-1!==a.indexOf("K10")&&(this.labeling+="R4"),-1!==a.indexOf("R6")&&(this.labeling+="R6"),-1!==a.indexOf("R8")&&(this.labeling+="R8"),-1!==a.indexOf("R10")&&(this.labeling+="R10"));"undefined"!==typeof this.labeling&&(this.labelSVG.innerHTML="["+this.labeling+"] "+this.labelSVG.innerHTML);this.sequence=
a.replace(/[^A-Z]/g,"");this.size=this.sequence.length};Protein.prototype.init=function(){this.setForm(this.form);this.selfLink&&this.selfLink.initSelfLinkSVG();this.setAllLineCoordinates()};Protein.prototype.mouseDown=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;a=this.controller.getEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};
Protein.prototype.touchStart=function(a){this.controller.preventDefaultsAndStopPropagation(a);void 0!==this.controller.force&&this.controller.force.stop();this.controller.dragElement=this;a=this.controller.getTouchEventPoint(a);this.controller.dragStart=this.controller.mouseToSVG(a.x,a.y);return!1};Protein.prototype.mouseOver=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!0);this.controller.setTooltip(this.tooltip);return!1};
Protein.prototype.mouseOut=function(a){this.controller.preventDefaultsAndStopPropagation(a);this.showHighlight(!1);this.controller.hideTooltip();return!1};Protein.prototype.getBlobRadius=function(){return Math.sqrt(this.size/Math.PI)};Protein.prototype.isDecoy=function(){return this.name?-1===this.name.indexOf("DECOY_")&&"REV"!==this.name?!1:!0:!1};
Protein.prototype.toJSON=function(){return{id:this.id,x:this.x,y:this.y,rot:this.rotation,form:this.form,stickZoom:this.stickZoom,parked:this.isParked,flipped:this.isFlipped}};Protein.prototype.addLink=function(a){this.proteinLinks.has(a.id)||this.proteinLinks.set(a.id,a);!0===a.selfLink()&&(this.selfLink=a,this.size&&this.selfLink.initSelfLinkSVG());null===a.toProtein&&(this.linkerModifications=a)};
Protein.prototype.showHighlight=function(a){!0===a?(this.highlight.setAttribute("stroke",xiNET.highlightColour.toRGB()),this.highlight.setAttribute("stroke-opacity","1")):(0==this.isSelected&&this.highlight.setAttribute("stroke-opacity","0"),this.highlight.setAttribute("stroke",xiNET.selectedColour.toRGB()))};
Protein.prototype.setRotation=function(a){this.rotation=a%360;0>this.rotation&&(this.rotation+=360);this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")");this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")");var e=this.controller.svgElement;a=this.labelSVG.getAttribute("transform");var b=d3.transform(a);a=this.scaleLabels.length;if(90<=this.rotation&&
270>this.rotation){if(b=e.createSVGMatrix().translate(Math.abs(b.translate[0]),-Protein.labelY).rotate(180,0,0),this.labelSVG.transform.baseVal.initialize(e.createSVGTransformFromMatrix(b)),1===this.form){for(e=0;e<a;e++)this.scaleLabels[e].setAttribute("transform","scale(-1,1)");this.ticks.setAttribute("transform","scale(1,-1)")}}else if(b=e.createSVGMatrix().translate(-Math.abs(b.translate[0]),Protein.labelY),this.labelSVG.transform.baseVal.initialize(e.createSVGTransformFromMatrix(b)),1===this.form){for(e=
0;e<a;e++)this.scaleLabels[e].setAttribute("transform","scale(1,1)");this.ticks.setAttribute("transform","scale(1,1)")}};
Protein.prototype.setPosition=function(a,e){this.x=a;this.y=e;1===this.form&&!1===this.isParked?(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")"),this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") rotate("+this.rotation+")")):(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+") "),this.lowerGroup.setAttribute("transform",
"translate("+this.x+" "+this.y+") scale("+this.controller.z+") "),null!=this.selfLink&&("undefined"!==typeof this.selfLink.fatLine&&this.selfLink.fatLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")"),this.selfLink.line.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")"),this.selfLink.highlightLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.controller.z+")")))};Protein.rotOffset=17.5;
Protein.minXDist=30;Protein.prototype.switchStickScale=function(a){this.isParked&&this.toggleParked();if(0===this.form)this.toStick();else if(8<Protein.UNITS_PER_RESIDUE*this.stickZoom)this.stickZoom=.5,this.setPosition(a.x,a.y);else{this.stickZoom*=3;var e=this.x-a.x;a=this.y-a.y;if(0===this.rotation||180===this.rotation)a=0;this.setPosition(this.x+2*e,this.y+2*a)}this.scale();this.setAllLineCoordinates()};
Protein.prototype.scale=function(){var a=this.size*Protein.UNITS_PER_RESIDUE*this.stickZoom;if(1===this.form){var e=d3.transform(this.labelSVG.getAttribute("transform")),e=this.controller.svgElement.createSVGMatrix().rotate(e.rotate).translate(-(this.size/2*Protein.UNITS_PER_RESIDUE*this.stickZoom+10),Protein.labelY);this.labelSVG.transform.baseVal.initialize(this.controller.svgElement.createSVGTransformFromMatrix(e));if(this.annotations)for(var e=this.annotations.length,b=0;b<e;b++){var c=this.annotations[b];
c.pieSlice.setAttribute("d",this.getAnnotationRectPath(c));c.colouredRect.setAttribute("d",this.getAnnotationRectPath(c))}d3.select(this.peptides).attr("transform","scale("+this.stickZoom+", 1)");d3.select(this.outline).attr("width",a).attr("x",this.getResXwithStickZoom(.5));d3.select(this.highlight).attr("width",a+5).attr("x",this.getResXwithStickZoom(.5)-2.5);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-Protein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform",
"translate("+(this.getResXwithStickZoom(this.size-0+.5)+Protein.rotOffset)+" 0)");if(null!=this.selfLink)for(e=this.selfLink.residueLinks.values(),b=e.length,c=0;c<b;c++){var d=e[c];d.shown&&(a=this.getResidueLinkPath(d),d3.select(d.line).attr("d",a),d3.select(d.highlightLine).attr("d",a))}if(null!=this.linkerModifications)for(e=this.linkerModifications.residueLinks.values(),b=e.length,c=0;c<b;c++)d=e[c],d.shown&&(a=this.getResidueLinkPath(d),d3.select(d.line).attr("d",a),d3.select(d.highlightLine).attr("d",
a));this.setScaleGroup();this.setRotation(this.rotation)}};
Protein.prototype.setScaleGroup=function(){function a(a,b,c){var d=document.createElementNS(xiNET.svgns,"g");d.setAttribute("transform","translate("+c+" 0)");c=document.createElementNS(xiNET.svgns,"text");c.setAttribute("class","protein xlv_text proteinLabel");c.setAttribute("font-family","'Courier New', monospace");c.setAttribute("font-size","14");c.setAttribute("text-anchor","middle");c.setAttribute("x",0);c.setAttribute("y",Protein.STICKHEIGHT+4);c.appendChild(document.createTextNode(b));d.appendChild(c);
a.scaleLabels.push(c);a.ticks.appendChild(d)}function e(a,b){var c=document.createElementNS(xiNET.svgns,"line");c.setAttribute("x1",b);c.setAttribute("y1",5);c.setAttribute("x2",b);c.setAttribute("y2",10);c.setAttribute("stroke","black");a.ticks.appendChild(c)}d3.select(this.ticks).selectAll("*").remove();this.scaleLabels=[];for(var b=Protein.UNITS_PER_RESIDUE*this.stickZoom,c=-1,d=this.getResXwithStickZoom(this.size),f=1;f<=this.size;f++){if(1===f||0===f%100&&200*b>Protein.minXDist||0===f%10&&20*
b>Protein.minXDist){var h=this.getResXwithStickZoom(f);(8<=b||1!==f)&&e(this,h);c=(c+1)%2;0===c&&h+Protein.minXDist<d&&a(this,f,h)}if(8<=b&&this.sequence){h=document.createElementNS(xiNET.svgns,"g");h.setAttribute("transform","translate("+this.getResXwithStickZoom(f)+" 0)");var l=document.createElementNS(xiNET.svgns,"text");l.setAttribute("font-family","'Courier New', monospace");l.setAttribute("font-size","10px");l.setAttribute("text-anchor","middle");l.setAttribute("x",0);l.setAttribute("y",3);
l.appendChild(document.createTextNode(this.sequence[f-1]));h.appendChild(l);this.scaleLabels.push(l);this.ticks.appendChild(h)}}a(this,this.size,d);8<b&&e(this,d)};Protein.prototype.toggleFlipped=function(){(this.isFlipped=!this.isFlipped)?(this.selfLinks.setAttribute("transform","scale (1 -1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 -1)")):(this.selfLinks.setAttribute("transform","scale (1 1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 1)"))};
Protein.prototype.setParked=function(a,e){this.isParked=a;if(!0!==this.busy)if(0==a)0===this.form?(d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").duration(Protein.transitionTime),this.checkLinks(),d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(Protein.transitionTime)):this.toStick(),this.scale(),this.setAllLineCoordinates();else if(1==a){this.isParked=!0;for(var b=this.proteinLinks.values().length,
c=0;c<b;c++){var d=this.proteinLinks.values()[c];d.hide();for(var d=d.residueLinks.values(),f=d.length,h=0;h<f;h++)d[h].hide()}1===this.form?(this.toCircle(e),b=this.getBlobRadius(),d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill-opacity",1).attr("fill","#EEEEEE").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(Protein.transitionTime),d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime)):
(d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill","#EEEEEE").duration(Protein.transitionTime),d3.select(this.circDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime))}};
Protein.prototype.setForm=function(a,e){if(!0!==this.busy)if(this.isParked)this.setParked(!1);else if(1==a)this.toStick();else{this.toCircle(e);var b=this.getBlobRadius();d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(Protein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(Protein.transitionTime);
d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(Protein.transitionTime)}};
Protein.prototype.toCircle=function(a){function e(a){var b=d3.transform(k.labelSVG.getAttribute("transform")),b=k.controller.svgElement.createSVGMatrix().rotate(b.rotate).translate(h(w(a)),Protein.labelY);k.labelSVG.transform.baseVal.initialize(k.controller.svgElement.createSVGTransformFromMatrix(b));null!==l&&k.setPosition(l(w(a)),g(w(a)));b=d(w(a));k.stickZoom=c(w(a));1==k.form&&k.setRotation(b);k.setAllLineCoordinates();if(1===a){a=k.proteinLinks.values();for(var b=a.length,f=0;f<b;f++){var m=
a[f];if(null===m.toProtein||m.getFromProtein()===k&&0===m.getToProtein().form||m.getToProtein()===k&&0===m.getFromProtein().form||m.getToProtein()==m.getFromProtein())for(var m=m.residueLinks.values(),n=m.length,q=0;q<n;q++)m[q].hide()}k.form=0;k.checkLinks();k.stickZoom=v;k.rotation=u;k.busy=!1;return!0}return 1<a?e(1):!1}this.busy=!0;this.removePeptides();this.upperGroup.contains(this.lowerRotator.svg)&&this.upperGroup.removeChild(this.lowerRotator.svg);this.upperGroup.contains(this.upperRotator.svg)&&
this.upperGroup.removeChild(this.upperRotator.svg);var b=this.getBlobRadius(),c=d3.interpolate(this.stickZoom,0),d=d3.interpolate(180<this.rotation?this.rotation-360:this.rotation,0),f=d3.transform(this.labelSVG.getAttribute("transform")).translate[0],h=d3.interpolate(f,-(b+5)),l=null,g=null;"undefined"!==typeof a&&null!==a&&(l=d3.interpolate(this.x,a.x),g=d3.interpolate(this.y,a.y));var k=this;d3.select(this.ticks).transition().attr("opacity",0).duration(Protein.transitionTime/4).each("end",function(){d3.select(this).selectAll("*").remove()});
d3.select(this.highlight).transition().attr("width",2*b+5).attr("height",2*b+5).attr("x",-b-2.5).attr("y",-b-2.5).attr("rx",b+2.5).attr("ry",b+2.5).duration(Protein.transitionTime);if(null!=this.selfLink)for(var b=this.selfLink.residueLinks.values(),f=b.length,m=0;m<f;m++){var n=b[m];n.shown&&(a=d3.select(n.line),a.attr("d",this.getResidueLinkPath(n)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(Protein.transitionTime),a=d3.select(n.highlightLine),a.attr("d",this.getResidueLinkPath(n)),
a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(Protein.transitionTime))}if(null!=this.linkerModifications)for(b=this.linkerModifications.residueLinks.values(),f=b.length,m=0;m<f;m++)a=b[m],a.shown&&(a=d3.select(a.line),a.attr("fill","none"),a.attr("d","M 0,0 L 0,0"));k=this;if(this.annotations){a=this.annotations;for(var q=a.length,b=0;b<q;b++)f=a[b],m=f.colouredRect,d3.select(f.pieSlice).transition().attr("d",this.getAnnotationPieSliceApproximatePath(f)).duration(Protein.transitionTime).each("end",
function(){for(var a=0;a<q;a++){var b=k.annotations[a];this===b.pieSlice&&d3.select(this).attr("d",k.getAnnotationPieSliceArcPath(b))}}),d3.select(m).transition().attr("d",k.getAnnotationPieSliceApproximatePath(f)).duration(Protein.transitionTime)}var v=this.stickZoom,u=this.rotation,w=d3.ease("cubic-in-out");d3.timer(function(a){return e(a/Protein.transitionTime)})};Protein.prototype.getX=function(){return this.x};Protein.prototype.getY=function(){return this.y};
Protein.prototype.toStick=function(){function a(b){var c=d3.transform(n.labelSVG.getAttribute("transform")),c=n.controller.svgElement.createSVGMatrix().rotate(c.rotate).translate(l(q(b)),Protein.labelY);n.labelSVG.transform.baseVal.initialize(n.controller.svgElement.createSVGTransformFromMatrix(c));c=h(q(b));n.setRotation(c);c=d(q(b));d3.select(n.outline).attr("width",c).attr("x",-(c/2)+.5*Protein.UNITS_PER_RESIDUE*n.stickZoom);n.stickZoom=f(q(b));n.setAllLineCoordinates();return 1===b?(n.busy=!1,
!0):1<b?a(1):!1}this.busy=!0;this.form=1;this.upperGroup.appendChild(this.lowerRotator.svg);this.upperGroup.appendChild(this.upperRotator.svg);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-Protein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.size-0+.5)+Protein.rotOffset)+" 0)");for(var e=this.proteinLinks.values().length,b=0;b<e;b++){var c=this.proteinLinks.values()[b];c.shown&&c.hide()}var e=
this.size*Protein.UNITS_PER_RESIDUE*this.stickZoom,b=this.getBlobRadius(),d=d3.interpolate(2*b,e),f=d3.interpolate(0,this.stickZoom),h=d3.interpolate(0,180<this.rotation?this.rotation-360:this.rotation),l=d3.interpolate(-(b+5),-(this.size/2*Protein.UNITS_PER_RESIDUE*this.stickZoom+10)),b=this.stickZoom;this.stickZoom=0;this.checkLinks();this.stickZoom=b;d3.select(this.circDomains).transition().attr("opacity",0).duration(Protein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",
1).duration(Protein.transitionTime);d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",0).attr("fill","#FFFFFF").attr("height",Protein.STICKHEIGHT).attr("y",-Protein.STICKHEIGHT/2).attr("rx",0).attr("ry",0).duration(Protein.transitionTime);d3.select(this.highlight).transition().attr("width",e+5).attr("height",Protein.STICKHEIGHT+5).attr("x",this.getResXwithStickZoom(.5)-2.5).attr("y",-Protein.STICKHEIGHT/2-2.5).attr("rx",0).attr("ry",0).duration(Protein.transitionTime);
if(null!=this.selfLink)for(e=this.selfLink.residueLinks.values(),b=e.length,c=0;c<b;c++){var g=e[c];g.shown&&(d3.select(g.line).attr("d",this.getAggregateSelfLinkPath()),d3.select(g.line).transition().attr("d",this.getResidueLinkPath(g)).duration(Protein.transitionTime),d3.select(g.highlightLine).attr("d",this.getAggregateSelfLinkPath()),d3.select(g.highlightLine).transition().attr("d",this.getResidueLinkPath(g)).duration(Protein.transitionTime))}if(null!=this.linkerModifications)for(e=this.linkerModifications.residueLinks.values(),
b=e.length,c=0;c<b;c++)if(g=e[c],g.shown){var k=this.getResidueLinkPath(g);d3.select(g.line).attr("d","M 0,0 L 0,0 L 0,0 L 0,0");d3.select(g.line).transition().attr("d",k).duration(Protein.transitionTime);d3.select(g.highlightLine).attr("d","M 0,0 L 0,0");d3.select(g.highlightLine).transition().attr("d",k).duration(Protein.transitionTime)}if(this.annotations)for(e=this.annotations,b=e.length,c=0;c<b;c++){var g=e[c],k=g.pieSlice,m=g.colouredRect;k.setAttribute("d",this.getAnnotationPieSliceApproximatePath(g));
d3.select(k).transition().attr("d",this.getAnnotationRectPath(g)).duration(Protein.transitionTime);d3.select(m).transition().attr("d",this.getAnnotationRectPath(g)).duration(Protein.transitionTime)}var n=this,q=d3.ease("cubic-in-out");d3.timer(function(b){return a(b/Protein.transitionTime)});d3.select(this.ticks).attr("opacity",0);this.setScaleGroup();d3.select(this.ticks).transition().attr("opacity",1).delay(.8*Protein.transitionTime).duration(Protein.transitionTime/2)};
Protein.prototype.getAggregateSelfLinkPath=function(){var a=this.getBlobRadius()+7,e=Protein.trig(a,70),b=Protein.trig(a,20),c=Protein.trig(a,85),d=Protein.trig(a,5);return"M 0,0 Q "+c.x+","+-c.y+" "+e.x+","+-e.y+" A "+a+" "+a+" 0 0 1 "+b.x+","+-b.y+" Q "+d.x+","+-d.y+" 0,0"};
Protein.prototype.getResidueLinkPath=function(a){var e=this.getResXwithStickZoom(a.fromResidue),b=0;8<=Protein.UNITS_PER_RESIDUE*this.stickZoom&&(b=-5);if(isNaN(parseFloat(a.toResidue))){!1===a.ambig&&a.line.setAttribute("fill",xiNET.defaultSelfLinkColour.toRGB());var c=[e,26],d=[e,18],f=Protein.rotatePointAboutPoint(c,d,60);return"M "+e+","+-1*b+" L "+c[0]+","+c[1]+" L "+f[0]+","+f[1]+" L "+d[0]+","+d[1]}var c=this.getResXwithStickZoom(a.toResidue),h,l,f=Math.abs(c-e)/2,d=-(Protein.STICKHEIGHT/2+
3);15>f&&(d=-28+f);var g=[e,b],k=[c,b];!0===a.intraMolecular?(h=e+(c-e)/2,b=[h,d-f],l=[h,d-f],a=[h,d-f],h=[h,d-f]):a.hd?(h=e+(c-e)/2,b=[h,d-f],l=[h,d-f],a=Protein.rotatePointAboutPoint([e,d-f],g,-20),h=Protein.rotatePointAboutPoint([c,d-f],k,20)):(a=[e,d],h=[c,b],b=[e,d],l=[c,d]);return" M "+g[0]+","+g[1]+" Q "+a[0]+","+a[1]+" "+b[0]+","+b[1]+" A "+f+","+f+"  0 0 1 "+l[0]+","+l[1]+" Q "+h[0]+","+h[1]+" "+k[0]+","+k[1]};
Protein.prototype.showPeptides=function(a){if(1===this.form)for(var e=-Protein.STICKHEIGHT/2,b=a.length,c=Protein.STICKHEIGHT/b,d=0;d<b;d++){var f=a[d],h=document.createElementNS(xiNET.svgns,"rect");h.setAttribute("class","protein");var l=f[1];if(0<l){var g=(f[0]+.5-this.size/2)*Protein.UNITS_PER_RESIDUE,l=l*Protein.UNITS_PER_RESIDUE;h.setAttribute("x",g);h.setAttribute("y",e);h.setAttribute("width",l);h.setAttribute("height",c);h.setAttribute("fill",xiNET.highlightColour.toRGB());this.peptides.appendChild(h)}f[2]&&
(h=document.createElementNS(xiNET.svgns,"rect"),h.setAttribute("class","protein"),g=(f[2]+.5-this.size/2)*Protein.UNITS_PER_RESIDUE,l=(f[3]-f[2])*Protein.UNITS_PER_RESIDUE,h.setAttribute("x",g),h.setAttribute("y",e),h.setAttribute("width",l),h.setAttribute("height",c),h.setAttribute("fill",xiNET.homodimerLinkColour.toRGB()),h.setAttribute("fill-opacity","0.5"),this.peptides.appendChild(h));e+=c}};Protein.prototype.removePeptides=function(){d3.select(this.peptides).selectAll("*").remove()};
Protein.prototype.getResXwithStickZoom=function(a){return(a-this.size/2)*Protein.UNITS_PER_RESIDUE*this.stickZoom};Protein.rotatePointAboutPoint=function(a,e,b){b=b/360*Math.PI*2;return[Math.cos(b)*(a[0]-e[0])-Math.sin(b)*(a[1]-e[1])+e[0],Math.sin(b)*(a[0]-e[0])+Math.cos(b)*(a[1]-e[1])+e[1]]};Protein.prototype.checkLinks=function(){for(var a=this.proteinLinks.values(),e=a.length,b=0;b<e;b++)a[b].check()};
Protein.prototype.setAllLineCoordinates=function(){for(var a=this.proteinLinks.values(),e=a.length,b=0;b<e;b++){var c=a[b];if(null!==c.getToProtein()&&0===c.getFromProtein().form&&0===c.getToProtein().form)c.setLineCoordinates(this);else for(var c=c.residueLinks.values(),d=c.length,f=0;f<d;f++){var h=c[f];h.setLineCoordinates(this);var l=h.proteinLink.getOtherEnd(this);l&&1===l.form&&8<l.stickZoom*Protein.UNITS_PER_RESIDUE&&h.setLineCoordinates(l)}}};
Protein.prototype.countExternalLinks=function(){if(this.isParked)return 0;for(var a=0,e=this.proteinLinks.keys().length,b=0;b<e;b++){var c=this.proteinLinks.values()[b];c.selfLink()||!0===c.check()&&a++}return a};Protein.prototype.getSubgraph=function(a){null==this.subgraph&&(a={nodes:d3.map(),links:d3.map()},a.nodes.set(this.id,this),!1===this.isParked&&(this.subgraph=this.addConnectedNodes(a)),this.controller.subgraphs.push(a));return this.subgraph};
Protein.prototype.addConnectedNodes=function(a){for(var e=this.proteinLinks.values(),b=e.length,c=0;c<b;c++){var d=e[c];d.fromProtein===d.toProtein||!0!==d.check()||a.links.has(d.id)||(a.links.set(d.id,d),d=d.getFromProtein()===this?d.getToProtein():d.getFromProtein(),null===d||a.nodes.has(d.id)||(a.nodes.set(d.id,d),d.subgraph=a,d.addConnectedNodes(a)))}return a};
Protein.prototype.clearPositionalFeatures=function(a){this.annotations=[];this.circDomains&&d3.select(this.circDomains).selectAll("*").remove();this.rectDomains&&d3.select(this.rectDomains).selectAll("*").remove()};
Protein.prototype.setPositionalFeatures=function(a){this.clearPositionalFeatures();if(a){a.sort(function(a,b){return b.end-b.start-(a.end-a.start)});this.annotations=a;for(var e=0;e<a.length;e++){var b=a[e];b.start-=0;b.end-=0;b.pieSlice=document.createElementNS(xiNET.svgns,"path");b.colouredRect=document.createElementNS(xiNET.svgns,"path");0===this.form?(b.pieSlice.setAttribute("d",this.getAnnotationPieSliceArcPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationPieSliceApproximatePath(b))):
(b.pieSlice.setAttribute("d",this.getAnnotationRectPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationRectPath(b)));b.pieSlice.setAttribute("stroke-width",1);b.pieSlice.setAttribute("fill-opacity","0.5");b.colouredRect.setAttribute("stroke-width",1);b.colouredRect.setAttribute("fill-opacity","0.5");b.pieSlice.name=b.name+" ["+b.start+" - "+b.end+"]";var c=this.controller,d=this;b.pieSlice.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;
c.preventDefaultsAndStopPropagation(a);c.setTooltip(b.name,b.getAttribute("fill"));d.showHighlight(!0)};b.colouredRect.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;c.preventDefaultsAndStopPropagation(a);c.setTooltip(b.name,b.getAttribute("fill"));d.showHighlight(!0)};this.circDomains.appendChild(b.pieSlice);this.rectDomains.appendChild(b.colouredRect)}}};Protein.trig=function(a,e){var b=e/360*Math.PI*2;return{x:a*Math.cos(b),y:a*Math.sin(b)}};
Protein.stepsInArc=5;Protein.prototype.getAnnotationPieSliceArcPath=function(a){var e=(a.start-1)/this.size*360;a=a.end/this.size*360;var b=this.getBlobRadius()-2,c=Protein.trig(b,e-90),d=Protein.trig(b,a-90),f=0;if(180<a-e||a==e)f=1;return"M0,0 L"+c.x+","+c.y+" A"+b+","+b+" 0 "+f+" 1 "+d.x+","+d.y+" Z"};
Protein.prototype.getAnnotationPieSliceApproximatePath=function(a){var e=(a.start-1)/this.size*360;a=a.end/this.size*360;var b=this.getBlobRadius()-2;Protein.trig(b,e-90);Protein.trig(b,a-90);for(var c="M 0,0",d=0;d<=Protein.stepsInArc;d++)var f=Protein.trig(b,e+d/5*(a-e)-90),c=c+(" L "+f.x+","+f.y);return c+=" L 0,0  Z"};
Protein.prototype.getAnnotationRectPath=function(a){var e=Protein.STICKHEIGHT/2,b=-Protein.STICKHEIGHT/2,c=this.getResXwithStickZoom(a.start-.5);a=(1+(a.end-a.start))*Protein.UNITS_PER_RESIDUE*this.stickZoom;for(var d="M "+c+","+e,f=0;f<=Protein.stepsInArc;f++)d+=" L "+(c+f/Protein.stepsInArc*a)+","+b;return d+(" L "+(c+a)+","+e+" Z")};function Annotation(a,e,b,c,d){this.name=a;this.start=e-0;this.end=b-0;void 0!==c&&null!==c&&(this.colour=new RGBColor(c));this.notes=d};ProteinLink.maxNoResidueLinks=0;ProteinLink.prototype=new xiNET.Link;
function ProteinLink(a,e,b,c){this.id=a;this.residueLinks=d3.map();this.controller=c;this.fromProtein=e;this.toProtein=b;this.ambig=!1;this.tooltip=this.id;this.hidden=this.shown=!1;this.selfLink()?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path"),this.fatLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.highlightLine=document.createElementNS(xiNET.svgns,"line"),this.fatLine=
document.createElementNS(xiNET.svgns,"line"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","black");this.line.setAttribute("stroke-width",1);this.line.setAttribute("stroke-linecap","round");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-linecap",
"round");this.highlightLine.setAttribute("stroke-opacity","0");this.fatLine.setAttribute("class","link");this.fatLine.setAttribute("fill","none");this.fatLine.setAttribute("stroke","lightgray");this.fatLine.setAttribute("stroke-linecap","round");this.fatLine.setAttribute("stroke-linejoin","round");var d=this;this.line.onmousedown=function(a){d.mouseDown(a)};this.line.onmouseover=function(a){d.mouseOver(a)};this.line.onmouseout=function(a){d.mouseOut(a)};this.line.ontouchstart=function(a){d.touchStart(a)};
this.highlightLine.onmousedown=function(a){d.mouseDown(a)};this.highlightLine.onmouseover=function(a){d.mouseOver(a)};this.highlightLine.onmouseout=function(a){d.mouseOut(a)};this.highlightLine.ontouchstart=function(a){d.touchStart(a)};this.fatLine.onmousedown=function(a){d.mouseDown(a)};this.fatLine.onmousedown=function(a){d.mouseDown(a)};this.fatLine.onmouseover=function(a){d.mouseOver(a)};this.fatLine.onmouseout=function(a){d.mouseOut(a)};this.fatLine.ontouchstart=function(a){d.touchStart(a)};
this.isSelected=!1}ProteinLink.prototype.selfLink=function(){return this.fromProtein===this.toProtein};ProteinLink.prototype.initSelfLinkSVG=function(){var a=this.fromProtein.getAggregateSelfLinkPath();this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.fatLine.setAttribute("d",a)};ProteinLink.prototype.getFromProtein=function(){return this.fromProtein};ProteinLink.prototype.getToProtein=function(){return this.toProtein};
ProteinLink.prototype.showHighlight=function(a,e){"undefined"===typeof e&&(e=!1);this.shown&&(a?(this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1")):(this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0")));if(e&&this.ambig)for(var b=this.residueLinks.values().length,c=0;c<b;c++)for(var d=this.residueLinks.values()[c],f=d.matches.length,
h=0;h<f;h++){var l=d.matches[h][0];if(l.isAmbig())for(var g=l.residueLinks.length,k=0;k<g;k++)d=l.residueLinks[k],!0===d.shown&&0==d.isSelected&&d.showHighlight(a,!1),!0===d.proteinLink.shown&&d.proteinLink.showHighlight(a,!1)}};
ProteinLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB()),
this.controller.linkSelectionChanged())};ProteinLink.prototype.getFilteredMatches=function(){for(var a=this.residueLinks.values(),e=a.length,b=d3.map(),c=0;c<e;c++)for(var d=a[c],f=d.matches.length,h=0;h<f;h++){var l=d.matches[h];l.meetsFilterCriteria()&&b.set(l.id)}return b.keys()};
ProteinLink.prototype.check=function(){if(this.fromProtein.isParked||null!==this.toProtein&&this.toProtein.isParked)return this.hide(),!1;if(this.selfLink()&&!1===this.controller.selfLinksShown){if(0===this.fromProtein.form)this.hide();else for(var a=this.residueLinks.values(),e=a.length,b=0;b<e;b++)a[b].hide();return!1}if(this.hidden){if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form)this.hide();else for(a=this.residueLinks.values(),e=a.length,b=0;b<e;b++)a[b].hide();return!1}a=
this.residueLinks.values();e=a.length;this.hd=!1;if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form){this.ambig=!0;for(var c=[],d=d3.map(),f=d3.map(),b=0;b<e;b++){var h=a[b],l=!1;if(h.matches)for(var g=h.matches.length,k=0;k<g;k++){var m=h.matches[k][0];if(m.meetsFilterCriteria())if(!0===m.hd&&(this.hd=!0),!1===l&&(l=!0,c.push(h)),d.set(m.id,m),m.isAmbig())for(var n=0;n<m.residueLinks.length;n++)f.set(m.residueLinks[n].proteinLink.id);else this.ambig=!1}else c.push(h)}b=
c.length;if(0<b){this.tooltip=this.id+", "+b+" unique cross-link";1<b&&(this.tooltip+="s");this.tooltip+=" ("+d.keys().length;1===d.keys().length?this.tooltip+=" match)":this.tooltip+=" matches)";this.w=45/ProteinLink.maxNoResidueLinks*b;this.ambig=this.ambig&&1<f.keys().length;this.dashedLine(this.ambig);if(1<this.controller.groups.values().length&&5>this.controller.groups.values().length){a=d3.set();e=d.values();d=e.length;for(b=0;b<d;b++)m=e[b],a.add(m.group);1==a.values().length?(b=this.controller.linkColours(a.values()[0]),
this.line.setAttribute("stroke",b)):this.line.setAttribute("stroke","#000000")}else this.selfLink()&&(this.hd?(this.line.setAttribute("stroke",xiNET.homodimerLinkColour.toRGB()),this.line.setAttribute("stroke-width",xiNET.homodimerLinkWidth)):(this.line.setAttribute("stroke","black"),this.line.setAttribute("stroke-width",1)));this.show();return!0}this.hide();return!1}if(null!==this.toProtein||0!==this.fromProtein.form){b=!1;for(m=0;m<e;m++)!0===a[m].check()&&(b=!0);return b}};
ProteinLink.prototype.dashedLine=function(a){1==this.controller.unambigLinkFound&&(a?!0===this.selfLink()?this.line.setAttribute("stroke-dasharray","4, 4"):this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z):a||this.line.removeAttribute("stroke-dasharray"))};
ProteinLink.prototype.show=function(){this.shown||(this.shown=!0,this.selfLink()?(1<ProteinLink.maxNoResidueLinks&&(this.fatLine.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.controller.p_pLinksWide.appendChild(this.fatLine)),this.line.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.highlightLine.setAttribute("transform","translate("+this.fromProtein.x+" "+
this.fromProtein.y+") scale("+this.controller.z+")")):(this.line.setAttribute("stroke-width",1*this.controller.z),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.fromProtein),this.setLineCoordinates(this.toProtein),1<ProteinLink.maxNoResidueLinks&&this.controller.p_pLinksWide.appendChild(this.fatLine)),this.controller.highlights.appendChild(this.highlightLine),this.controller.p_pLinks.appendChild(this.line));1<ProteinLink.maxNoResidueLinks&&(this.selfLink()?
this.fatLine.setAttribute("stroke-width",this.w):this.fatLine.setAttribute("stroke-width",this.controller.z*this.w))};ProteinLink.prototype.hide=function(){this.shown&&(this.shown=!1,this.selfLink(),1<ProteinLink.maxNoResidueLinks&&this.controller.p_pLinksWide.removeChild(this.fatLine),this.controller.highlights.removeChild(this.highlightLine),this.controller.p_pLinks.removeChild(this.line))};
ProteinLink.prototype.setLineCoordinates=function(a){!1===this.selfLink()&&null!==this.getToProtein()&&this.shown&&(this.getFromProtein()===a?(this.line.setAttribute("x1",a.x),this.line.setAttribute("y1",a.y),this.highlightLine.setAttribute("x1",a.x),this.highlightLine.setAttribute("y1",a.y),this.fatLine.setAttribute("x1",a.x),this.fatLine.setAttribute("y1",a.y)):this.getToProtein()===a&&(this.line.setAttribute("x2",a.x),this.line.setAttribute("y2",a.y),this.highlightLine.setAttribute("x2",a.x),this.highlightLine.setAttribute("y2",
a.y),this.fatLine.setAttribute("x2",a.x),this.fatLine.setAttribute("y2",a.y)))};ProteinLink.prototype.getOtherEnd=function(a){return this.fromProtein===a?this.toProtein:this.fromProtein};ResidueLink.prototype=new xiNET.Link;function ResidueLink(a){this.crossLink=a;this.tooltip=this.crossLink.id;this.dashed=this.shown=!1;this.initSVG()}
ResidueLink.prototype.initSVG=function(){if("undefined"===typeof this.line){!0===this.selfLink()||null===this.proteinLink.toProtein?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.line.setAttribute("stroke",xiNET.defaultInterLinkColour.toRGB()),this.line.setAttribute("stroke-linecap","round"),this.highlightLine=document.createElementNS(xiNET.svgns,"line"),this.highlightLine.setAttribute("stroke-linecap",
"round"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-opacity","0");"undefined"!==typeof this.colour&&this.line.setAttribute("stroke",this.colour);var a=this;this.line.onmousedown=function(e){a.mouseDown(e)};
this.line.onmouseover=function(e){a.mouseOver(e)};this.line.onmouseout=function(e){a.mouseOut(e)};this.line.ontouchstart=function(e){a.touchStart(e)};this.highlightLine.onmousedown=function(e){a.mouseDown(e)};this.highlightLine.onmouseover=function(e){a.mouseOver(e)};this.highlightLine.onmouseout=function(e){a.mouseOut(e)};this.highlightLine.ontouchstart=function(e){a.touchStart(e)}}this.isSelected=!1};ResidueLink.prototype.selfLink=function(){return this.crossLink.isSelfLink()};
ResidueLink.prototype.getFromProtein=function(){return this.crossLink.getFromProtein()};ResidueLink.prototype.getToProtein=function(){return this.crossLink.getToProtein()};
ResidueLink.prototype.showHighlight=function(a,e){if(!(this.proteinLink.fromProtein.busy||this.proteinLink.toProtein&&this.proteinLink.toProtein.busy)){"undefined"===typeof e&&(e=!1);if(this.shown)if(a){this.highlightLine.setAttribute("stroke",xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-opacity","0.7");for(var b=[],c=[],d=this.getFilteredMatches(),f=d.length,h=0;h<f;h++){var l=d[h][0],g=d[h][3]-1,k=d[h][4];b.push([d[h][1]-1,d[h][2],l.overlap[0],l.overlap[1]]);c.push([g,
k,l.overlap[0],l.overlap[1]])}this.proteinLink.fromProtein.showPeptides(b);null!==this.proteinLink.toProtein&&this.proteinLink.toProtein.showPeptides(c);h=d3.map();h.set(this.id,this);this.controller.linkHighlightsChanged(h)}else this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0"),this.proteinLink.fromProtein.removePeptides(),null!==this.proteinLink.toProtein&&this.proteinLink.toProtein.removePeptides(),this.controller.linkHighlightsChanged(d3.map());
if(e&&this.ambig)for(b=this.matches?this.matches.length:0,h=0;h<b;h++)if(l=this.matches[h][0],l.isAmbig())for(c=l.residueLinks.length,d=0;d<c;d++)f=l.residueLinks[d],f.showHighlight(a,!1),f.proteinLink.showHighlight(a,!1)}};
ResidueLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","0.7"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",
xiNET.highlightColour.toRGB()),this.controller.linkSelectionChanged())};ResidueLink.prototype.getFilteredMatches=function(){this.ambig=!0;this.intraMolecular=this.hd=!1;for(var a=[],e=this.matches?this.matches.length:0,b=0;b<e;b++){var c=this.matches[b][0];c.meetsFilterCriteria()&&(a.push(this.matches[b]),!1===c.isAmbig()&&(this.ambig=!1),!0===c.hd&&(this.hd=!0),1===c.type&&(this.intraMolecular=!0))}return a};ResidueLink.prototype.check=function(a){this.show();return!0};
ResidueLink.prototype.dashedLine=function(a){1!=this.controller.unambigLinkFound||"undefined"===typeof this.line||isNaN(parseFloat(this.toResidue))||(a?!0===this.selfLink()?(this.dashed=!0,this.line.setAttribute("stroke-dasharray","4, 4")):(this.dashed=!0,this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z)):a||(this.dashed=!1,this.line.removeAttribute("stroke-dasharray")))};
ResidueLink.prototype.show=function(){this.shown||(this.shown=!0,"undefined"===typeof this.line&&this.initSVG(),this.selfLink()||null===this.proteinLink.toProtein||(this.line.setAttribute("stroke-width",this.controller.z*xiNET.linkWidth),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.getFromProtein()),this.setLineCoordinates(this.getToProtein()),this.controller.highlights.appendChild(this.highlightLine),this.controller.res_resLinks.appendChild(this.line)))};
ResidueLink.prototype.hide=function(){this.controller.sequenceInitComplete&&this.shown&&(this.shown=!1,this.selfLink()||null===this.proteinLink.toProtein?(this.proteinLink.fromProtein.selfLinksHighlights.removeChild(this.highlightLine),this.proteinLink.fromProtein.selfLinks.removeChild(this.line)):(this.controller.res_resLinks.removeChild(this.line),this.controller.highlights.removeChild(this.highlightLine)))};
ResidueLink.prototype.setLineCoordinates=function(a){if(null!=a.x&&null!=a.y&&!1===this.selfLink()&&null!==this.getToProtein()&&this.shown){var e;this.getFromProtein()===a?(0===a.form?(e=a.x,a=a.y):(a=this.getResidueCoordinates(this.fromResidue,a),e=a[0],a=a[1]),this.line.setAttribute("x1",e),this.line.setAttribute("y1",a),this.highlightLine.setAttribute("x1",e),this.highlightLine.setAttribute("y1",a)):this.getToProtein()===a&&(0===a.form?(e=a.x,a=a.y):(a=this.getResidueCoordinates(this.toResidue,
a),e=a[0],a=a[1]),this.line.setAttribute("x2",e),this.line.setAttribute("y2",a),this.highlightLine.setAttribute("x2",e),this.highlightLine.setAttribute("y2",a))}};
ResidueLink.prototype.getResidueCoordinates=function(a,e){var b=e.getResXwithStickZoom(a)*this.controller.z,c=0;if(8<Protein.UNITS_PER_RESIDUE*e.stickZoom){var c=this.getFromProtein(),d=this.getToProtein(),f=Math.atan2(c.y-d.y,c.x-d.x)/(2*Math.PI)*360;0>f&&(f+=360);e===c?(c=f-c.rotation,0>c&&(c+=360),d=5,180>c&&(d=-5)):(c=f-d.rotation,0>c&&(c+=360),d=5,180<c&&(d=-5));c=d*this.controller.z}c=Protein.rotatePointAboutPoint([b,c],[0,0],e.rotation);b=c[0]+e.x;c=c[1]+e.y;return[b,c]};
ResidueLink.prototype.leastAmbiguousMatches=function(){};ResidueLink.prototype.toJSON=function(){for(var a=[],e=this.matches.length,b=0;b<e;b++)a.push(this.matches[b].id);return{}};function xiNET_Storage(a){this.controller=a}xiNET_Storage.ns="xiNET.";xiNET_Storage.accessionFromId=function(a){a+="";return-1!==a.indexOf("|")?a.split("|")[1]:a};
xiNET_Storage.prototype.getUniProtTxt=function(a,e){function b(){d3.text("http://www.uniprot.org/uniprot/"+c+".txt",function(b){"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"UniProtKB."+c,b);e(a,b)})}var c=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var d=localStorage.getItem(xiNET_Storage.ns+"UniProtKB."+c);d?e(a,d):b()}else b()};
xiNET_Storage.prototype.getSequence=function(a,e){function b(){d3.text("http://www.uniprot.org/uniprot/"+c+".fasta",function(b){var d="";b=b.split("\n");for(var l=b.length,g=1;g<l;g++)var k=b[g],k=b[g],d=d+k;d=d.replace(/[^A-Z]/g,"");"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"UniProtKB.fasta."+c,d);e(a,d)})}var c=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var d=localStorage.getItem(xiNET_Storage.ns+"UniProtKB.fasta."+c);d?e(a,d):b()}else b()};
xiNET_Storage.prototype.getUniProtFeatures=function(a,e){this.getUniProtTxt(a,function(a,c){var d=[];if(null!==c)for(var f=c.split("\n"),h=f.length,l=0;l<h;l++){var g=f[l];0===g.indexOf("FT")&&(g=g.split(/\s{2,}/g),4<g.length&&"CHAIN"!==g[1]&&d.push(new Annotation(g[1],g[2],g[3],null,g[4])))}e(a,d)})};
xiNET_Storage.prototype.getSuperFamFeatures=function(a,e){function b(){d3.xml("http://supfam.org/SUPERFAMILY/cgi-bin/das/up/features?segment="+d,function(a){a=(new XMLSerializer).serializeToString(a);"undefined"!==typeof Storage&&localStorage.setItem(xiNET_Storage.ns+"SuperFamDAS."+d,a);c(a)})}function c(b){if(window.DOMParser)var c=(new DOMParser).parseFromString(b,"text/xml");else c=new ActiveXObject("Microsoft.XMLDOM"),c.async=!1,c.loadXML(b);b=[];for(var c=c.getElementsByTagName("FEATURE"),d=
c.length,f=0;f<d;f++){var m=c[f],n=m.getElementsByTagName("TYPE")[0];if("miscellaneous"===n.getAttribute("category")){var n=n.getAttribute("id"),q=m.getElementsByTagName("START")[0].textContent,m=m.getElementsByTagName("END")[0].textContent;b.push(new Annotation(n,q,m))}}e(a,b)}var d=this.controller.proteins.get(a).accession;if("undefined"!==typeof Storage){var f=localStorage.getItem(xiNET_Storage.ns+"SuperFamDAS."+d);f?c(f):b()}else b()};function Rotator(a,e,b){var c=this;this.ctrl=b;this.proteinOrPartThereof=a;this.upperOrLower=e;this.svg=document.createElementNS(xiNET.svgns,"g");this.rotatorSymbol=document.createElementNS(xiNET.svgns,"g");a=document.createElementNS(xiNET.svgns,"circle");a.setAttribute("r",14);a.setAttribute("stroke","none");a.setAttribute("fill","gray");a.setAttribute("fill-opacity","0.0");this.svg.appendChild(a);a=document.createElementNS(xiNET.svgns,"circle");a.setAttribute("r",20);a.setAttribute("stroke","black");
a.setAttribute("stroke-width","1");a.setAttribute("fill","none");this.rotatorSymbol.appendChild(a);a=document.createElementNS(xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");this.rotatorSymbol.appendChild(a);a=document.createElementNS(xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");
a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");a.setAttribute("transform","rotate(180)");this.rotatorSymbol.appendChild(a);this.rotatorSymbol.setAttribute("transform","rotate(45) scale (0.7, 0.7)");this.rotatorSymbol.setAttribute("display","none");this.inner=document.createElementNS(xiNET.svgns,"g");this.inner.setAttribute("class","PV_rotator");this.inner.appendChild(this.rotatorSymbol);this.svg.appendChild(this.inner);this.svg.onmouseover=function(a){c.rotatorMouseOver(a)};
this.svg.onmouseout=function(a){c.rotatorMouseOut(a)};this.svg.onmousedown=function(a){c.rotatorMouseDown(a)}}Rotator.prototype.rotatorMouseOver=function(a){this.ctrl.rotating||this.rotatorSymbol.setAttribute("display","block")};Rotator.prototype.rotatorMouseOut=function(a){this.rotatorSymbol.setAttribute("display","none")};
Rotator.prototype.rotatorMouseDown=function(a){this.ctrl.state=xiNET.Controller.ROTATING;this.ctrl.dragElement=this.proteinOrPartThereof;a=this.ctrl.getEventPoint(a);this.ctrl.mouseToSVG(a.x,a.y);this.ctrl.whichRotator=this.upperOrLower;return!1};
