'use strict';var $jscomp={scope:{},global:this},Symbol;$jscomp.initSymbol=function(){$jscomp.global.Symbol||(Symbol=$jscomp.Symbol);$jscomp.initSymbol=function(){}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return"jscomp_symbol_"+a+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();Symbol.iterator||(Symbol.iterator=Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();if(a[Symbol.iterator])return a[Symbol.iterator]();if(!(a instanceof Array||"string"==typeof a||a instanceof String))throw new TypeError(a+" is not iterable");var c=0;return{next:function(){return c==a.length?{done:!0}:{done:!1,value:a[c++]}}}};$jscomp.arrayFromIterator=function(a){for(var c,b=[];!(c=a.next()).done;)b.push(c.value);return b};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.arrayFromArguments=function(a){for(var c=[],b=0;b<a.length;b++)c.push(a[b]);return c};$jscomp.inherits=function(a,c){function b(){}b.prototype=c.prototype;a.prototype=new b;a.prototype.constructor=a;for(var d in c)if($jscomp.global.Object.defineProperties){var e=$jscomp.global.Object.getOwnPropertyDescriptor(c,d);void 0!==e&&$jscomp.global.Object.defineProperty(a,d,e)}else a[d]=c[d]};
(function(a){a.CLMS=a.CLMS||{};a.CLMS.xiNET={};a.CLMS.xiNET.CrosslinkViewer=Backbone.View.extend({initialize:function(c){this.options=_.extend({},c.myOptions);var b=this;d3.select(this.el).selectAll("*").remove();this.svgElement=document.createElementNS(CLMS.xiNET.svgns,"svg");this.svgElement.setAttribute("id","networkSVG");this.svgElement.setAttribute("width","100%");this.svgElement.setAttribute("height","100%");this.svgElement.oncontextmenu=function(){return!1};b=this;this.svgElement.onmousedown=
function(a){b.mouseDown(a)};this.svgElement.onmousemove=function(a){b.mouseMove(a)};this.svgElement.onmouseup=function(a){b.mouseUp(a)};this.svgElement.onmouseout=function(a){b.hideTooltip(a)};var a=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";document.attachEvent?this.svgElement.attachEvent("on"+a,function(a){b.mouseWheel(a)}):document.addEventListener&&this.svgElement.addEventListener(a,function(a){b.mouseWheel(a)},!1);this.lastMouseUp=(new Date).getTime();this.svgElement.ontouchstart=
function(a){b.touchStart(a)};this.svgElement.ontouchmove=function(a){b.touchMove(a)};this.svgElement.ontouchend=function(a){b.touchEnd(a)};this.el.appendChild(this.svgElement);this.ambigShown=this.selfLinksShown=!0;a=document.createElementNS(CLMS.xiNET.svgns,"rect");a.setAttribute("id","background_fill");a.setAttribute("x",0);a.setAttribute("y",0);a.setAttribute("width",5120);a.setAttribute("height",4096);a.setAttribute("fill-opacity","1");a.setAttribute("fill","#FFFFFF");this.svgElement.appendChild(a);
this.container=document.createElementNS(CLMS.xiNET.svgns,"g");this.container.setAttribute("id","container");this.p_pLinksWide=document.createElementNS(CLMS.xiNET.svgns,"g");this.p_pLinksWide.setAttribute("id","p_pLinksWide");this.container.appendChild(this.p_pLinksWide);this.proteinLower=document.createElementNS(CLMS.xiNET.svgns,"g");this.proteinLower.setAttribute("id","proteinLower");this.container.appendChild(this.proteinLower);this.highlights=document.createElementNS(CLMS.xiNET.svgns,"g");this.highlights.setAttribute("class",
"highlights");this.container.appendChild(this.highlights);this.res_resLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.res_resLinks.setAttribute("id","res_resLinks");this.container.appendChild(this.res_resLinks);this.p_pLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.p_pLinks.setAttribute("id","p_pLinks");this.container.appendChild(this.p_pLinks);this.proteinUpper=document.createElementNS(CLMS.xiNET.svgns,"g");this.proteinUpper.setAttribute("id","proteinUpper");this.container.appendChild(this.proteinUpper);
this.svgElement.appendChild(this.container);this.tooltip=document.createElementNS(CLMS.xiNET.svgns,"text");this.tooltip.setAttribute("x",0);this.tooltip.setAttribute("y",0);a=document.createTextNode("tooltip");this.tooltip.appendChild(a);this.tooltip_bg=document.createElementNS(CLMS.xiNET.svgns,"rect");this.tooltip_bg.setAttribute("class","tooltip_bg");this.tooltip_bg.setAttribute("fill-opacity",.75);this.tooltip_bg.setAttribute("stroke-opacity",1);this.tooltip_bg.setAttribute("stroke-width",1);this.tooltip_subBg=
document.createElementNS(CLMS.xiNET.svgns,"rect");this.tooltip_subBg.setAttribute("fill","white");this.tooltip_subBg.setAttribute("stroke","white");this.tooltip_subBg.setAttribute("class","tooltip_bg");this.tooltip_subBg.setAttribute("opacity",1);this.tooltip_subBg.setAttribute("stroke-width",1);this.svgElement.appendChild(this.tooltip_subBg);this.svgElement.appendChild(this.tooltip_bg);this.svgElement.appendChild(this.tooltip);this.clear();this.initProteins();this.initLayout();for(var a=this.model.get("clmsModel").get("crossLinks").values(),
a=$jscomp.makeIterator(a),e=a.next();!e.done;e=a.next()){var e=e.value,f=new CLMS.xiNET.RenderedCrossLink(e,this);this.renderedCrossLinks.set(e.id,f)}this.listenTo(this.model.get("filterModel"),"change",this.render);this.listenTo(this.model.get("rangeModel"),"change:scale",this.relayout);this.listenTo(this.model,"change:highlights",this.highlightsChanged);this.listenTo(this.model,"change:selection",this.selectionChanged);c.displayEventName&&this.listenTo(CLMSUI.vent,c.displayEventName,this.setVisible);
this.render()},clear:function(){this.force&&this.force.stop();this.force=null;d3.select(this.p_pLinksWide).selectAll("*").remove();d3.select(this.highlights).selectAll("*").remove();d3.select(this.p_pLinks).selectAll("*").remove();d3.select(this.res_resLinks).selectAll("*").remove();d3.select(this.proteinLower).selectAll("*").remove();d3.select(this.proteinUpper).selectAll("*").remove();this.panning=!1;this.dragElement=null;this.dragging=!1;this.dragStart={};this.rotating=!1;this.renderedProteins=
new Map;this.renderedCrossLinks=new Map;this.matches=[];this.groups=d3.set();this.subgraphs=[];this.proteinCount=this.layoutXOffset=0;this.unambigLinkFound=!1;this.maxBlobRadius=30;this.layout=null;this.z=1;this.scores=null;this.selectedLinks=d3.map();this.hideTooltip();this.resetZoom();this.state=CLMS.xiNET.Controller.MOUSE_UP},checkLinks:function(){for(var a=this.renderedCrossLinks.values(),a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next())b.value.check()},initLayout:function(){var a=this.renderedProteins.values();
CLMS.xiNET.RenderedProtein.MAXSIZE=400;for(var a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next())b=b.value,b=b.size,b>CLMS.xiNET.RenderedProtein.MAXSIZE&&(console.log("MX:"+CLMS.xiNET.RenderedProtein.MAXSIZE),CLMS.xiNET.RenderedProtein.MAXSIZE=b);CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-CLMS.xiNET.RenderedProtein.LABELMAXLENGTH)/CLMS.xiNET.RenderedProtein.MAXSIZE;a=this.groups.values().length;if(1<a&&5>a){this.groups.values();this.linkColours=d3.scale.ordinal().range(colorbrewer.Dark2[5]);
for(var b=this.groups.values(),d=0;d<a;d++)this.linkColours(b[d]);this.legendChanged()}if("undefined"!==typeof this.layout&&null!=this.layout)this.loadLayout();else{a=this.renderedProteins.values();a=$jscomp.makeIterator(a);for(b=a.next();!b.done;b=a.next())b=b.value,this.proteinLower.appendChild(b.lowerGroup),this.proteinUpper.appendChild(b.upperGroup);this.autoLayout()}},initProteins:function(){var a=this.model.get("clmsModel").get("interactors").values();CLMS.xiNET.RenderedProtein.MAXSIZE=0;for(var a=
$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next()){var b=b.value,d=new CLMS.xiNET.RenderedProtein(b,this);this.renderedProteins.set(b.id,d);b=b.size;b>CLMS.xiNET.RenderedProtein.MAXSIZE&&(CLMS.xiNET.RenderedProtein.MAXSIZE=b)}CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-CLMS.xiNET.RenderedProtein.LABELMAXLENGTH)/CLMS.xiNET.RenderedProtein.MAXSIZE;a=this.renderedProteins.values();a=$jscomp.makeIterator(a);for(b=a.next();!b.done;b=a.next())b.value.init();
this.sequenceInitComplete=!0;this.annotationSet?this.setAnnotations(this.annotationSet):this.setAnnotations("CUSTOM")},reset:function(){this.resetZoom();for(var a=this.renderedProteins.values(),a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next())b=b.value,!1===b.isParked&&b.setForm(0);this.autoLayout()},resetZoom:function(){this.container.setAttribute("transform","scale(1)");this.scale()},scale:function(){},setAnnotations:function(a){function b(){for(var a=d3.set(),b=$jscomp.makeIterator(d),c=
b.next();!c.done;c=b.next())for(var c=c.value,e=0;e<c.annotations.length;e++)a.add(c.annotations[e].name);c=a.values().length;3>c&&(c=3);9>c?(c=colorbrewer.Accent[c].slice().reverse(),g.domainColours=d3.scale.ordinal().range(c)):13>c?(c=colorbrewer.Set3[c].slice().reverse(),g.domainColours=d3.scale.ordinal().range(c)):g.domainColours=d3.scale.category20();a=$jscomp.makeIterator(d);for(c=a.next();!c.done;c=a.next())for(c=c.value,e=0;e<c.annotations.length;e++){var b=c.annotations[e],f=g.domainColours(b.name);
b.pieSlice.setAttribute("fill",f);b.pieSlice.setAttribute("stroke",f);b.colouredRect.setAttribute("fill",f);b.colouredRect.setAttribute("stroke",f)}g.legendChanged()}this.annotationChoice=a;for(var d=this.renderedProteins.values(),e=$jscomp.makeIterator(d),f=e.next();!f.done;f=e.next())f=f.value,f.clearPositionalFeatures();this.domainColours=null;this.legendChanged();if(this.sequenceInitComplete){var g=this;if("CUSTOM"===a.toUpperCase()){a=$jscomp.makeIterator(d);for(f=a.next();!f.done;f=a.next())f=
f.value,f.setPositionalFeatures(f.customAnnotations);b()}else if("LYSINES"===a.toUpperCase()){for(m=0;m<molCount;m++){f=d[m];a=f.sequence;for(var e=[],h=0;h<f.size;h++)"K"===a[h]&&e.push(new Annotation("Lysine",h+1,h+1));f.setPositionalFeatures(e)}b()}else if("SUPERFAM"===a.toUpperCase()||"SUPERFAMILY"===a.toUpperCase()){var k=0;for(m=0;m<molCount;m++)f=d[m],this.xiNET_storage.getSuperFamFeatures(f.id,function(a,c){g.proteins.get(a).setPositionalFeatures(c);k++;k===molCount&&b()})}else if("UNIPROT"===
a.toUpperCase()||"UNIPROTKB"===a.toUpperCase())for(m=k=0;m<molCount;m++)f=d[m],this.xiNET_storage.getUniProtFeatures(f.interactor.id,function(a,c){g.renderedProteins.get(a).setPositionalFeatures(c);k++;k===molCount&&b()})}},legendChanged:function(){},setCTM:function(a,b){a.setAttribute("transform","matrix("+b.a+","+b.b+","+b.c+","+b.d+","+b.e+","+b.f+")")},mouseDown:function(a){a.preventDefault();"undefined"!==typeof this.force&&null!=this.force&&this.force.stop();var b=this.getEventPoint(a);this.dragStart=
this.mouseToSVG(b.x,b.y);var d;a.which?d=3===a.which:a.button&&(d=2===a.button);!0===a.ctrlKey||!0===a.shiftKey||d||(this.state=CLMS.xiNET.Controller.PANNING,this.panned=!1);return!1},mouseMove:function(a){var b=this.getEventPoint(a);a=this.mouseToSVG(b.x,b.y);if(null!=this.dragElement){this.hideTooltip();var b=this.dragStart.x-a.x,d=this.dragStart.y-a.y;if(this.state===CLMS.xiNET.Controller.DRAGGING){var e,f;if("undefined"===typeof this.dragElement.x){var g;g=this.dragElement.fromProtein?this.dragElement.fromProtein:
this.dragElement.proteinLink.fromProtein;for(var h=this.renderedProteins.values(),k=$jscomp.makeIterator(h),h=k.next();!h.done;h=k.next())h=h.value,h.subgraph=null;g=g.getSubgraph().nodes.values();for(var k=g.length,l=0;l<k;l++)h=g[l],e=h.x,f=h.y,e-=b,f-=d,h.setPosition(e,f),h.setAllLineCoordinates();for(l=0;l<k;l++)g[l].setAllLineCoordinates()}else e=this.dragElement.x,f=this.dragElement.y,this.dragElement.setPosition(e-b,f-d),this.dragElement.setAllLineCoordinates();this.dragStart=a}else this.state===
CLMS.xiNET.Controller.ROTATING?(a=Math.atan2(a.y-this.dragElement.y,a.x-this.dragElement.x),0===this.whichCLMS.xiNET.Rotator&&(a+=Math.PI),this.dragElement.setRotation(360/(2*Math.PI)*a),this.dragElement.setAllLineCoordinates()):Math.sqrt(b*b+d*d)>5*this.z&&(this.state=CLMS.xiNET.Controller.DRAGGING)}else this.state===CLMS.xiNET.Controller.PANNING?this.setCTM(this.container,this.container.getCTM().translate(a.x-this.dragStart.x,a.y-this.dragStart.y)):this.showTooltip(b);return!1},mouseUp:function(a){var b=
(new Date).getTime();this.preventDefaultsAndStopPropagation(a);if(150<b-this.lastMouseUp){var d,e;a.which?d=3===a.which:a.button&&(d=2===a.button);a.which?e=2===a.which:a.button&&(e=1===a.button);var f=this.getEventPoint(a),f=this.mouseToSVG(f.x,f.y);if(null!=this.dragElement)this.state!==CLMS.xiNET.Controller.DRAGGING&&this.state!==CLMS.xiNET.Controller.ROTATING?d?"undefined"===typeof this.dragElement.x?1==this.dragElement.selfLink()?this.dragElement.proteinLink&&this.dragElement.proteinLink.fromProtein.toggleFlipped():
(void 0!==this.dragElement.hidden?this.dragElement.hidden=!0:this.dragElement.proteinLink.hidden=!0,this.dragElement.highlightLine.setAttribute("stroke-opacity","0"),this.checkLinks()):this.dragElement.setParked(!this.dragElement.isParked,f):e||"undefined"!==typeof this.dragElement.x&&(a.shiftKey?this.dragElement.switchStickScale(f):!0===this.sequenceInitComplete&&(1===this.dragElement.form?this.dragElement.setForm(0,f):this.dragElement.setForm(1,f))):this.state===CLMS.xiNET.Controller.ROTATING&&
this.dragElement.setRotation(5*Math.round(this.dragElement.rotation/5));else if(d){a=this.proteinLinks.values();d=a.length;for(e=0;e<d;e++)a[e].hidden=!1;this.checkLinks()}else!1===a.ctrlKey&&this.model.set("selection",[]);this.state===CLMS.xiNET.Controller.SELECTING&&(clearInterval(this.marcher),this.svgElement.removeChild(this.marquee))}this.dragElement=null;this.whichRotator=-1;this.state=CLMS.xiNET.Controller.MOUSE_UP;this.lastMouseUp=b;return!1},mouseWheel:function(a){this.preventDefaultsAndStopPropagation(a);
var b=1+(a.wheelDelta?a.wheelDelta/3600:a.detail/-90),d=this.container;a=this.getEventPoint(a);a=this.mouseToSVG(a.x,a.y);b=this.svgElement.createSVGMatrix().translate(a.x,a.y).scale(b).translate(-a.x,-a.y);this.setCTM(d,d.getCTM().multiply(b));this.scale();return!1},getEventPoint:function(a){var b=this.svgElement.createSVGPoint(),d=this.svgElement.parentNode,e=0,f=0;do e+=d.offsetTop||0,f+=d.offsetLeft||0,d=d.offsetParent;while(d);b.x=a.pageX-f;b.y=a.pageY-e;return b},mouseToSVG:function(a,b){var d=
this.svgElement.createSVGPoint();d.x=a;d.y=b;return d=d.matrixTransform(this.container.getCTM().inverse())},preventDefaultsAndStopPropagation:function(a){a.stopPropagation&&a.stopPropagation();null!=a.cancelBubble&&(a.cancelBubble=!0);a.preventDefault&&a.preventDefault()},showTooltip:function(a){var b;b=this.tooltip.getComputedTextLength()+16;var d=this.svgElement.parentNode.clientWidth,e=this.svgElement.parentNode.clientHeight;b=a.x+20+b<d?a.x:d-b-20;a=a.y+60<e?a.y:e-60;this.tooltip.setAttribute("x",
b+22);this.tooltip.setAttribute("y",a+47);this.tooltip_bg.setAttribute("x",b+16);this.tooltip_bg.setAttribute("y",a+28);this.tooltip_subBg.setAttribute("x",b+16);this.tooltip_subBg.setAttribute("y",a+28)},setTooltip:function(a,b){if(a){this.tooltip.firstChild.data=a.toString().replace(/&(quot);/g,'"');this.tooltip.setAttribute("display","block");var d=this.tooltip.getComputedTextLength();this.tooltip_bg.setAttribute("width",d+16);this.tooltip_subBg.setAttribute("width",d+16);"undefined"!==typeof b&&
null!=b?(this.tooltip_bg.setAttribute("fill",b),this.tooltip_bg.setAttribute("stroke",b),this.tooltip_bg.setAttribute("fill-opacity","0.5")):(this.tooltip_bg.setAttribute("fill","white"),this.tooltip_bg.setAttribute("stroke","grey"));this.tooltip_bg.setAttribute("height",28);this.tooltip_subBg.setAttribute("height",28);this.tooltip_bg.setAttribute("display","block");this.tooltip_subBg.setAttribute("display","block")}else this.hideTooltip()},hideTooltip:function(){this.tooltip.setAttribute("display",
"none");this.tooltip_bg.setAttribute("display","none");this.tooltip_subBg.setAttribute("display","none")},autoLayout:function(){function a(b){function c(a){d.push(a.id);for(var b=0;b<a.proteinLinks.values().length;b++){var e=a.proteinLinks.values()[b];if(!0===e.check()&&(e=e.getOtherEnd(a),-1===d.indexOf(e.id))){c(e);break}}}var d=[];c(function(){for(var a=b.nodes.values(),c=a.length,d=0;d<c;d++)if(2>a[d].countExternalLinks())return a[d];console.error("missed linear subgraph start");return null}());
return d}function b(a){return a*(60+CLMS.xiNET.RenderedProtein.LABELMAXLENGTH)-30}this.force&&this.force.stop();var d=this.svgElement.parentNode.clientWidth,e=this.svgElement.parentNode.clientHeight,f=this,g=this.renderedProteins.values();this.subgraphs.length=0;for(var h=$jscomp.makeIterator(g),g=h.next();!g.done;g=h.next()){var k=g.value;k.interactor.subgraph=null}for(var l=0,g=this.renderedProteins.values(),h=$jscomp.makeIterator(g),g=h.next();!g.done;g=h.next())k=g.value,l++,k.interactor.getSubgraph();
this.subgraphs.sort(function(a,b){return a.nodes.values().length-b.nodes.values().length});g=this.renderedProteins.values();if(1===l)h=g.next().value,h.setPosition(d/2,e/2);else if(2===l)h=g.next().value,h.setPosition(d/2,.3*e),h.setAllLineCoordinates(),g=g.next().value,g.setPosition(d/2,.6*e),g.setAllLineCoordinates();else{for(var p=[],g=[],k=this.subgraphs.length,h=0;h<k;h++){var n=this.subgraphs[h],q=n.nodes.values(),v=q.length,t=!0;if(1===v)t=!0;else{for(var u=!1,r=0;r<v;r++)if(2<q[r].countExternalLinks()){t=
!1;break}else 2>q[r].countExternalLinks()&&(u=!0);u||(t=!1)}!0===t?p.push(n):g.push(n)}t=n=k=0;u=-1;if(0<p.length)for(k++,h=0;h<p.length;h++)for(q=p[h].nodes.keys(),v=q.length,2<v&&(q=a(p[h])),r=0;r<v;r++){var w=this.renderedProteins.get(q[r]),y,x;!0===w.isParked?(t++,y=b(u),x=30*t,x>e&&(u--,t=1,y=b(u),x=30*t)):(n++,(60>l||1<v)&&n++,y=b(k),x=30*n,30*(n+2*(v-1-r))+this.maxBlobRadius>e&&(k++,n=1,60>l&&n++,y=b(k),x=30*n));w.setPosition(y,x);w.setAllLineCoordinates()}this.layoutXOffset=b(k+.5);if("undefined"===
typeof this.force||null==this.force){l={NAME:"ALL",children:[]};for(h=0;h<g.length;h++)for(q=g[h].nodes.values(),v=q.length,r=0;r<v;r++)k=this.renderedProteins.get(q[r].id),n={},n.id=k.id,n.x=k.x-this.layoutXOffset,n.y=k.y,n.px=k.x-this.layoutXOffset,n.py=k.y,n.linkCount=k.proteinLinks.keys().length,n.size=30,l.children.push(n);q=d3.layout.pack().size([d-this.layoutXOffset,e]).value(function(a){return a.size}).sort(function(a,b){return b.linkCount-a.linkCount}).nodes(l);v=q.length;for(r=1;r<v;r++)l=
q[r],h=this.renderedProteins.get(l.id),l=Protein.rotatePointAboutPoint([l.x,l.y],[d-this.layoutXOffset/2,e/2],90),h.setPosition(l[0]+this.layoutXOffset,l[1]),h.setAllLineCoordinates(!1)}p=d-this.layoutXOffset;200>p&&(p=d);l={nodes:[],links:[]};d={};for(h=t=0;h<g.length;h++)for(q=g[h].nodes.values(),v=q.length,r=0;r<v;r++)k=this.renderedProteins.get(q[r].id),d[k.id]=t,t++,n={},n.id=k.id,n.x=k.x-this.layoutXOffset,n.y=k.y,n.px=k.x-this.layoutXOffset,n.py=k.y,l.nodes.push(n);for(h=0;h<g.length;h++)for(q=
g[h].links.values(),r=q.length,k=0;k<r;k++)if(n=q[k],t=n.fromProtein,u=n.toProtein)t=d[t.id],u=d[u.id],t!==u&&("undefined"!==typeof t&&"undefined"!==typeof u?(w={},w.source=t,w.target=u,w.id=n.id,l.links.push(w)):alert("NOT RIGHT"));g=Math.sqrt(l.nodes.length/(p*e));this.force=d3.layout.force().nodes(l.nodes).links(l.links).gravity(85*g).linkDistance(60).charge(-30/g).size([p,e]);v=this.force.nodes().length;this.force.links();this.force.on("tick",function(a){a=f.force.nodes();for(var b=0;b<v;b++){var c=
a[b],d=f.proteins.get(c.id);d.setPosition(c.x+f.layoutXOffset,c.y);d.setAllLineCoordinates()}});this.force.start()}},getSVG:function(){return CLMSUI.utils.getSVG(d3.select(this.el).select("svg"))},render:function(){console.log("re rendering cross-link viewer");this.checkLinks();return this},highlightsChanged:function(){for(var a=$jscomp.makeIterator(this.renderedCrossLinks.values()),b=a.next();!b.done;b=a.next())b=b.value,b.showHighlight(!1);if(a=this.model.get("highlights")[0])b=this.renderedCrossLinks.get(a.id),
b.showHighlight(!0);return this},selectionChanged:function(){for(var a=$jscomp.makeIterator(this.renderedCrossLinks.values()),b=a.next();!b.done;b=a.next())b=b.value,b.setSelected(!1);if(a=this.model.get("highlights")[0])b=this.renderedCrossLinks.get(a.id),b.setSelected(!0);return this},remove:function(){this.chart=this.chart.destroy();d3.select(this.el).selectAll(".dynDiv_resizeDiv_tl, .dynDiv_resizeDiv_tr, .dynDiv_resizeDiv_bl, .dynDiv_resizeDiv_br").on(".drag",null);Backbone.View.prototype.remove.call(this)}})})(this);
CLMS.xiNET.svgns="http://www.w3.org/2000/svg";CLMS.xiNET.xlinkNS="http://www.w3.org/1999/xlink";CLMS.xiNET.linkWidth=1.3;CLMS.xiNET.homodimerLinkWidth=1.3;CLMS.xiNET.highlightColour=new RGBColor("#fdc086");CLMS.xiNET.selectedColour=new RGBColor("#ffff99");CLMS.xiNET.defaultSelfLinkColour=new RGBColor("#9970ab");CLMS.xiNET.defaultInterLinkColour=new RGBColor("#35978f");CLMS.xiNET.homodimerLinkColour=new RGBColor("#a50f15");CLMS.xiNET.Controller={};CLMS.xiNET.Controller.MOUSE_UP=0;
CLMS.xiNET.Controller.PANNING=1;CLMS.xiNET.Controller.DRAGGING=2;CLMS.xiNET.Controller.ROTATING=3;CLMS.xiNET.Controller.SCALING_PROTEIN=4;CLMS.xiNET.Controller.SCALING_ALL_PROTEINS=5;CLMS.xiNET.Controller.SELECTING=6;CLMS.xiNET.RenderedLink=function(){};CLMS.xiNET.RenderedLink.prototype.mouseDown=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;this.crosslinkViewer.model.set("selection",[this.crossLink]);a=this.crosslinkViewer.getEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedLink.prototype.mouseOver=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.crosslinkViewer.model.set("highlights",[this.crossLink]);this.crosslinkViewer.setTooltip(this.tooltip)};CLMS.xiNET.RenderedLink.prototype.mouseOut=function(a){this.crosslinkViewer.model.set("highlights",[]);this.crosslinkViewer.hideTooltip()};
CLMS.xiNET.RenderedLink.prototype.touchStart=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);void 0!==this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;this.crosslinkViewer.clearSelection();this.setSelected(!0);a=this.crosslinkViewer.getTouchEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};CLMS.xiNET.RenderedProtein=function(a,c){this.interactor=a;this.crosslinkViewer=c;this.tooltip=this.interactor.name+" ["+this.interactor.accession+"]";this.proteinLinks=d3.map();this.selfLink=null;this.y=this.x=40;this.previousRotation=this.rotation=0;this.stickZoom=1;this.form=0;this.isSelected=this.isFlipped=this.isParked=!1;this.customAnnotations=null;this.lowerRotator=new CLMS.xiNET.Rotator(this,0,this.crosslinkViewer);this.upperRotator=new CLMS.xiNET.Rotator(this,1,this.crosslinkViewer);this.lowerGroup=
document.createElementNS(CLMS.xiNET.svgns,"g");this.lowerGroup.setAttribute("class","protein lowerGroup");this.highlight=document.createElementNS(CLMS.xiNET.svgns,"rect");void 0!==CLMS.xiNET.highlightColour&&this.highlight.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlight.setAttribute("stroke-width","5");this.highlight.setAttribute("fill","none");this.lowerGroup.appendChild(this.highlight);this.rectDomains=document.createElementNS(CLMS.xiNET.svgns,"g");this.rectDomains.setAttribute("opacity",
"0");this.lowerGroup.appendChild(this.rectDomains);this.peptides=document.createElementNS(CLMS.xiNET.svgns,"g");this.lowerGroup.appendChild(this.peptides);this.upperGroup=document.createElementNS(CLMS.xiNET.svgns,"g");this.upperGroup.setAttribute("class","protein upperGroup");this.selfLinksHighlights=document.createElementNS(CLMS.xiNET.svgns,"g");this.selfLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.upperGroup.appendChild(this.selfLinksHighlights);this.upperGroup.appendChild(this.selfLinks);
this.labelSVG=document.createElementNS(CLMS.xiNET.svgns,"text");this.labelSVG.setAttribute("text-anchor","end");this.labelSVG.setAttribute("fill",this.interactor.isDecoy()?"#FB8072":"black");this.labelSVG.setAttribute("x",0);this.labelSVG.setAttribute("y",10);this.labelSVG.setAttribute("class","protein xlv_text proteinLabel");this.labelSVG.setAttribute("font-family","Arial");this.labelSVG.setAttribute("font-size","16");this.labelText=this.interactor.name;25<this.labelText.length&&(this.labelText=
this.labelText.substr(0,16)+"...");this.labelTextNode=document.createTextNode(this.labelText);this.labelSVG.appendChild(this.labelTextNode);d3.select(this.labelSVG).attr("transform","translate( -5 "+CLMS.xiNET.RenderedProtein.labelY+") rotate(0) scale(1, 1)");this.upperGroup.appendChild(this.labelSVG);this.ticks=document.createElementNS(CLMS.xiNET.svgns,"g");this.outline=document.createElementNS(CLMS.xiNET.svgns,"rect");this.outline.setAttribute("stroke","black");this.outline.setAttribute("stroke-width",
"1");this.outline.setAttribute("fill","#EEEEEE");this.upperGroup.appendChild(this.outline);this.upperGroup.appendChild(this.ticks);this.circDomains=document.createElementNS(CLMS.xiNET.svgns,"g");this.circDomains.setAttribute("opacity",1);this.upperGroup.appendChild(this.circDomains);this.scaleLabels=[];var b=this;this.upperGroup.onmousedown=function(a){b.mouseDown(a)};this.upperGroup.onmouseover=function(a){b.mouseOver(a)};this.upperGroup.onmouseout=function(a){b.mouseOut(a)};this.upperGroup.ontouchstart=
function(a){b.touchStart(a)};this.busy=this.isSelected=!1;this.showHighlight(!1)};CLMS.xiNET.RenderedProtein.prototype.init=function(){this.setForm(this.form);this.selfLink&&this.selfLink.initSelfLinkSVG();this.setAllLineCoordinates()};
CLMS.xiNET.RenderedProtein.prototype.mouseDown=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;a=this.crosslinkViewer.getEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedProtein.prototype.touchStart=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);void 0!==this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;a=this.crosslinkViewer.getTouchEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedProtein.prototype.mouseOver=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!0);this.crosslinkViewer.setTooltip(this.tooltip);return!1};CLMS.xiNET.RenderedProtein.prototype.mouseOut=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!1);this.crosslinkViewer.hideTooltip();return!1};
CLMS.xiNET.RenderedProtein.prototype.getBlobRadius=function(){var a=Math.sqrt(this.interactor.size/Math.PI);console.log("*br"+a);return a};CLMS.xiNET.RenderedProtein.prototype.toJSON=function(){return{id:this.id,x:this.x,y:this.y,rot:this.rotation,form:this.form,stickZoom:this.stickZoom,parked:this.isParked,flipped:this.isFlipped}};
CLMS.xiNET.RenderedProtein.prototype.showHighlight=function(a){!0===a?(this.highlight.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB()),this.highlight.setAttribute("stroke-opacity","1")):(0==this.isSelected&&this.highlight.setAttribute("stroke-opacity","0"),this.highlight.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()))};
CLMS.xiNET.RenderedProtein.prototype.setRotation=function(a){this.rotation=a%360;0>this.rotation&&(this.rotation+=360);this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")");this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")");var c=this.crosslinkViewer.svgElement;a=this.labelSVG.getAttribute("transform");var b=d3.transform(a);a=this.scaleLabels.length;
if(90<=this.rotation&&270>this.rotation){if(b=c.createSVGMatrix().translate(Math.abs(b.translate[0]),-CLMS.xiNET.RenderedProtein.labelY).rotate(180,0,0),this.labelSVG.transform.baseVal.initialize(c.createSVGTransformFromMatrix(b)),1===this.form){for(c=0;c<a;c++)this.scaleLabels[c].setAttribute("transform","scale(-1,1)");this.ticks.setAttribute("transform","scale(1,-1)")}}else if(b=c.createSVGMatrix().translate(-Math.abs(b.translate[0]),CLMS.xiNET.RenderedProtein.labelY),this.labelSVG.transform.baseVal.initialize(c.createSVGTransformFromMatrix(b)),
1===this.form){for(c=0;c<a;c++)this.scaleLabels[c].setAttribute("transform","scale(1,1)");this.ticks.setAttribute("transform","scale(1,1)")}};
CLMS.xiNET.RenderedProtein.prototype.setPosition=function(a,c){this.x=a;this.y=c;1===this.form&&!1===this.isParked?(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")"),this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")")):(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") "),
this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") "),null!=this.selfLink&&("undefined"!==typeof this.selfLink.fatLine&&this.selfLink.fatLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+")"),this.selfLink.line.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+")"),this.selfLink.highlightLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+
this.crosslinkViewer.z+")")))};CLMS.xiNET.RenderedProtein.rotOffset=17.5;CLMS.xiNET.RenderedProtein.minXDist=30;
CLMS.xiNET.RenderedProtein.prototype.switchStickScale=function(a){this.isParked&&this.toggleParked();if(0===this.form)this.toStick();else if(8<CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom)this.stickZoom=.5,this.setPosition(a.x,a.y);else{this.stickZoom*=3;var c=this.x-a.x;a=this.y-a.y;if(0===this.rotation||180===this.rotation)a=0;this.setPosition(this.x+2*c,this.y+2*a)}this.scale();this.setAllLineCoordinates()};
CLMS.xiNET.RenderedProtein.prototype.scale=function(){var a=this.interactor.size*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom;if(1===this.form){var c=d3.transform(this.labelSVG.getAttribute("transform")),c=this.crosslinkViewer.svgElement.createSVGMatrix().rotate(c.rotate).translate(-(this.interactor.size/2*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom+10),CLMS.xiNET.RenderedProtein.labelY);this.labelSVG.transform.baseVal.initialize(this.crosslinkViewer.svgElement.createSVGTransformFromMatrix(c));
if(this.annotations)for(var c=this.annotations.length,b=0;b<c;b++){var d=this.annotations[b];d.pieSlice.setAttribute("d",this.getAnnotationRectPath(d));d.colouredRect.setAttribute("d",this.getAnnotationRectPath(d))}d3.select(this.peptides).attr("transform","scale("+this.stickZoom+", 1)");d3.select(this.outline).attr("width",a).attr("x",this.getResXwithStickZoom(.5));d3.select(this.highlight).attr("width",a+5).attr("x",this.getResXwithStickZoom(.5)-2.5);this.lowerCLMS.xiNET.Rotator.svg.setAttribute("transform",
"translate("+(this.getResXwithStickZoom(.5)-CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");this.upperCLMS.xiNET.Rotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.interactor.size-0+.5)+CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");if(null!=this.selfLink)for(c=this.selfLink.residueLinks.values(),b=c.length,d=0;d<b;d++){var e=c[d];e.shown&&(a=this.getCLMS.xiNET.RenderedCrossLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",a))}if(null!=this.linkerModifications)for(c=
this.linkerModifications.residueLinks.values(),b=c.length,d=0;d<b;d++)e=c[d],e.shown&&(a=this.getCLMS.xiNET.RenderedCrossLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",a));this.setScaleGroup();this.setRotation(this.rotation)}};
CLMS.xiNET.RenderedProtein.prototype.setScaleGroup=function(){function a(a,b,c){var d=document.createElementNS(CLMS.xiNET.svgns,"g");d.setAttribute("transform","translate("+c+" 0)");c=document.createElementNS(CLMS.xiNET.svgns,"text");c.setAttribute("class","protein xlv_text proteinLabel");c.setAttribute("font-family","'Courier New', monospace");c.setAttribute("font-size","14");c.setAttribute("text-anchor","middle");c.setAttribute("x",0);c.setAttribute("y",CLMS.xiNET.RenderedProtein.STICKHEIGHT+4);
c.appendChild(document.createTextNode(b));d.appendChild(c);a.scaleLabels.push(c);a.ticks.appendChild(d)}function c(a,b){var c=document.createElementNS(CLMS.xiNET.svgns,"line");c.setAttribute("x1",b);c.setAttribute("y1",5);c.setAttribute("x2",b);c.setAttribute("y2",10);c.setAttribute("stroke","black");a.ticks.appendChild(c)}d3.select(this.ticks).selectAll("*").remove();this.scaleLabels=[];for(var b=CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom,d=-1,e=this.getResXwithStickZoom(this.interactor.size),
f=1;f<=this.interactor.size;f++){if(1===f||0===f%100&&200*b>CLMS.xiNET.RenderedProtein.minXDist||0===f%10&&20*b>CLMS.xiNET.RenderedProtein.minXDist){var g=this.getResXwithStickZoom(f);(8<=b||1!==f)&&c(this,g);d=(d+1)%2;0===d&&g+CLMS.xiNET.RenderedProtein.minXDist<e&&a(this,f,g)}if(8<=b&&this.sequence){g=document.createElementNS(CLMS.xiNET.svgns,"g");g.setAttribute("transform","translate("+this.getResXwithStickZoom(f)+" 0)");var h=document.createElementNS(CLMS.xiNET.svgns,"text");h.setAttribute("font-family",
"'Courier New', monospace");h.setAttribute("font-size","10px");h.setAttribute("text-anchor","middle");h.setAttribute("x",0);h.setAttribute("y",3);h.appendChild(document.createTextNode(this.sequence[f-1]));g.appendChild(h);this.scaleLabels.push(h);this.ticks.appendChild(g)}}a(this,this.interactor.size,e);8<b&&c(this,e)};
CLMS.xiNET.RenderedProtein.prototype.toggleFlipped=function(){(this.isFlipped=!this.isFlipped)?(this.selfLinks.setAttribute("transform","scale (1 -1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 -1)")):(this.selfLinks.setAttribute("transform","scale (1 1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 1)"))};
CLMS.xiNET.RenderedProtein.prototype.setParked=function(a,c){this.isParked=a;if(!0!==this.busy)if(0==a)0===this.form?(d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").duration(CLMS.xiNET.RenderedProtein.transitionTime),this.checkLinks(),d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)):this.toStick(),this.scale(),this.setAllLineCoordinates();else if(1==
a){this.isParked=!0;for(var b=this.proteinLinks.values().length,d=0;d<b;d++){var e=this.proteinLinks.values()[d];e.hide();for(var e=e.residueLinks.values(),f=e.length,g=0;g<f;g++)e[g].hide()}1===this.form?(this.toCircle(c),b=this.getBlobRadius(),d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill-opacity",1).attr("fill","#EEEEEE").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(this.rectDomains).transition().attr("opacity",
0).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)):(d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill","#EEEEEE").duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(this.circDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime))}};
CLMS.xiNET.RenderedProtein.prototype.setForm=function(a,c){if(!0!==this.busy)if(this.isParked)this.setParked(!1);else if(1==a)this.toStick();else{this.toCircle(c);var b=this.getBlobRadius();d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform",
"scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)}};
CLMS.xiNET.RenderedProtein.prototype.toCircle=function(a){function c(a){var b=d3.transform(l.labelSVG.getAttribute("transform")),b=l.crosslinkViewer.svgElement.createSVGMatrix().rotate(b.rotate).translate(g(u(a)),CLMS.xiNET.RenderedProtein.labelY);l.labelSVG.transform.baseVal.initialize(l.crosslinkViewer.svgElement.createSVGTransformFromMatrix(b));null!==h&&l.setPosition(h(u(a)),k(u(a)));b=e(u(a));l.stickZoom=d(u(a));1==l.form&&l.setRotation(b);l.setAllLineCoordinates();if(1===a){a=l.proteinLinks.values();
for(var b=a.length,f=0;f<b;f++){var n=a[f];if(null===n.toProtein||n.getFromProtein()===l&&0===n.getToProtein().form||n.getToProtein()===l&&0===n.getFromProtein().form||n.getToProtein()==n.getFromProtein())for(var n=n.residueLinks.values(),p=n.length,q=0;q<p;q++)n[q].hide()}l.form=0;l.checkLinks();l.stickZoom=v;l.rotation=t;l.busy=!1;return!0}return 1<a?c(1):!1}this.busy=!0;this.removePeptides();this.upperGroup.contains(this.lowerRotator.svg)&&this.upperGroup.removeChild(this.lowerRotator.svg);this.upperGroup.contains(this.upperRotator.svg)&&
this.upperGroup.removeChild(this.upperRotator.svg);var b=this.getBlobRadius(),d=d3.interpolate(this.stickZoom,0),e=d3.interpolate(180<this.rotation?this.rotation-360:this.rotation,0),f=d3.transform(this.labelSVG.getAttribute("transform")).translate[0],g=d3.interpolate(f,-(b+5)),h=null,k=null;"undefined"!==typeof a&&null!==a&&(h=d3.interpolate(this.x,a.x),k=d3.interpolate(this.y,a.y));var l=this;d3.select(this.ticks).transition().attr("opacity",0).duration(CLMS.xiNET.RenderedProtein.transitionTime/
4).each("end",function(){d3.select(this).selectAll("*").remove()});d3.select(this.highlight).transition().attr("width",2*b+5).attr("height",2*b+5).attr("x",-b-2.5).attr("y",-b-2.5).attr("rx",b+2.5).attr("ry",b+2.5).duration(CLMS.xiNET.RenderedProtein.transitionTime);if(null!=this.selfLink)for(var b=this.selfLink.residueLinks.values(),f=b.length,p=0;p<f;p++){var n=b[p];n.shown&&(a=d3.select(n.line),a.attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(n)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(CLMS.xiNET.RenderedProtein.transitionTime),
a=d3.select(n.highlightLine),a.attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(n)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(CLMS.xiNET.RenderedProtein.transitionTime))}if(null!=this.linkerModifications)for(b=this.linkerModifications.residueLinks.values(),f=b.length,p=0;p<f;p++)a=b[p],a.shown&&(a=d3.select(a.line),a.attr("fill","none"),a.attr("d","M 0,0 L 0,0"));l=this;if(this.annotations){a=this.annotations;for(var q=a.length,b=0;b<q;b++)f=a[b],p=f.colouredRect,d3.select(f.pieSlice).transition().attr("d",
this.getAnnotationPieSliceApproximatePath(f)).duration(CLMS.xiNET.RenderedProtein.transitionTime).each("end",function(){for(var a=0;a<q;a++){var b=l.annotations[a];this===b.pieSlice&&d3.select(this).attr("d",l.getAnnotationPieSliceArcPath(b))}}),d3.select(p).transition().attr("d",l.getAnnotationPieSliceApproximatePath(f)).duration(CLMS.xiNET.RenderedProtein.transitionTime)}var v=this.stickZoom,t=this.rotation,u=d3.ease("cubic-in-out");d3.timer(function(a){return c(a/CLMS.xiNET.RenderedProtein.transitionTime)})};
CLMS.xiNET.RenderedProtein.prototype.getX=function(){return this.x};CLMS.xiNET.RenderedProtein.prototype.getY=function(){return this.y};
CLMS.xiNET.RenderedProtein.prototype.toStick=function(){function a(b){var c=d3.transform(n.labelSVG.getAttribute("transform")),c=n.crosslinkViewer.svgElement.createSVGMatrix().rotate(c.rotate).translate(h(q(b)),CLMS.xiNET.RenderedProtein.labelY);n.labelSVG.transform.baseVal.initialize(n.crosslinkViewer.svgElement.createSVGTransformFromMatrix(c));c=g(q(b));n.setRotation(c);c=e(q(b));d3.select(n.outline).attr("width",c).attr("x",-(c/2)+.5*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*n.stickZoom);n.stickZoom=
f(q(b));n.setAllLineCoordinates();return 1===b?(n.busy=!1,!0):1<b?a(1):!1}this.busy=!0;this.form=1;this.upperGroup.appendChild(this.lowerRotator.svg);this.upperGroup.appendChild(this.upperRotator.svg);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.interactor.size-0+.5)+CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");for(var c=
this.proteinLinks.values().length,b=0;b<c;b++){var d=this.proteinLinks.values()[b];d.shown&&d.hide()}var c=this.interactor.size*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom,b=this.getBlobRadius(),e=d3.interpolate(2*b,c),f=d3.interpolate(0,this.stickZoom),g=d3.interpolate(0,180<this.rotation?this.rotation-360:this.rotation),h=d3.interpolate(-(b+5),-(this.interactor.size/2*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom+10)),b=this.stickZoom;this.stickZoom=0;this.checkLinks();
this.stickZoom=b;d3.select(this.circDomains).transition().attr("opacity",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",1).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",0).attr("fill","#FFFFFF").attr("height",CLMS.xiNET.RenderedProtein.STICKHEIGHT).attr("y",-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2).attr("rx",0).attr("ry",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);
d3.select(this.highlight).transition().attr("width",c+5).attr("height",CLMS.xiNET.RenderedProtein.STICKHEIGHT+5).attr("x",this.getResXwithStickZoom(.5)-2.5).attr("y",-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2-2.5).attr("rx",0).attr("ry",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);if(null!=this.selfLink)for(c=this.selfLink.residueLinks.values(),b=c.length,d=0;d<b;d++){var k=c[d];k.shown&&(d3.select(k.line).attr("d",this.getAggregateSelfLinkPath()),d3.select(k.line).transition().attr("d",
this.getCLMS.xiNET.RenderedCrossLinkPath(k)).duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(k.highlightLine).attr("d",this.getAggregateSelfLinkPath()),d3.select(k.highlightLine).transition().attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(k)).duration(CLMS.xiNET.RenderedProtein.transitionTime))}if(null!=this.linkerModifications)for(c=this.linkerModifications.residueLinks.values(),b=c.length,d=0;d<b;d++)if(k=c[d],k.shown){var l=this.getCLMS.xiNET.RenderedCrossLinkPath(k);d3.select(k.line).attr("d",
"M 0,0 L 0,0 L 0,0 L 0,0");d3.select(k.line).transition().attr("d",l).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(k.highlightLine).attr("d","M 0,0 L 0,0");d3.select(k.highlightLine).transition().attr("d",l).duration(CLMS.xiNET.RenderedProtein.transitionTime)}if(this.annotations)for(c=this.annotations,b=c.length,d=0;d<b;d++){var k=c[d],l=k.pieSlice,p=k.colouredRect;l.setAttribute("d",this.getAnnotationPieSliceApproximatePath(k));d3.select(l).transition().attr("d",this.getAnnotationRectPath(k)).duration(CLMS.xiNET.RenderedProtein.transitionTime);
d3.select(p).transition().attr("d",this.getAnnotationRectPath(k)).duration(CLMS.xiNET.RenderedProtein.transitionTime)}var n=this,q=d3.ease("cubic-in-out");d3.timer(function(b){return a(b/CLMS.xiNET.RenderedProtein.transitionTime)});d3.select(this.ticks).attr("opacity",0);this.setScaleGroup();d3.select(this.ticks).transition().attr("opacity",1).delay(.8*CLMS.xiNET.RenderedProtein.transitionTime).duration(CLMS.xiNET.RenderedProtein.transitionTime/2)};
CLMS.xiNET.RenderedProtein.prototype.getAggregateSelfLinkPath=function(){var a=this.getBlobRadius()+7,c=CLMS.xiNET.RenderedProtein.trig(a,70),b=CLMS.xiNET.RenderedProtein.trig(a,20),d=CLMS.xiNET.RenderedProtein.trig(a,85),e=CLMS.xiNET.RenderedProtein.trig(a,5);return"M 0,0 Q "+d.x+","+-d.y+" "+c.x+","+-c.y+" A "+a+" "+a+" 0 0 1 "+b.x+","+-b.y+" Q "+e.x+","+-e.y+" 0,0"};
CLMS.xiNET.RenderedProtein.prototype.getCrossLinkPath=function(a){var c=this.getResXwithStickZoom(a.crossLink.fromResidue),b=0;8<=CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom&&(b=-5);if(isNaN(parseFloat(a.crossLink.toResidue))){!1===a.ambig&&a.line.setAttribute("fill",xiNET.defaultSelfLinkColour.toRGB());var d=[c,26],e=[c,18],f=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint(d,e,60);return"M "+c+","+-1*b+" L "+d[0]+","+d[1]+" L "+f[0]+","+f[1]+" L "+e[0]+","+e[1]}var d=this.getResXwithStickZoom(a.crossLink.toResidue),
g,h,f=Math.abs(d-c)/2,e=-(CLMS.xiNET.RenderedProtein.STICKHEIGHT/2+3);15>f&&(e=-28+f);var k=[c,b],l=[d,b];!0===a.intraMolecular?(g=c+(d-c)/2,b=[g,e-f],h=[g,e-f],a=[g,e-f],g=[g,e-f]):a.hd?(g=c+(d-c)/2,b=[g,e-f],h=[g,e-f],a=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint([c,e-f],k,-20),g=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint([d,e-f],l,20)):(a=[c,e],g=[d,b],b=[c,e],h=[d,e]);return" M "+k[0]+","+k[1]+" Q "+a[0]+","+a[1]+" "+b[0]+","+b[1]+" A "+f+","+f+"  0 0 1 "+h[0]+","+h[1]+" Q "+g[0]+","+
g[1]+" "+l[0]+","+l[1]};
CLMS.xiNET.RenderedProtein.prototype.showPeptides=function(a){if(1===this.form)for(var c=-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,b=a.length,d=CLMS.xiNET.RenderedProtein.STICKHEIGHT/b,e=0;e<b;e++){var f=a[e],g=document.createElementNS(CLMS.xiNET.svgns,"rect");g.setAttribute("class","protein");var h=f[1];if(0<h){var k=(f[0]+.5-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,h=h*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE;g.setAttribute("x",k);g.setAttribute("y",c);g.setAttribute("width",
h);g.setAttribute("height",d);g.setAttribute("fill",CLMS.xiNET.highlightColour.toRGB());this.peptides.appendChild(g)}f[2]&&(g=document.createElementNS(CLMS.xiNET.svgns,"rect"),g.setAttribute("class","protein"),k=(f[2]+.5-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,h=(f[3]-f[2])*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,g.setAttribute("x",k),g.setAttribute("y",c),g.setAttribute("width",h),g.setAttribute("height",d),g.setAttribute("fill",xiNET.homodimerLinkColour.toRGB()),
g.setAttribute("fill-opacity","0.5"),this.peptides.appendChild(g));c+=d}};CLMS.xiNET.RenderedProtein.prototype.removePeptides=function(){d3.select(this.peptides).selectAll("*").remove()};CLMS.xiNET.RenderedProtein.prototype.getResXwithStickZoom=function(a){return(a-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom};
CLMS.xiNET.RenderedProtein.rotatePointAboutPoint=function(a,c,b){b=b/360*Math.PI*2;return[Math.cos(b)*(a[0]-c[0])-Math.sin(b)*(a[1]-c[1])+c[0],Math.sin(b)*(a[0]-c[0])+Math.cos(b)*(a[1]-c[1])+c[1]]};CLMS.xiNET.RenderedProtein.prototype.checkLinks=function(){for(var a=this.proteinLinks.values(),c=a.length,b=0;b<c;b++)a[b].check()};
CLMS.xiNET.RenderedProtein.prototype.setAllLineCoordinates=function(){for(var a=this.proteinLinks.values(),c=a.length,b=0;b<c;b++){var d=a[b];if(null!==d.getToProtein()&&0===d.getFromProtein().form&&0===d.getToProtein().form)d.setLineCoordinates(this);else for(var d=d.residueLinks.values(),e=d.length,f=0;f<e;f++){var g=d[f];g.setLineCoordinates(this);var h=g.proteinLink.getOtherEnd(this);h&&1===h.form&&8<h.stickZoom*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE&&g.setLineCoordinates(h)}}};
CLMS.xiNET.RenderedProtein.prototype.clearPositionalFeatures=function(a){this.annotations=[];this.circDomains&&d3.select(this.circDomains).selectAll("*").remove();this.rectDomains&&d3.select(this.rectDomains).selectAll("*").remove()};
CLMS.xiNET.RenderedProtein.prototype.setPositionalFeatures=function(a){this.clearPositionalFeatures();if(a){a.sort(function(a,b){return b.end-b.start-(a.end-a.start)});this.annotations=a;for(var c=0;c<a.length;c++){var b=a[c];b.start-=0;b.end-=0;b.pieSlice=document.createElementNS(CLMS.xiNET.svgns,"path");b.colouredRect=document.createElementNS(CLMS.xiNET.svgns,"path");0===this.form?(b.pieSlice.setAttribute("d",this.getAnnotationPieSliceArcPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationPieSliceApproximatePath(b))):
(b.pieSlice.setAttribute("d",this.getAnnotationRectPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationRectPath(b)));b.pieSlice.setAttribute("stroke-width",1);b.pieSlice.setAttribute("fill-opacity","0.5");b.colouredRect.setAttribute("stroke-width",1);b.colouredRect.setAttribute("fill-opacity","0.5");b.pieSlice.name=b.name+" ["+b.start+" - "+b.end+"]";var d=this.crosslinkViewer,e=this;b.pieSlice.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:
a.target;d.preventDefaultsAndStopPropagation(a);d.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};b.colouredRect.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;d.preventDefaultsAndStopPropagation(a);d.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};this.circDomains.appendChild(b.pieSlice);this.rectDomains.appendChild(b.colouredRect)}}};
CLMS.xiNET.RenderedProtein.trig=function(a,c){var b=c/360*Math.PI*2;return{x:a*Math.cos(b),y:a*Math.sin(b)}};CLMS.xiNET.RenderedProtein.prototype.getAnnotationPieSliceArcPath=function(a){var c=(a.start-1)/this.interactor.size*360;a=a.end/this.interactor.size*360;var b=this.getBlobRadius()-2,d=CLMS.xiNET.RenderedProtein.trig(b,c-90),e=CLMS.xiNET.RenderedProtein.trig(b,a-90),f=0;if(180<a-c||a==c)f=1;return"M0,0 L"+d.x+","+d.y+" A"+b+","+b+" 0 "+f+" 1 "+e.x+","+e.y+" Z"};
CLMS.xiNET.RenderedProtein.prototype.getAnnotationPieSliceApproximatePath=function(a){var c=(a.start-1)/this.interactor.size*360;a=a.end/this.interactor.size*360;var b=this.getBlobRadius()-2;CLMS.xiNET.RenderedProtein.trig(b,c-90);CLMS.xiNET.RenderedProtein.trig(b,a-90);for(var d="M 0,0",e=0;e<=CLMS.xiNET.RenderedProtein.stepsInArc;e++)var f=CLMS.xiNET.RenderedProtein.trig(b,c+e/5*(a-c)-90),d=d+(" L "+f.x+","+f.y);return d+=" L 0,0  Z"};
CLMS.xiNET.RenderedProtein.prototype.getAnnotationRectPath=function(a){var c=CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,b=-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,d=this.getResXwithStickZoom(a.start-.5);a=(1+(a.end-a.start))*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom;for(var e="M "+d+","+c,f=0;f<=CLMS.xiNET.RenderedProtein.stepsInArc;f++)e+=" L "+(d+f/CLMS.xiNET.RenderedProtein.stepsInArc*a)+","+b;return e+(" L "+(d+a)+","+c+" Z")};CLMS.xiNET.RenderedProtein.STICKHEIGHT=20;
CLMS.xiNET.RenderedProtein.MAXSIZE=100;CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=1;CLMS.xiNET.RenderedProtein.LABELMAXLENGTH=60;CLMS.xiNET.RenderedProtein.labelY=-5;CLMS.xiNET.RenderedProtein.domainColours=d3.scale.ordinal().range(colorbrewer.Paired[5]);CLMS.xiNET.RenderedProtein.transitionTime=650;CLMS.xiNET.RenderedProtein.stepsInArc=5;CLMS.xiNET.RenderedProteinLink=function(a,c,b,d){this.id=a;this.residueLinks=d3.map();this.controller=d;this.fromProtein=c;this.toProtein=b;this.ambig=!1;this.tooltip=this.id;this.hidden=this.shown=!1;this.selfLink()?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path"),this.fatLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.highlightLine=document.createElementNS(xiNET.svgns,
"line"),this.fatLine=document.createElementNS(xiNET.svgns,"line"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","black");this.line.setAttribute("stroke-width",1);this.line.setAttribute("stroke-linecap","round");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-linecap",
"round");this.highlightLine.setAttribute("stroke-opacity","0");this.fatLine.setAttribute("class","link");this.fatLine.setAttribute("fill","none");this.fatLine.setAttribute("stroke","lightgray");this.fatLine.setAttribute("stroke-linecap","round");this.fatLine.setAttribute("stroke-linejoin","round");var e=this;this.line.onmousedown=function(a){e.mouseDown(a)};this.line.onmouseover=function(a){e.mouseOver(a)};this.line.onmouseout=function(a){e.mouseOut(a)};this.line.ontouchstart=function(a){e.touchStart(a)};
this.highlightLine.onmousedown=function(a){e.mouseDown(a)};this.highlightLine.onmouseover=function(a){e.mouseOver(a)};this.highlightLine.onmouseout=function(a){e.mouseOut(a)};this.highlightLine.ontouchstart=function(a){e.touchStart(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmouseover=function(a){e.mouseOver(a)};this.fatLine.onmouseout=function(a){e.mouseOut(a)};this.fatLine.ontouchstart=function(a){e.touchStart(a)};
this.isSelected=!1};CLMS.xiNET.RenderedProteinLink.maxNoCrossLinks=0;CLMS.xiNET.RenderedProteinLink.prototype=new CLMS.xiNET.RenderedLink;CLMS.xiNET.RenderedProteinLink.prototype.selfLink=function(){return this.fromProtein===this.toProtein};CLMS.xiNET.RenderedProteinLink.prototype.initSelfLinkSVG=function(){var a=this.fromProtein.getAggregateSelfLinkPath();this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.fatLine.setAttribute("d",a)};
CLMS.xiNET.RenderedProteinLink.prototype.getFromProtein=function(){return this.fromProtein};CLMS.xiNET.RenderedProteinLink.prototype.getToProtein=function(){return this.toProtein};
CLMS.xiNET.RenderedProteinLink.prototype.showHighlight=function(a,c){"undefined"===typeof c&&(c=!1);this.shown&&(a?(this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1")):(this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0")));if(c&&this.ambig)for(var b=this.residueLinks.values().length,d=0;d<b;d++)for(var e=this.residueLinks.values()[d],
f=e.matches.length,g=0;g<f;g++){var h=e.matches[g][0];if(h.isAmbig())for(var k=h.residueLinks.length,l=0;l<k;l++)e=h.residueLinks[l],!0===e.shown&&0==e.isSelected&&e.showHighlight(a,!1),!0===e.proteinLink.shown&&e.proteinLink.showHighlight(a,!1)}};
CLMS.xiNET.RenderedProteinLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",
CLMS.xiNET.highlightColour.toRGB()),this.controller.linkSelectionChanged())};CLMS.xiNET.RenderedProteinLink.prototype.getFilteredMatches=function(){for(var a=this.residueLinks.values(),c=a.length,b=d3.map(),d=0;d<c;d++)for(var e=a[d],f=e.matches.length,g=0;g<f;g++){var h=e.matches[g];h.meetsFilterCriteria()&&b.set(h.id)}return b.keys()};
CLMS.xiNET.RenderedProteinLink.prototype.check=function(){if(this.fromProtein.isParked||null!==this.toProtein&&this.toProtein.isParked)return this.hide(),!1;if(this.selfLink()&&!1===this.controller.selfLinksShown){if(0===this.fromProtein.form)this.hide();else for(var a=this.residueLinks.values(),c=a.length,b=0;b<c;b++)a[b].hide();return!1}if(this.hidden){if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form)this.hide();else for(a=this.residueLinks.values(),c=a.length,b=0;b<
c;b++)a[b].hide();return!1}a=this.residueLinks.values();c=a.length;this.hd=!1;if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form){this.ambig=!0;for(var d=[],e=d3.map(),f=d3.map(),b=0;b<c;b++){var g=a[b],h=!1;if(g.matches)for(var k=g.matches.length,l=0;l<k;l++){var p=g.matches[l][0];if(p.meetsFilterCriteria())if(!0===p.hd&&(this.hd=!0),!1===h&&(h=!0,d.push(g)),e.set(p.id,p),p.isAmbig())for(var n=0;n<p.residueLinks.length;n++)f.set(p.residueLinks[n].proteinLink.id);else this.ambig=
!1}else d.push(g)}b=d.length;if(0<b){this.tooltip=this.id+", "+b+" unique cross-link";1<b&&(this.tooltip+="s");this.tooltip+=" ("+e.keys().length;1===e.keys().length?this.tooltip+=" match)":this.tooltip+=" matches)";this.w=45/CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks*b;this.ambig=this.ambig&&1<altCLMS.xiNET.RenderedProteinLinks.keys().length;this.dashedLine(this.ambig);if(1<this.controller.groups.values().length&&5>this.controller.groups.values().length){a=d3.set();c=e.values();
e=c.length;for(b=0;b<e;b++)p=c[b],a.add(p.group);1==a.values().length?(b=this.controller.linkColours(a.values()[0]),this.line.setAttribute("stroke",b)):this.line.setAttribute("stroke","#000000")}else this.selfLink()&&(this.hd?(this.line.setAttribute("stroke",xiNET.homodimerLinkColour.toRGB()),this.line.setAttribute("stroke-width",xiNET.homodimerLinkWidth)):(this.line.setAttribute("stroke","black"),this.line.setAttribute("stroke-width",1)));this.show();return!0}this.hide();return!1}if(null!==this.toProtein||
0!==this.fromProtein.form){b=!1;for(p=0;p<c;p++)!0===a[p].check()&&(b=!0);return b}};CLMS.xiNET.RenderedProteinLink.prototype.dashedLine=function(a){1==this.controller.unambigLinkFound&&(a?!0===this.selfLink()?this.line.setAttribute("stroke-dasharray","4, 4"):this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z):a||this.line.removeAttribute("stroke-dasharray"))};
CLMS.xiNET.RenderedProteinLink.prototype.show=function(){this.shown||(this.shown=!0,this.selfLink()?(1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&(this.fatLine.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.controller.p_pLinksWide.appendChild(this.fatLine)),this.line.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.highlightLine.setAttribute("transform",
"translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")")):(this.line.setAttribute("stroke-width",1*this.controller.z),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.fromProtein),this.setLineCoordinates(this.toProtein),1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&this.controller.p_pLinksWide.appendChild(this.fatLine)),this.controller.highlights.appendChild(this.highlightLine),this.controller.p_pLinks.appendChild(this.line));
1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&(this.selfLink()?this.fatLine.setAttribute("stroke-width",this.w):this.fatLine.setAttribute("stroke-width",this.controller.z*this.w))};CLMS.xiNET.RenderedProteinLink.prototype.hide=function(){this.shown&&(this.shown=!1,this.selfLink(),1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&this.controller.p_pLinksWide.removeChild(this.fatLine),this.controller.highlights.removeChild(this.highlightLine),this.controller.p_pLinks.removeChild(this.line))};
CLMS.xiNET.RenderedProteinLink.prototype.setLineCoordinates=function(a){!1===this.selfLink()&&null!==this.getToProtein()&&this.shown&&(this.getFromProtein()===a?(this.line.setAttribute("x1",a.x),this.line.setAttribute("y1",a.y),this.highlightLine.setAttribute("x1",a.x),this.highlightLine.setAttribute("y1",a.y),this.fatLine.setAttribute("x1",a.x),this.fatLine.setAttribute("y1",a.y)):this.getToProtein()===a&&(this.line.setAttribute("x2",a.x),this.line.setAttribute("y2",a.y),this.highlightLine.setAttribute("x2",
a.x),this.highlightLine.setAttribute("y2",a.y),this.fatLine.setAttribute("x2",a.x),this.fatLine.setAttribute("y2",a.y)))};CLMS.xiNET.RenderedProteinLink.prototype.getOtherEnd=function(a){return this.fromProtein===a?this.toProtein:this.fromProtein};CLMS.xiNET.RenderedCrossLink=function(a,c){this.crossLink=a;this.crosslinkViewer=c;this.renderedFromProtein=this.crosslinkViewer.renderedProteins.get(this.crossLink.getFromProtein().id);this.renderedToProtein=this.crosslinkViewer.renderedProteins.get(this.crossLink.getToProtein().id);this.tooltip=this.crossLink.id;this.dashed=this.shown=!1;this.initSVG()};CLMS.xiNET.RenderedCrossLink.prototype=new CLMS.xiNET.RenderedLink;
CLMS.xiNET.RenderedCrossLink.prototype.initSVG=function(){if("undefined"===typeof this.line){!0===this.crossLink.isSelfLink()||null===this.crossLink.getToProtein()?(this.line=document.createElementNS(CLMS.xiNET.svgns,"path"),this.highlightLine=document.createElementNS(CLMS.xiNET.svgns,"path")):(this.line=document.createElementNS(CLMS.xiNET.svgns,"line"),this.line.setAttribute("stroke",CLMS.xiNET.defaultInterLinkColour.toRGB()),this.line.setAttribute("stroke-linecap","round"),this.highlightLine=document.createElementNS(CLMS.xiNET.svgns,
"line"),this.highlightLine.setAttribute("stroke-linecap","round"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","#000000");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-opacity","0");"undefined"!==typeof this.colour&&this.line.setAttribute("stroke",
this.colour);var a=this;this.line.onmousedown=function(c){a.mouseDown(c)};this.line.onmouseover=function(c){a.mouseOver(c)};this.line.onmouseout=function(c){a.mouseOut(c)};this.line.ontouchstart=function(c){a.touchStart(c)};this.highlightLine.onmousedown=function(c){a.mouseDown(c)};this.highlightLine.onmouseover=function(c){a.mouseOver(c)};this.highlightLine.onmouseout=function(c){a.mouseOut(c)};this.highlightLine.ontouchstart=function(c){a.touchStart(c)}}this.isSelected=!1};
CLMS.xiNET.RenderedCrossLink.prototype.showHighlight=function(a,c){if(!(this.renderedFromProtein.busy||this.renderedToProtein&&this.renderedToProtein.busy)&&this.shown)if(a){this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-opacity","0.7");for(var b=[],d=[],e=this.crossLink.filteredMatches,f=e.length,g=0;g<f;g++){var h=e[g][0],k=e[g][3]-1,l=e[g][4];b.push([e[g][1]-1,e[g][2],h.overlap[0],h.overlap[1]]);d.push([k,l,h.overlap[0],h.overlap[1]])}this.renderedFromProtein.showPeptides(b);
this.renderedToProtein&&this.renderedToProtein.showPeptides(d)}else this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0"),this.renderedFromProtein.removePeptides(),this.renderedToProtein&&this.renderedToProtein.removePeptides()};
CLMS.xiNET.RenderedCrossLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.crosslinkViewer.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","0.7")):!1===a&&!0===this.isSelected&&(this.crosslinkViewer.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB()))};
CLMS.xiNET.RenderedCrossLink.prototype.check=function(a){if(0<this.crossLink.filteredMatches.length)return this.show(),!0;this.hide();return!1};
CLMS.xiNET.RenderedCrossLink.prototype.dashedLine=function(a){1!=this.crosslinkViewer.unambigLinkFound||"undefined"===typeof this.line||isNaN(parseFloat(this.toResidue))||(a?!0===this.selfLink()?(this.dashed=!0,this.line.setAttribute("stroke-dasharray","4, 4")):(this.dashed=!0,this.line.setAttribute("stroke-dasharray",4*this.crosslinkViewer.z+", "+4*this.crosslinkViewer.z)):a||(this.dashed=!1,this.line.removeAttribute("stroke-dasharray")))};
CLMS.xiNET.RenderedCrossLink.prototype.show=function(){if(!this.shown)if(this.shown=!0,"undefined"===typeof this.line&&this.initSVG(),this.crossLink.isSelfLink()||!this.renderedToProtein){var a=this.renderedToProtein.getCrossLinkPath(this);this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.renderedFromProtein.selfLinksHighlights.appendChild(this.highlightLine);this.renderedFromProtein.selfLinks.appendChild(this.line)}else this.line.setAttribute("stroke-width",this.crosslinkViewer.z*
CLMS.xiNET.linkWidth),this.highlightLine.setAttribute("stroke-width",10*this.crosslinkViewer.z),this.setLineCoordinates(this.renderedFromProtein),this.setLineCoordinates(this.renderedToProtein),this.crosslinkViewer.highlights.appendChild(this.highlightLine),this.crosslinkViewer.res_resLinks.appendChild(this.line)};
CLMS.xiNET.RenderedCrossLink.prototype.hide=function(){this.shown&&(this.shown=!1,this.crossLink.isSelfLink()||!this.renderedToProtein?(this.renderedFromProtein.selfLinksHighlights.removeChild(this.highlightLine),this.renderedFromProtein.selfLinks.removeChild(this.line)):(this.crosslinkViewer.res_resLinks.removeChild(this.line),this.crosslinkViewer.highlights.removeChild(this.highlightLine)))};
CLMS.xiNET.RenderedCrossLink.prototype.setLineCoordinates=function(a){if((this.crossLink.isSelfLink()||!this.renderedToProtein)&&this.shown){var c;this.renderedFromProtein===a?(0===a.form?(a=interactor.x,c=interactor.y):(c=this.getResidueCoordinates(this.fromResidue,a),a=c[0],c=c[1]),this.line.setAttribute("x1",a),this.line.setAttribute("y1",c),this.highlightLine.setAttribute("x1",a),this.highlightLine.setAttribute("y1",c)):this.renderedToProtein===a&&(0===a.form?(a=interactor.x,c=interactor.y):(c=
this.getResidueCoordinates(this.toResidue,a),a=c[0],c=c[1]),this.line.setAttribute("x2",a),this.line.setAttribute("y2",c),this.highlightLine.setAttribute("x2",a),this.highlightLine.setAttribute("y2",c))}};
CLMS.xiNET.RenderedCrossLink.prototype.getResidueCoordinates=function(a,c){var b=c.getResXwithStickZoom(a)*this.crosslinkViewer.z,d=0;if(8<CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*c.stickZoom){var d=this.renderedFromProtein,e=this.renderedToProtein,f=Math.atan2(d.y-e.y,d.x-e.x)/(2*Math.PI)*360;0>f&&(f+=360);c===d?(d=f-d.rotation,0>d&&(d+=360),e=5,180>d&&(e=-5)):(d=f-e.rotation,0>d&&(d+=360),e=5,180<d&&(e=-5));d=e*this.crosslinkViewer.z}d=Protein.rotatePointAboutPoint([b,d],[0,0],c.rotation);b=
d[0]+interactor.x;d=d[1]+interactor.y;return[b,d]};CLMS.xiNET.RenderedCrossLink.prototype.leastAmbiguousMatches=function(){};CLMS.xiNET.RenderedCrossLink.prototype.toJSON=function(){for(var a=[],c=this.matches.length,b=0;b<c;b++)a.push(this.matches[b].id);return{}};CLMS.xiNET.Rotator=function(a,c,b){var d=this;this.ctrl=b;this.proteinOrPartThereof=a;this.upperOrLower=c;this.svg=document.createElementNS(CLMS.xiNET.svgns,"g");this.rotatorSymbol=document.createElementNS(CLMS.xiNET.svgns,"g");a=document.createElementNS(CLMS.xiNET.svgns,"circle");a.setAttribute("r",14);a.setAttribute("stroke","none");a.setAttribute("fill","gray");a.setAttribute("fill-opacity","0.0");this.svg.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"circle");a.setAttribute("r",
20);a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","none");this.rotatorSymbol.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");this.rotatorSymbol.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");
a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");a.setAttribute("transform","rotate(180)");this.rotatorSymbol.appendChild(a);this.rotatorSymbol.setAttribute("transform","rotate(45) scale (0.7, 0.7)");this.rotatorSymbol.setAttribute("display","none");this.inner=document.createElementNS(CLMS.xiNET.svgns,"g");this.inner.setAttribute("class","PV_rotator");this.inner.appendChild(this.rotatorSymbol);this.svg.appendChild(this.inner);this.svg.onmouseover=
function(a){d.rotatorMouseOver(a)};this.svg.onmouseout=function(a){d.rotatorMouseOut(a)};this.svg.onmousedown=function(a){d.rotatorMouseDown(a)}};CLMS.xiNET.Rotator.prototype.rotatorMouseOver=function(a){this.ctrl.rotating||this.rotatorSymbol.setAttribute("display","block")};CLMS.xiNET.Rotator.prototype.rotatorMouseOut=function(a){this.rotatorSymbol.setAttribute("display","none")};
CLMS.xiNET.Rotator.prototype.rotatorMouseDown=function(a){this.ctrl.state=CLMS.xiNET.Controller.ROTATING;this.ctrl.dragElement=this.proteinOrPartThereof;a=this.ctrl.getEventPoint(a);this.ctrl.mouseToSVG(a.x,a.y);this.ctrl.whichCLMS.xiNET.Rotator=this.upperOrLower;return!1};
