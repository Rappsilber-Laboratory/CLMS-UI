'use strict';var $jscomp={scope:{},global:this},Symbol;$jscomp.initSymbol=function(){$jscomp.global.Symbol||(Symbol=$jscomp.Symbol);$jscomp.initSymbol=function(){}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return"jscomp_symbol_"+a+$jscomp.symbolCounter_++};$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();Symbol.iterator||(Symbol.iterator=Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();if(a[Symbol.iterator])return a[Symbol.iterator]();if(!(a instanceof Array||"string"==typeof a||a instanceof String))throw new TypeError(a+" is not iterable");var d=0;return{next:function(){return d==a.length?{done:!0}:{done:!1,value:a[d++]}}}};$jscomp.arrayFromIterator=function(a){for(var d,b=[];!(d=a.next()).done;)b.push(d.value);return b};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.arrayFromArguments=function(a){for(var d=[],b=0;b<a.length;b++)d.push(a[b]);return d};$jscomp.inherits=function(a,d){function b(){}b.prototype=d.prototype;a.prototype=new b;a.prototype.constructor=a;for(var c in d)if($jscomp.global.Object.defineProperties){var e=$jscomp.global.Object.getOwnPropertyDescriptor(d,c);void 0!==e&&$jscomp.global.Object.defineProperty(a,c,e)}else a[c]=d[c]};
(function(a){a.CLMS=a.CLMS||{};a.CLMS.xiNET={};a.CLMS.xiNET.CrosslinkViewer=Backbone.View.extend({tagName:"div",events:{"click .downloadButton":"downloadSVG"},initialize:function(a){this.options=_.extend({},a.myOptions);this.displayEventName=a.displayEventName;var b=this,c=d3.select(this.el);c.selectAll("*").remove();var e=document.createElementNS("http://www.w3.org/1999/xhtml","div");e.setAttribute("style","width:100%;height:100%;display:block;");c.node().appendChild(e);this.svgElement=document.createElementNS(CLMS.xiNET.svgns,
"svg");this.svgElement.setAttribute("id","networkSVG");this.svgElement.setAttribute("width","100%");this.svgElement.setAttribute("height","100%");this.svgElement.oncontextmenu=function(){return!1};b=this;this.svgElement.onmousedown=function(a){b.mouseDown(a)};this.svgElement.onmousemove=function(a){b.mouseMove(a)};this.svgElement.onmouseup=function(a){b.mouseUp(a)};this.svgElement.onmouseout=function(a){b.hideTooltip(a)};c=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";document.attachEvent?
this.svgElement.attachEvent("on"+c,function(a){b.mouseWheel(a)}):document.addEventListener&&this.svgElement.addEventListener(c,function(a){b.mouseWheel(a)},!1);this.lastMouseUp=(new Date).getTime();this.svgElement.ontouchstart=function(a){b.touchStart(a)};this.svgElement.ontouchmove=function(a){b.touchMove(a)};this.svgElement.ontouchend=function(a){b.touchEnd(a)};this.linkSelectionCallbacks=[];this.linkHighlightsCallbacks=[];this.legendCallbacks=[];e.appendChild(this.svgElement);this.ambigShown=this.selfLinksShown=
!0;e=document.createElementNS(CLMS.xiNET.svgns,"rect");e.setAttribute("id","background_fill");e.setAttribute("x",0);e.setAttribute("y",0);e.setAttribute("width",5120);e.setAttribute("height",4096);e.setAttribute("fill-opacity","1");e.setAttribute("fill","#FFFFFF");this.svgElement.appendChild(e);this.container=document.createElementNS(CLMS.xiNET.svgns,"g");this.container.setAttribute("id","container");this.p_pLinksWide=document.createElementNS(CLMS.xiNET.svgns,"g");this.p_pLinksWide.setAttribute("id",
"p_pLinksWide");this.container.appendChild(this.p_pLinksWide);this.proteinLower=document.createElementNS(CLMS.xiNET.svgns,"g");this.proteinLower.setAttribute("id","proteinLower");this.container.appendChild(this.proteinLower);this.highlights=document.createElementNS(CLMS.xiNET.svgns,"g");this.highlights.setAttribute("class","highlights");this.container.appendChild(this.highlights);this.res_resLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.res_resLinks.setAttribute("id","res_resLinks");this.container.appendChild(this.res_resLinks);
this.p_pLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.p_pLinks.setAttribute("id","p_pLinks");this.container.appendChild(this.p_pLinks);this.proteinUpper=document.createElementNS(CLMS.xiNET.svgns,"g");this.proteinUpper.setAttribute("id","proteinUpper");this.container.appendChild(this.proteinUpper);this.svgElement.appendChild(this.container);this.tooltip=document.createElementNS(CLMS.xiNET.svgns,"text");this.tooltip.setAttribute("x",0);this.tooltip.setAttribute("y",0);e=document.createTextNode("tooltip");
this.tooltip.appendChild(e);this.tooltip_bg=document.createElementNS(CLMS.xiNET.svgns,"rect");this.tooltip_bg.setAttribute("class","tooltip_bg");this.tooltip_bg.setAttribute("fill-opacity",.75);this.tooltip_bg.setAttribute("stroke-opacity",1);this.tooltip_bg.setAttribute("stroke-width",1);this.tooltip_subBg=document.createElementNS(CLMS.xiNET.svgns,"rect");this.tooltip_subBg.setAttribute("fill","white");this.tooltip_subBg.setAttribute("stroke","white");this.tooltip_subBg.setAttribute("class","tooltip_bg");
this.tooltip_subBg.setAttribute("opacity",1);this.tooltip_subBg.setAttribute("stroke-width",1);this.svgElement.appendChild(this.tooltip_subBg);this.svgElement.appendChild(this.tooltip_bg);this.svgElement.appendChild(this.tooltip);this.clear();this.initProteins();this.initLayout();e=this.model.get("clmsModel").get("crossLinks").values();e=$jscomp.makeIterator(e);for(c=e.next();!c.done;c=e.next()){var c=c.value,f=new CLMS.xiNET.RenderedCrossLink(c,this);this.residueLinks.set(c.id,f)}this.listenTo(this.model.get("filterModel"),
"change",this.render);this.listenTo(this.model.get("rangeModel"),"change:scale",this.relayout);a.displayEventName&&this.listenTo(CLMSUI.vent,a.displayEventName,this.setVisible)},clear:function(){this.sequenceInitComplete=!1;this.force&&this.force.stop();this.force=null;d3.select(this.p_pLinksWide).selectAll("*").remove();d3.select(this.highlights).selectAll("*").remove();d3.select(this.p_pLinks).selectAll("*").remove();d3.select(this.res_resLinks).selectAll("*").remove();d3.select(this.proteinLower).selectAll("*").remove();
d3.select(this.proteinUpper).selectAll("*").remove();this.panning=!1;this.dragElement=null;this.dragging=!1;this.dragStart={};this.rotating=!1;this.renderedProteins=d3.map();this.residueLinks=d3.map();this.matches=[];this.groups=d3.set();this.subgraphs=[];this.proteinCount=this.layoutXOffset=0;this.unambigLinkFound=!1;this.maxBlobRadius=30;this.layout=null;this.z=1;this.scores=null;this.selectedLinks=d3.map();this.hideTooltip();this.resetZoom();this.state=CLMS.xiNET.Controller.MOUSE_UP},checkLinks:function(){for(var a=
this.residueLinks.values(),b=a.length,c=0;c<b;c++)a[c].check()},initLayout:function(){var a=this.renderedProteins.values(),b=a.length;CLMS.xiNET.RenderedProtein.MAXSIZE=400;for(var c=0;c<b;c++){var e=a[c].size;e>CLMS.xiNET.RenderedProtein.MAXSIZE&&(console.log("MX:"+CLMS.xiNET.RenderedProtein.MAXSIZE),CLMS.xiNET.RenderedProtein.MAXSIZE=e)}CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-CLMS.xiNET.RenderedProtein.LABELMAXLENGTH)/CLMS.xiNET.RenderedProtein.MAXSIZE;
a=this.groups.values().length;if(1<a&&5>a){this.groups.values();this.linkColours=d3.scale.ordinal().range(colorbrewer.Dark2[5]);b=this.groups.values();for(c=0;c<a;c++)this.linkColours(b[c]);this.legendChanged()}if("undefined"!==typeof this.layout&&null!=this.layout)this.loadLayout();else{a=this.renderedProteins.values();b=a.length;for(c=0;c<b;c++)e=a[c],this.proteinLower.appendChild(e.lowerGroup),this.proteinUpper.appendChild(e.upperGroup);this.autoLayout()}},initProteins:function(){var a=this.model.get("clmsModel").get("interactors").values();
CLMS.xiNET.RenderedProtein.MAXSIZE=0;for(var a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next()){var b=b.value,c=new CLMS.xiNET.RenderedProtein(b,this);this.renderedProteins.set(b.id,c);b=b.size;b>CLMS.xiNET.RenderedProtein.MAXSIZE&&(CLMS.xiNET.RenderedProtein.MAXSIZE=b)}CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=(this.svgElement.parentNode.clientWidth/2-CLMS.xiNET.RenderedProtein.LABELMAXLENGTH)/CLMS.xiNET.RenderedProtein.MAXSIZE;a=this.renderedProteins.values();b=a.length;for(c=0;c<b;c++)a[c].init();
this.sequenceInitComplete=!0;this.annotationSet?this.setAnnotations(this.annotationSet):this.setAnnotations("CUSTOM")},reset:function(){this.resetZoom();for(var a=this.renderedProteins.values(),b=a.length,c=0;c<b;c++){var e=a[c];!1===e.isParked&&e.setForm(0)}this.autoLayout()},resetZoom:function(){this.container.setAttribute("transform","scale(1)");this.scale()},scale:function(){},setAnnotations:function(a){function b(){var a=d3.set();for(f=0;f<e;f++)for(var b=c[f],d=0;d<b.annotations.length;d++)a.add(b.annotations[d].name);
b=a.values().length;3>b&&(b=3);9>b?(b=colorbrewer.Accent[b].slice().reverse(),g.domainColours=d3.scale.ordinal().range(b)):13>b?(b=colorbrewer.Set3[b].slice().reverse(),g.domainColours=d3.scale.ordinal().range(b)):g.domainColours=d3.scale.category20();for(f=0;f<e;f++)for(b=c[f],d=0;d<b.annotations.length;d++){var a=b.annotations[d],h=g.domainColours(a.name);a.pieSlice.setAttribute("fill",h);a.pieSlice.setAttribute("stroke",h);a.colouredRect.setAttribute("fill",h);a.colouredRect.setAttribute("stroke",
h)}g.legendChanged()}this.annotationChoice=a;for(var c=this.renderedProteins.values(),e=c.length,f=0;f<e;f++)c[f].clearPositionalFeatures();this.domainColours=null;this.legendChanged();if(this.sequenceInitComplete){var g=this;if("CUSTOM"===a.toUpperCase()){for(f=0;f<e;f++)a=c[f],a.setPositionalFeatures(a.customAnnotations);b()}else if("LYSINES"===a.toUpperCase()){for(f=0;f<e;f++){a=c[f];for(var l=a.sequence,h=[],k=0;k<a.size;k++)"K"===l[k]&&h.push(new Annotation("Lysine",k+1,k+1));a.setPositionalFeatures(h)}b()}else if("SUPERFAM"===
a.toUpperCase()||"SUPERFAMILY"===a.toUpperCase())for(var n=0,f=0;f<e;f++)a=c[f],this.xiNET_storage.getSuperFamFeatures(a.id,function(a,d){g.proteins.get(a).setPositionalFeatures(d);n++;n===e&&b()});else if("UNIPROT"===a.toUpperCase()||"UNIPROTKB"===a.toUpperCase())for(f=n=0;f<e;f++)a=c[f],this.xiNET_storage.getUniProtFeatures(a.id,function(a,d){var c=g.proteins.get(a);if(-1===c.accession.indexOf("-")||"P02768-A"===c.accession){if("P02768-A"===c.accession)for(var f=0;f<d.length;f++){var h=d[f];h.start+=
-24;h.end+=-24}c.setPositionalFeatures(d)}n++;n===e&&b()})}},legendChanged:function(){for(var a=this.legendCallbacks,b=a.length,c=0;c<b;c++)a[c](this.linkColours,this.domainColours)},setCTM:function(a,b){a.setAttribute("transform","matrix("+b.a+","+b.b+","+b.c+","+b.d+","+b.e+","+b.f+")")},mouseDown:function(a){a.preventDefault();"undefined"!==typeof this.force&&null!=this.force&&this.force.stop();var b=this.getEventPoint(a);this.dragStart=this.mouseToSVG(b.x,b.y);var c;a.which?c=3===a.which:a.button&&
(c=2===a.button);!0===a.ctrlKey||!0===a.shiftKey||c||(this.state=CLMS.xiNET.Controller.PANNING,this.panned=!1);return!1},mouseMove:function(a){var b=this.getEventPoint(a);a=this.mouseToSVG(b.x,b.y);if(null!=this.dragElement){this.hideTooltip();var c=this.dragStart.x-a.x,e=this.dragStart.y-a.y;if(this.state===CLMS.xiNET.Controller.DRAGGING){var f,g;if("undefined"===typeof this.dragElement.x){var l;l=this.dragElement.fromProtein?this.dragElement.fromProtein:this.dragElement.proteinLink.fromProtein;
for(var h=this.renderedProteins.values(),k=h.length,b=0;b<k;b++)h[b].subgraph=null;b=l.getSubgraph().nodes.values();l=b.length;for(h=0;h<l;h++)k=b[h],f=k.x,g=k.y,f-=c,g-=e,k.setPosition(f,g),k.setAllLineCoordinates();for(h=0;h<l;h++)b[h].setAllLineCoordinates()}else f=this.dragElement.x,g=this.dragElement.y,this.dragElement.setPosition(f-c,g-e),this.dragElement.setAllLineCoordinates();this.dragStart=a}else this.state===CLMS.xiNET.Controller.ROTATING?(a=Math.atan2(a.y-this.dragElement.y,a.x-this.dragElement.x),
0===this.whichCLMS.xiNET.Rotator&&(a+=Math.PI),this.dragElement.setRotation(360/(2*Math.PI)*a),this.dragElement.setAllLineCoordinates()):Math.sqrt(c*c+e*e)>5*this.z&&(this.state=CLMS.xiNET.Controller.DRAGGING)}else this.state===CLMS.xiNET.Controller.PANNING?this.setCTM(this.container,this.container.getCTM().translate(a.x-this.dragStart.x,a.y-this.dragStart.y)):this.showTooltip(b);return!1},mouseUp:function(a){var b=(new Date).getTime();this.preventDefaultsAndStopPropagation(a);if(150<b-this.lastMouseUp){var c,
e;a.which?c=3===a.which:a.button&&(c=2===a.button);a.which?e=2===a.which:a.button&&(e=1===a.button);var f=this.getEventPoint(a),f=this.mouseToSVG(f.x,f.y);if(null!=this.dragElement)this.state!==CLMS.xiNET.Controller.DRAGGING&&this.state!==CLMS.xiNET.Controller.ROTATING?c?"undefined"===typeof this.dragElement.x?1==this.dragElement.selfLink()?this.dragElement.proteinLink&&this.dragElement.proteinLink.fromProtein.toggleFlipped():(void 0!==this.dragElement.hidden?this.dragElement.hidden=!0:this.dragElement.proteinLink.hidden=
!0,this.dragElement.highlightLine.setAttribute("stroke-opacity","0"),this.checkLinks()):this.dragElement.setParked(!this.dragElement.isParked,f):e||"undefined"!==typeof this.dragElement.x&&(a.shiftKey?this.dragElement.switchStickScale(f):!0===this.sequenceInitComplete&&(1===this.dragElement.form?this.dragElement.setForm(0,f):this.dragElement.setForm(1,f))):this.state===CLMS.xiNET.Controller.ROTATING&&this.dragElement.setRotation(5*Math.round(this.dragElement.rotation/5));else if(c){a=this.proteinLinks.values();
c=a.length;for(e=0;e<c;e++)a[e].hidden=!1;this.checkLinks()}this.state===CLMS.xiNET.Controller.SELECTING&&(clearInterval(this.marcher),this.svgElement.removeChild(this.marquee))}this.dragElement=null;this.whichRotator=-1;this.state=CLMS.xiNET.Controller.MOUSE_UP;this.lastMouseUp=b;return!1},mouseWheel:function(a){this.preventDefaultsAndStopPropagation(a);var b=1+(a.wheelDelta?a.wheelDelta/3600:a.detail/-90),c=this.container;a=this.getEventPoint(a);a=this.mouseToSVG(a.x,a.y);b=this.svgElement.createSVGMatrix().translate(a.x,
a.y).scale(b).translate(-a.x,-a.y);this.setCTM(c,c.getCTM().multiply(b));this.scale();return!1},getEventPoint:function(a){var b=this.svgElement.createSVGPoint(),c=this.svgElement.parentNode,e=0,f=0;do e+=c.offsetTop||0,f+=c.offsetLeft||0,c=c.offsetParent;while(c);b.x=a.pageX-f;b.y=a.pageY-e;return b},mouseToSVG:function(a,b){var c=this.svgElement.createSVGPoint();c.x=a;c.y=b;return c=c.matrixTransform(this.container.getCTM().inverse())},preventDefaultsAndStopPropagation:function(a){a.stopPropagation&&
a.stopPropagation();null!=a.cancelBubble&&(a.cancelBubble=!0);a.preventDefault&&a.preventDefault()},showTooltip:function(a){var b;b=this.tooltip.getComputedTextLength()+16;var c=this.svgElement.parentNode.clientWidth,e=this.svgElement.parentNode.clientHeight;b=a.x+20+b<c?a.x:c-b-20;a=a.y+60<e?a.y:e-60;this.tooltip.setAttribute("x",b+22);this.tooltip.setAttribute("y",a+47);this.tooltip_bg.setAttribute("x",b+16);this.tooltip_bg.setAttribute("y",a+28);this.tooltip_subBg.setAttribute("x",b+16);this.tooltip_subBg.setAttribute("y",
a+28)},setTooltip:function(a,b){if(a){this.tooltip.firstChild.data=a.toString().replace(/&(quot);/g,'"');this.tooltip.setAttribute("display","block");var c=this.tooltip.getComputedTextLength();this.tooltip_bg.setAttribute("width",c+16);this.tooltip_subBg.setAttribute("width",c+16);"undefined"!==typeof b&&null!=b?(this.tooltip_bg.setAttribute("fill",b),this.tooltip_bg.setAttribute("stroke",b),this.tooltip_bg.setAttribute("fill-opacity","0.5")):(this.tooltip_bg.setAttribute("fill","white"),this.tooltip_bg.setAttribute("stroke",
"grey"));this.tooltip_bg.setAttribute("height",28);this.tooltip_subBg.setAttribute("height",28);this.tooltip_bg.setAttribute("display","block");this.tooltip_subBg.setAttribute("display","block")}else this.hideTooltip()},hideTooltip:function(){this.tooltip.setAttribute("display","none");this.tooltip_bg.setAttribute("display","none");this.tooltip_subBg.setAttribute("display","none")},autoLayout:function(){function a(b){function c(a){d.push(a.id);for(var b=0;b<a.proteinLinks.values().length;b++){var e=
a.proteinLinks.values()[b];if(!0===e.check()&&(e=e.getOtherEnd(a),-1===d.indexOf(e.id))){c(e);break}}}var d=[];c(function(){for(var a=b.nodes.values(),c=a.length,d=0;d<c;d++)if(2>a[d].countExternalLinks())return a[d];console.error("missed linear subgraph start");return null}());return d}function b(a){return a*(60+Protein.LABELMAXLENGTH)-30}this.force&&this.force.stop();for(var c=this.svgElement.parentNode.clientWidth,e=this.svgElement.parentNode.clientHeight,f=this,g=this.renderedProteins.values(),
l=g.length,h=this.subgraphs.length=0;h<l;h++)g[h].interactor.subgraph=null;for(h=0;h<l;h++)g[h].interactor.getSubgraph();this.subgraphs.sort(function(a,b){return a.nodes.values().length-b.nodes.values().length});if(1===l){var k=g[0];k.setPosition(c/2,e/2)}else if(2===l)k=g[0],k.setPosition(c/2,.3*e),k.setAllLineCoordinates(),g=g[1],g.setPosition(c/2,.6*e),g.setAllLineCoordinates();else{for(var n=[],g=[],h=this.subgraphs.length,k=0;k<h;k++){var m=this.subgraphs[k],p=m.nodes.values(),u=p.length,q=!0;
if(1===u)q=!0;else{for(var t=!1,r=0;r<u;r++)if(2<p[r].countExternalLinks()){q=!1;break}else 2>p[r].countExternalLinks()&&(t=!0);t||(q=!1)}!0===q?n.push(m):g.push(m)}var t=q=m=0,v=-1;if(0<n.length)for(m++,k=0;k<n.length;k++)for(p=n[k].nodes.keys(),u=p.length,2<u&&(p=a(n[k])),r=0;r<u;r++){var h=this.renderedProteins.get(p[r]),x,w;!0===h.isParked?(t++,x=b(v),w=30*t,w>e&&(v--,t=1,x=b(v),w=30*t)):(q++,(60>l||1<u)&&q++,x=b(m),w=30*q,30*(q+2*(u-1-r))+this.maxBlobRadius>e&&(m++,q=1,60>l&&q++,x=b(m),w=30*
q));h.setPosition(x,w);h.setAllLineCoordinates()}this.layoutXOffset=b(m+.5);if("undefined"===typeof this.force||null==this.force){l={NAME:"ALL",children:[]};for(k=0;k<g.length;k++)for(p=g[k].nodes.values(),u=p.length,r=0;r<u;r++)h=this.renderedProteins.get(p[r].id),m={},m.id=h.id,m.x=h.x-this.layoutXOffset,m.y=h.y,m.px=h.x-this.layoutXOffset,m.py=h.y,m.linkCount=h.proteinLinks.keys().length,m.size=30,l.children.push(m);p=d3.layout.pack().size([c-this.layoutXOffset,e]).value(function(a){return a.size}).sort(function(a,
b){return b.linkCount-a.linkCount}).nodes(l);u=p.length;for(r=1;r<u;r++)l=p[r],k=this.renderedProteins.get(l.id),l=Protein.rotatePointAboutPoint([l.x,l.y],[c-this.layoutXOffset/2,e/2],90),k.setPosition(l[0]+this.layoutXOffset,l[1]),k.setAllLineCoordinates(!1)}n=c-this.layoutXOffset;200>n&&(n=c);l={nodes:[],links:[]};c={};for(k=q=0;k<g.length;k++)for(p=g[k].nodes.values(),u=p.length,r=0;r<u;r++)h=this.renderedProteins.get(p[r].id),c[h.id]=q,q++,m={},m.id=h.id,m.x=h.x-this.layoutXOffset,m.y=h.y,m.px=
h.x-this.layoutXOffset,m.py=h.y,l.nodes.push(m);for(k=0;k<g.length;k++)for(p=g[k].links.values(),r=p.length,h=0;h<r;h++)if(m=p[h],q=m.fromProtein,t=m.toProtein)q=c[q.id],t=c[t.id],q!==t&&("undefined"!==typeof q&&"undefined"!==typeof t?(v={},v.source=q,v.target=t,v.id=m.id,l.links.push(v)):alert("NOT RIGHT"));g=Math.sqrt(l.nodes.length/(n*e));this.force=d3.layout.force().nodes(l.nodes).links(l.links).gravity(85*g).linkDistance(60).charge(-30/g).size([n,e]);u=this.force.nodes().length;this.force.links();
this.force.on("tick",function(a){a=f.force.nodes();for(var b=0;b<u;b++){var c=a[b],d=f.proteins.get(c.id);d.setPosition(c.x+f.layoutXOffset,c.y);d.setAllLineCoordinates()}});this.force.start()}},downloadSVG:function(){},hideView:function(){a.CLMSUI.vent.trigger(this.displayEventName,!1)},setVisible:function(a){console.log("event display in distogram",a);d3.select(this.el).style("display",a?"block":"none");a&&this.relayout().render()},render:function(){console.log("re rendering cross-link viewer");
this.checkLinks();return this},remove:function(){this.chart=this.chart.destroy();d3.select(this.el).selectAll(".dynDiv_resizeDiv_tl, .dynDiv_resizeDiv_tr, .dynDiv_resizeDiv_bl, .dynDiv_resizeDiv_br").on(".drag",null);Backbone.View.prototype.remove.call(this)}})})(this);CLMS.xiNET.svgns="http://www.w3.org/2000/svg";CLMS.xiNET.xlinkNS="http://www.w3.org/1999/xlink";CLMS.xiNET.linkWidth=1.3;CLMS.xiNET.homodimerLinkWidth=1.3;CLMS.xiNET.highlightColour=new RGBColor("#fdc086");
CLMS.xiNET.selectedColour=new RGBColor("#ffff99");CLMS.xiNET.defaultSelfLinkColour=new RGBColor("#9970ab");CLMS.xiNET.defaultInterLinkColour=new RGBColor("#35978f");CLMS.xiNET.homodimerLinkColour=new RGBColor("#a50f15");CLMS.xiNET.Controller={};CLMS.xiNET.Controller.MOUSE_UP=0;CLMS.xiNET.Controller.PANNING=1;CLMS.xiNET.Controller.DRAGGING=2;CLMS.xiNET.Controller.ROTATING=3;CLMS.xiNET.Controller.SCALING_PROTEIN=4;CLMS.xiNET.Controller.SCALING_ALL_PROTEINS=5;CLMS.xiNET.Controller.SELECTING=6;CLMS.xiNET.RenderedLink=function(){};CLMS.xiNET.RenderedLink.prototype.mouseDown=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;this.crosslinkViewer.clearSelection();this.setSelected(!0);a=this.crosslinkViewer.getEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedLink.prototype.mouseOver=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!0,!0);this.crosslinkViewer.setTooltip(this.tooltip);return!1};CLMS.xiNET.RenderedLink.prototype.mouseOut=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!1,!0);this.crosslinkViewer.hideTooltip();return!1};
CLMS.xiNET.RenderedLink.prototype.touchStart=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);void 0!==this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;this.crosslinkViewer.clearSelection();this.setSelected(!0);a=this.crosslinkViewer.getTouchEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};CLMS.xiNET.RenderedProtein=function(a,d){this.interactor=a;this.crosslinkViewer=d;this.tooltip=this.interactor.name+" ["+this.interactor.accession+"]";this.proteinLinks=d3.map();this.selfLink=null;this.y=this.x=40;this.previousRotation=this.rotation=0;this.stickZoom=1;this.form=0;this.isSelected=this.isFlipped=this.isParked=!1;this.customAnnotations=null;this.lowerRotator=new CLMS.xiNET.Rotator(this,0,this.crosslinkViewer);this.upperRotator=new CLMS.xiNET.Rotator(this,1,this.crosslinkViewer);this.lowerGroup=
document.createElementNS(CLMS.xiNET.svgns,"g");this.lowerGroup.setAttribute("class","protein lowerGroup");this.highlight=document.createElementNS(CLMS.xiNET.svgns,"rect");void 0!==CLMS.xiNET.highlightColour&&this.highlight.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlight.setAttribute("stroke-width","5");this.highlight.setAttribute("fill","none");this.lowerGroup.appendChild(this.highlight);this.rectDomains=document.createElementNS(CLMS.xiNET.svgns,"g");this.rectDomains.setAttribute("opacity",
"0");this.lowerGroup.appendChild(this.rectDomains);this.peptides=document.createElementNS(CLMS.xiNET.svgns,"g");this.lowerGroup.appendChild(this.peptides);this.upperGroup=document.createElementNS(CLMS.xiNET.svgns,"g");this.upperGroup.setAttribute("class","protein upperGroup");this.selfLinksHighlights=document.createElementNS(CLMS.xiNET.svgns,"g");this.selfLinks=document.createElementNS(CLMS.xiNET.svgns,"g");this.upperGroup.appendChild(this.selfLinksHighlights);this.upperGroup.appendChild(this.selfLinks);
this.labelSVG=document.createElementNS(CLMS.xiNET.svgns,"text");this.labelSVG.setAttribute("text-anchor","end");this.labelSVG.setAttribute("fill",this.interactor.isDecoy()?"#FB8072":"black");this.labelSVG.setAttribute("x",0);this.labelSVG.setAttribute("y",10);this.labelSVG.setAttribute("class","protein xlv_text proteinLabel");this.labelSVG.setAttribute("font-family","Arial");this.labelSVG.setAttribute("font-size","16");this.labelText=this.interactor.name;25<this.labelText.length&&(this.labelText=
this.labelText.substr(0,16)+"...");this.labelTextNode=document.createTextNode(this.labelText);this.labelSVG.appendChild(this.labelTextNode);d3.select(this.labelSVG).attr("transform","translate( -5 "+CLMS.xiNET.RenderedProtein.labelY+") rotate(0) scale(1, 1)");this.upperGroup.appendChild(this.labelSVG);this.ticks=document.createElementNS(CLMS.xiNET.svgns,"g");this.outline=document.createElementNS(CLMS.xiNET.svgns,"rect");this.outline.setAttribute("stroke","black");this.outline.setAttribute("stroke-width",
"1");this.outline.setAttribute("fill","#EEEEEE");this.upperGroup.appendChild(this.outline);this.upperGroup.appendChild(this.ticks);this.circDomains=document.createElementNS(CLMS.xiNET.svgns,"g");this.circDomains.setAttribute("opacity",1);this.upperGroup.appendChild(this.circDomains);this.scaleLabels=[];var b=this;this.upperGroup.onmousedown=function(a){b.mouseDown(a)};this.upperGroup.onmouseover=function(a){b.mouseOver(a)};this.upperGroup.onmouseout=function(a){b.mouseOut(a)};this.upperGroup.ontouchstart=
function(a){b.touchStart(a)};this.busy=this.isSelected=!1;this.showHighlight(!1)};CLMS.xiNET.RenderedProtein.prototype.init=function(){this.setForm(this.form);this.selfLink&&this.selfLink.initSelfLinkSVG();this.setAllLineCoordinates()};
CLMS.xiNET.RenderedProtein.prototype.mouseDown=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;a=this.crosslinkViewer.getEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedProtein.prototype.touchStart=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);void 0!==this.crosslinkViewer.force&&this.crosslinkViewer.force.stop();this.crosslinkViewer.dragElement=this;a=this.crosslinkViewer.getTouchEventPoint(a);this.crosslinkViewer.dragStart=this.crosslinkViewer.mouseToSVG(a.x,a.y);return!1};
CLMS.xiNET.RenderedProtein.prototype.mouseOver=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!0);this.crosslinkViewer.setTooltip(this.tooltip);return!1};CLMS.xiNET.RenderedProtein.prototype.mouseOut=function(a){this.crosslinkViewer.preventDefaultsAndStopPropagation(a);this.showHighlight(!1);this.crosslinkViewer.hideTooltip();return!1};
CLMS.xiNET.RenderedProtein.prototype.getBlobRadius=function(){var a=Math.sqrt(this.interactor.size/Math.PI);console.log("*br"+a);return a};CLMS.xiNET.RenderedProtein.prototype.toJSON=function(){return{id:this.id,x:this.x,y:this.y,rot:this.rotation,form:this.form,stickZoom:this.stickZoom,parked:this.isParked,flipped:this.isFlipped}};
CLMS.xiNET.RenderedProtein.prototype.showHighlight=function(a){!0===a?(this.highlight.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB()),this.highlight.setAttribute("stroke-opacity","1")):(0==this.isSelected&&this.highlight.setAttribute("stroke-opacity","0"),this.highlight.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()))};
CLMS.xiNET.RenderedProtein.prototype.setRotation=function(a){this.rotation=a%360;0>this.rotation&&(this.rotation+=360);this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")");this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")");var d=this.crosslinkViewer.svgElement;a=this.labelSVG.getAttribute("transform");var b=d3.transform(a);a=this.scaleLabels.length;
if(90<=this.rotation&&270>this.rotation){if(b=d.createSVGMatrix().translate(Math.abs(b.translate[0]),-CLMS.xiNET.RenderedProtein.labelY).rotate(180,0,0),this.labelSVG.transform.baseVal.initialize(d.createSVGTransformFromMatrix(b)),1===this.form){for(d=0;d<a;d++)this.scaleLabels[d].setAttribute("transform","scale(-1,1)");this.ticks.setAttribute("transform","scale(1,-1)")}}else if(b=d.createSVGMatrix().translate(-Math.abs(b.translate[0]),CLMS.xiNET.RenderedProtein.labelY),this.labelSVG.transform.baseVal.initialize(d.createSVGTransformFromMatrix(b)),
1===this.form){for(d=0;d<a;d++)this.scaleLabels[d].setAttribute("transform","scale(1,1)");this.ticks.setAttribute("transform","scale(1,1)")}};
CLMS.xiNET.RenderedProtein.prototype.setPosition=function(a,d){this.x=a;this.y=d;1===this.form&&!1===this.isParked?(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")"),this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") rotate("+this.rotation+")")):(this.upperGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") "),
this.lowerGroup.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+") "),null!=this.selfLink&&("undefined"!==typeof this.selfLink.fatLine&&this.selfLink.fatLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+")"),this.selfLink.line.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+this.crosslinkViewer.z+")"),this.selfLink.highlightLine.setAttribute("transform","translate("+this.x+" "+this.y+") scale("+
this.crosslinkViewer.z+")")))};CLMS.xiNET.RenderedProtein.rotOffset=17.5;CLMS.xiNET.RenderedProtein.minXDist=30;
CLMS.xiNET.RenderedProtein.prototype.switchStickScale=function(a){this.isParked&&this.toggleParked();if(0===this.form)this.toStick();else if(8<CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom)this.stickZoom=.5,this.setPosition(a.x,a.y);else{this.stickZoom*=3;var d=this.x-a.x;a=this.y-a.y;if(0===this.rotation||180===this.rotation)a=0;this.setPosition(this.x+2*d,this.y+2*a)}this.scale();this.setAllLineCoordinates()};
CLMS.xiNET.RenderedProtein.prototype.scale=function(){var a=this.interactor.size*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom;if(1===this.form){var d=d3.transform(this.labelSVG.getAttribute("transform")),d=this.crosslinkViewer.svgElement.createSVGMatrix().rotate(d.rotate).translate(-(this.interactor.size/2*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom+10),CLMS.xiNET.RenderedProtein.labelY);this.labelSVG.transform.baseVal.initialize(this.crosslinkViewer.svgElement.createSVGTransformFromMatrix(d));
if(this.annotations)for(var d=this.annotations.length,b=0;b<d;b++){var c=this.annotations[b];c.pieSlice.setAttribute("d",this.getAnnotationRectPath(c));c.colouredRect.setAttribute("d",this.getAnnotationRectPath(c))}d3.select(this.peptides).attr("transform","scale("+this.stickZoom+", 1)");d3.select(this.outline).attr("width",a).attr("x",this.getResXwithStickZoom(.5));d3.select(this.highlight).attr("width",a+5).attr("x",this.getResXwithStickZoom(.5)-2.5);this.lowerCLMS.xiNET.Rotator.svg.setAttribute("transform",
"translate("+(this.getResXwithStickZoom(.5)-CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");this.upperCLMS.xiNET.Rotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.interactor.size-0+.5)+CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");if(null!=this.selfLink)for(d=this.selfLink.residueLinks.values(),b=d.length,c=0;c<b;c++){var e=d[c];e.shown&&(a=this.getCLMS.xiNET.RenderedCrossLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",a))}if(null!=this.linkerModifications)for(d=
this.linkerModifications.residueLinks.values(),b=d.length,c=0;c<b;c++)e=d[c],e.shown&&(a=this.getCLMS.xiNET.RenderedCrossLinkPath(e),d3.select(e.line).attr("d",a),d3.select(e.highlightLine).attr("d",a));this.setScaleGroup();this.setRotation(this.rotation)}};
CLMS.xiNET.RenderedProtein.prototype.setScaleGroup=function(){function a(a,b,c){var d=document.createElementNS(CLMS.xiNET.svgns,"g");d.setAttribute("transform","translate("+c+" 0)");c=document.createElementNS(CLMS.xiNET.svgns,"text");c.setAttribute("class","protein xlv_text proteinLabel");c.setAttribute("font-family","'Courier New', monospace");c.setAttribute("font-size","14");c.setAttribute("text-anchor","middle");c.setAttribute("x",0);c.setAttribute("y",CLMS.xiNET.RenderedProtein.STICKHEIGHT+4);
c.appendChild(document.createTextNode(b));d.appendChild(c);a.scaleLabels.push(c);a.ticks.appendChild(d)}function d(a,b){var c=document.createElementNS(CLMS.xiNET.svgns,"line");c.setAttribute("x1",b);c.setAttribute("y1",5);c.setAttribute("x2",b);c.setAttribute("y2",10);c.setAttribute("stroke","black");a.ticks.appendChild(c)}d3.select(this.ticks).selectAll("*").remove();this.scaleLabels=[];for(var b=CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom,c=-1,e=this.getResXwithStickZoom(this.interactor.size),
f=1;f<=this.interactor.size;f++){if(1===f||0===f%100&&200*b>CLMS.xiNET.RenderedProtein.minXDist||0===f%10&&20*b>CLMS.xiNET.RenderedProtein.minXDist){var g=this.getResXwithStickZoom(f);(8<=b||1!==f)&&d(this,g);c=(c+1)%2;0===c&&g+CLMS.xiNET.RenderedProtein.minXDist<e&&a(this,f,g)}if(8<=b&&this.sequence){g=document.createElementNS(CLMS.xiNET.svgns,"g");g.setAttribute("transform","translate("+this.getResXwithStickZoom(f)+" 0)");var l=document.createElementNS(CLMS.xiNET.svgns,"text");l.setAttribute("font-family",
"'Courier New', monospace");l.setAttribute("font-size","10px");l.setAttribute("text-anchor","middle");l.setAttribute("x",0);l.setAttribute("y",3);l.appendChild(document.createTextNode(this.sequence[f-1]));g.appendChild(l);this.scaleLabels.push(l);this.ticks.appendChild(g)}}a(this,this.interactor.size,e);8<b&&d(this,e)};
CLMS.xiNET.RenderedProtein.prototype.toggleFlipped=function(){(this.isFlipped=!this.isFlipped)?(this.selfLinks.setAttribute("transform","scale (1 -1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 -1)")):(this.selfLinks.setAttribute("transform","scale (1 1)"),this.selfLinksHighlights.setAttribute("transform","scale (1 1)"))};
CLMS.xiNET.RenderedProtein.prototype.setParked=function(a,d){this.isParked=a;if(!0!==this.busy)if(0==a)0===this.form?(d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").duration(CLMS.xiNET.RenderedProtein.transitionTime),this.checkLinks(),d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)):this.toStick(),this.scale(),this.setAllLineCoordinates();else if(1==
a){this.isParked=!0;for(var b=this.proteinLinks.values().length,c=0;c<b;c++){var e=this.proteinLinks.values()[c];e.hide();for(var e=e.residueLinks.values(),f=e.length,g=0;g<f;g++)e[g].hide()}1===this.form?(this.toCircle(d),b=this.getBlobRadius(),d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill-opacity",1).attr("fill","#EEEEEE").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(this.rectDomains).transition().attr("opacity",
0).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)):(d3.select(this.outline).transition().attr("stroke-opacity",0).attr("fill","#EEEEEE").duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(this.circDomains).transition().attr("opacity",0).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime))}};
CLMS.xiNET.RenderedProtein.prototype.setForm=function(a,d){if(!0!==this.busy)if(this.isParked)this.setParked(!1);else if(1==a)this.toStick();else{this.toCircle(d);var b=this.getBlobRadius();d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",1).attr("fill","#ffffff").attr("x",-b).attr("y",-b).attr("width",2*b).attr("height",2*b).attr("rx",b).attr("ry",b).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",0).attr("transform",
"scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.circDomains).transition().attr("opacity",1).attr("transform","scale(1, 1)").duration(CLMS.xiNET.RenderedProtein.transitionTime)}};
CLMS.xiNET.RenderedProtein.prototype.toCircle=function(a){function d(a){var b=d3.transform(k.labelSVG.getAttribute("transform")),b=k.crosslinkViewer.svgElement.createSVGMatrix().rotate(b.rotate).translate(g(t(a)),CLMS.xiNET.RenderedProtein.labelY);k.labelSVG.transform.baseVal.initialize(k.crosslinkViewer.svgElement.createSVGTransformFromMatrix(b));null!==l&&k.setPosition(l(t(a)),h(t(a)));b=e(t(a));k.stickZoom=c(t(a));1==k.form&&k.setRotation(b);k.setAllLineCoordinates();if(1===a){a=k.proteinLinks.values();
for(var b=a.length,f=0;f<b;f++){var m=a[f];if(null===m.toProtein||m.getFromProtein()===k&&0===m.getToProtein().form||m.getToProtein()===k&&0===m.getFromProtein().form||m.getToProtein()==m.getFromProtein())for(var m=m.residueLinks.values(),n=m.length,p=0;p<n;p++)m[p].hide()}k.form=0;k.checkLinks();k.stickZoom=u;k.rotation=q;k.busy=!1;return!0}return 1<a?d(1):!1}this.busy=!0;this.removePeptides();this.upperGroup.contains(this.lowerRotator.svg)&&this.upperGroup.removeChild(this.lowerRotator.svg);this.upperGroup.contains(this.upperRotator.svg)&&
this.upperGroup.removeChild(this.upperRotator.svg);var b=this.getBlobRadius(),c=d3.interpolate(this.stickZoom,0),e=d3.interpolate(180<this.rotation?this.rotation-360:this.rotation,0),f=d3.transform(this.labelSVG.getAttribute("transform")).translate[0],g=d3.interpolate(f,-(b+5)),l=null,h=null;"undefined"!==typeof a&&null!==a&&(l=d3.interpolate(this.x,a.x),h=d3.interpolate(this.y,a.y));var k=this;d3.select(this.ticks).transition().attr("opacity",0).duration(CLMS.xiNET.RenderedProtein.transitionTime/
4).each("end",function(){d3.select(this).selectAll("*").remove()});d3.select(this.highlight).transition().attr("width",2*b+5).attr("height",2*b+5).attr("x",-b-2.5).attr("y",-b-2.5).attr("rx",b+2.5).attr("ry",b+2.5).duration(CLMS.xiNET.RenderedProtein.transitionTime);if(null!=this.selfLink)for(var b=this.selfLink.residueLinks.values(),f=b.length,n=0;n<f;n++){var m=b[n];m.shown&&(a=d3.select(m.line),a.attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(m)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(CLMS.xiNET.RenderedProtein.transitionTime),
a=d3.select(m.highlightLine),a.attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(m)),a.transition().attr("d",this.getAggregateSelfLinkPath()).duration(CLMS.xiNET.RenderedProtein.transitionTime))}if(null!=this.linkerModifications)for(b=this.linkerModifications.residueLinks.values(),f=b.length,n=0;n<f;n++)a=b[n],a.shown&&(a=d3.select(a.line),a.attr("fill","none"),a.attr("d","M 0,0 L 0,0"));k=this;if(this.annotations){a=this.annotations;for(var p=a.length,b=0;b<p;b++)f=a[b],n=f.colouredRect,d3.select(f.pieSlice).transition().attr("d",
this.getAnnotationPieSliceApproximatePath(f)).duration(CLMS.xiNET.RenderedProtein.transitionTime).each("end",function(){for(var a=0;a<p;a++){var b=k.annotations[a];this===b.pieSlice&&d3.select(this).attr("d",k.getAnnotationPieSliceArcPath(b))}}),d3.select(n).transition().attr("d",k.getAnnotationPieSliceApproximatePath(f)).duration(CLMS.xiNET.RenderedProtein.transitionTime)}var u=this.stickZoom,q=this.rotation,t=d3.ease("cubic-in-out");d3.timer(function(a){return d(a/CLMS.xiNET.RenderedProtein.transitionTime)})};
CLMS.xiNET.RenderedProtein.prototype.getX=function(){return this.x};CLMS.xiNET.RenderedProtein.prototype.getY=function(){return this.y};
CLMS.xiNET.RenderedProtein.prototype.toStick=function(){function a(b){var c=d3.transform(m.labelSVG.getAttribute("transform")),c=m.crosslinkViewer.svgElement.createSVGMatrix().rotate(c.rotate).translate(l(p(b)),CLMS.xiNET.RenderedProtein.labelY);m.labelSVG.transform.baseVal.initialize(m.crosslinkViewer.svgElement.createSVGTransformFromMatrix(c));c=g(p(b));m.setRotation(c);c=e(p(b));d3.select(m.outline).attr("width",c).attr("x",-(c/2)+.5*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*m.stickZoom);m.stickZoom=
f(p(b));m.setAllLineCoordinates();return 1===b?(m.busy=!1,!0):1<b?a(1):!1}this.busy=!0;this.form=1;this.upperGroup.appendChild(this.lowerRotator.svg);this.upperGroup.appendChild(this.upperRotator.svg);this.lowerRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(.5)-CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");this.upperRotator.svg.setAttribute("transform","translate("+(this.getResXwithStickZoom(this.interactor.size-0+.5)+CLMS.xiNET.RenderedProtein.rotOffset)+" 0)");for(var d=
this.proteinLinks.values().length,b=0;b<d;b++){var c=this.proteinLinks.values()[b];c.shown&&c.hide()}var d=this.interactor.size*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom,b=this.getBlobRadius(),e=d3.interpolate(2*b,d),f=d3.interpolate(0,this.stickZoom),g=d3.interpolate(0,180<this.rotation?this.rotation-360:this.rotation),l=d3.interpolate(-(b+5),-(this.interactor.size/2*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom+10)),b=this.stickZoom;this.stickZoom=0;this.checkLinks();
this.stickZoom=b;d3.select(this.circDomains).transition().attr("opacity",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.rectDomains).transition().attr("opacity",1).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(this.outline).transition().attr("stroke-opacity",1).attr("fill-opacity",0).attr("fill","#FFFFFF").attr("height",CLMS.xiNET.RenderedProtein.STICKHEIGHT).attr("y",-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2).attr("rx",0).attr("ry",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);
d3.select(this.highlight).transition().attr("width",d+5).attr("height",CLMS.xiNET.RenderedProtein.STICKHEIGHT+5).attr("x",this.getResXwithStickZoom(.5)-2.5).attr("y",-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2-2.5).attr("rx",0).attr("ry",0).duration(CLMS.xiNET.RenderedProtein.transitionTime);if(null!=this.selfLink)for(d=this.selfLink.residueLinks.values(),b=d.length,c=0;c<b;c++){var h=d[c];h.shown&&(d3.select(h.line).attr("d",this.getAggregateSelfLinkPath()),d3.select(h.line).transition().attr("d",
this.getCLMS.xiNET.RenderedCrossLinkPath(h)).duration(CLMS.xiNET.RenderedProtein.transitionTime),d3.select(h.highlightLine).attr("d",this.getAggregateSelfLinkPath()),d3.select(h.highlightLine).transition().attr("d",this.getCLMS.xiNET.RenderedCrossLinkPath(h)).duration(CLMS.xiNET.RenderedProtein.transitionTime))}if(null!=this.linkerModifications)for(d=this.linkerModifications.residueLinks.values(),b=d.length,c=0;c<b;c++)if(h=d[c],h.shown){var k=this.getCLMS.xiNET.RenderedCrossLinkPath(h);d3.select(h.line).attr("d",
"M 0,0 L 0,0 L 0,0 L 0,0");d3.select(h.line).transition().attr("d",k).duration(CLMS.xiNET.RenderedProtein.transitionTime);d3.select(h.highlightLine).attr("d","M 0,0 L 0,0");d3.select(h.highlightLine).transition().attr("d",k).duration(CLMS.xiNET.RenderedProtein.transitionTime)}if(this.annotations)for(d=this.annotations,b=d.length,c=0;c<b;c++){var h=d[c],k=h.pieSlice,n=h.colouredRect;k.setAttribute("d",this.getAnnotationPieSliceApproximatePath(h));d3.select(k).transition().attr("d",this.getAnnotationRectPath(h)).duration(CLMS.xiNET.RenderedProtein.transitionTime);
d3.select(n).transition().attr("d",this.getAnnotationRectPath(h)).duration(CLMS.xiNET.RenderedProtein.transitionTime)}var m=this,p=d3.ease("cubic-in-out");d3.timer(function(b){return a(b/CLMS.xiNET.RenderedProtein.transitionTime)});d3.select(this.ticks).attr("opacity",0);this.setScaleGroup();d3.select(this.ticks).transition().attr("opacity",1).delay(.8*CLMS.xiNET.RenderedProtein.transitionTime).duration(CLMS.xiNET.RenderedProtein.transitionTime/2)};
CLMS.xiNET.RenderedProtein.prototype.getAggregateSelfLinkPath=function(){var a=this.getBlobRadius()+7,d=CLMS.xiNET.RenderedProtein.trig(a,70),b=CLMS.xiNET.RenderedProtein.trig(a,20),c=CLMS.xiNET.RenderedProtein.trig(a,85),e=CLMS.xiNET.RenderedProtein.trig(a,5);return"M 0,0 Q "+c.x+","+-c.y+" "+d.x+","+-d.y+" A "+a+" "+a+" 0 0 1 "+b.x+","+-b.y+" Q "+e.x+","+-e.y+" 0,0"};
CLMS.xiNET.RenderedProtein.prototype.getCrossLinkPath=function(a){var d=this.getResXwithStickZoom(a.crossLink.fromResidue),b=0;8<=CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom&&(b=-5);if(isNaN(parseFloat(a.crossLink.toResidue))){!1===a.ambig&&a.line.setAttribute("fill",xiNET.defaultSelfLinkColour.toRGB());var c=[d,26],e=[d,18],f=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint(c,e,60);return"M "+d+","+-1*b+" L "+c[0]+","+c[1]+" L "+f[0]+","+f[1]+" L "+e[0]+","+e[1]}var c=this.getResXwithStickZoom(a.crossLink.toResidue),
g,l,f=Math.abs(c-d)/2,e=-(CLMS.xiNET.RenderedProtein.STICKHEIGHT/2+3);15>f&&(e=-28+f);var h=[d,b],k=[c,b];!0===a.intraMolecular?(g=d+(c-d)/2,b=[g,e-f],l=[g,e-f],a=[g,e-f],g=[g,e-f]):a.hd?(g=d+(c-d)/2,b=[g,e-f],l=[g,e-f],a=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint([d,e-f],h,-20),g=CLMS.xiNET.RenderedProtein.rotatePointAboutPoint([c,e-f],k,20)):(a=[d,e],g=[c,b],b=[d,e],l=[c,e]);return" M "+h[0]+","+h[1]+" Q "+a[0]+","+a[1]+" "+b[0]+","+b[1]+" A "+f+","+f+"  0 0 1 "+l[0]+","+l[1]+" Q "+g[0]+","+
g[1]+" "+k[0]+","+k[1]};
CLMS.xiNET.RenderedProtein.prototype.showPeptides=function(a){if(1===this.form)for(var d=-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,b=a.length,c=CLMS.xiNET.RenderedProtein.STICKHEIGHT/b,e=0;e<b;e++){var f=a[e],g=document.createElementNS(CLMS.xiNET.svgns,"rect");g.setAttribute("class","protein");var l=f[1];if(0<l){var h=(f[0]+.5-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,l=l*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE;g.setAttribute("x",h);g.setAttribute("y",d);g.setAttribute("width",
l);g.setAttribute("height",c);g.setAttribute("fill",CLMS.xiNET.highlightColour.toRGB());this.peptides.appendChild(g)}f[2]&&(g=document.createElementNS(CLMS.xiNET.svgns,"rect"),g.setAttribute("class","protein"),h=(f[2]+.5-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,l=(f[3]-f[2])*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE,g.setAttribute("x",h),g.setAttribute("y",d),g.setAttribute("width",l),g.setAttribute("height",c),g.setAttribute("fill",xiNET.homodimerLinkColour.toRGB()),
g.setAttribute("fill-opacity","0.5"),this.peptides.appendChild(g));d+=c}};CLMS.xiNET.RenderedProtein.prototype.removePeptides=function(){d3.select(this.peptides).selectAll("*").remove()};CLMS.xiNET.RenderedProtein.prototype.getResXwithStickZoom=function(a){return(a-this.interactor.size/2)*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom};
CLMS.xiNET.RenderedProtein.rotatePointAboutPoint=function(a,d,b){b=b/360*Math.PI*2;return[Math.cos(b)*(a[0]-d[0])-Math.sin(b)*(a[1]-d[1])+d[0],Math.sin(b)*(a[0]-d[0])+Math.cos(b)*(a[1]-d[1])+d[1]]};CLMS.xiNET.RenderedProtein.prototype.checkLinks=function(){for(var a=this.proteinLinks.values(),d=a.length,b=0;b<d;b++)a[b].check()};
CLMS.xiNET.RenderedProtein.prototype.setAllLineCoordinates=function(){for(var a=this.proteinLinks.values(),d=a.length,b=0;b<d;b++){var c=a[b];if(null!==c.getToProtein()&&0===c.getFromProtein().form&&0===c.getToProtein().form)c.setLineCoordinates(this);else for(var c=c.residueLinks.values(),e=c.length,f=0;f<e;f++){var g=c[f];g.setLineCoordinates(this);var l=g.proteinLink.getOtherEnd(this);l&&1===l.form&&8<l.stickZoom*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE&&g.setLineCoordinates(l)}}};
CLMS.xiNET.RenderedProtein.prototype.clearPositionalFeatures=function(a){this.annotations=[];this.circDomains&&d3.select(this.circDomains).selectAll("*").remove();this.rectDomains&&d3.select(this.rectDomains).selectAll("*").remove()};
CLMS.xiNET.RenderedProtein.prototype.setPositionalFeatures=function(a){this.clearPositionalFeatures();if(a){a.sort(function(a,b){return b.end-b.start-(a.end-a.start)});this.annotations=a;for(var d=0;d<a.length;d++){var b=a[d];b.start-=0;b.end-=0;b.pieSlice=document.createElementNS(CLMS.xiNET.svgns,"path");b.colouredRect=document.createElementNS(CLMS.xiNET.svgns,"path");0===this.form?(b.pieSlice.setAttribute("d",this.getAnnotationPieSliceArcPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationPieSliceApproximatePath(b))):
(b.pieSlice.setAttribute("d",this.getAnnotationRectPath(b)),b.colouredRect.setAttribute("d",this.getAnnotationRectPath(b)));b.pieSlice.setAttribute("stroke-width",1);b.pieSlice.setAttribute("fill-opacity","0.5");b.colouredRect.setAttribute("stroke-width",1);b.colouredRect.setAttribute("fill-opacity","0.5");b.pieSlice.name=b.name+" ["+b.start+" - "+b.end+"]";var c=this.crosslinkViewer,e=this;b.pieSlice.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:
a.target;c.preventDefaultsAndStopPropagation(a);c.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};b.colouredRect.onmouseover=function(a){var b=a.target.correspondingUseElement?a.target.correspondingUseElement:a.target;c.preventDefaultsAndStopPropagation(a);c.setTooltip(b.name,b.getAttribute("fill"));e.showHighlight(!0)};this.circDomains.appendChild(b.pieSlice);this.rectDomains.appendChild(b.colouredRect)}}};
CLMS.xiNET.RenderedProtein.trig=function(a,d){var b=d/360*Math.PI*2;return{x:a*Math.cos(b),y:a*Math.sin(b)}};CLMS.xiNET.RenderedProtein.prototype.getAnnotationPieSliceArcPath=function(a){var d=(a.start-1)/this.interactor.size*360;a=a.end/this.interactor.size*360;var b=this.getBlobRadius()-2,c=CLMS.xiNET.RenderedProtein.trig(b,d-90),e=CLMS.xiNET.RenderedProtein.trig(b,a-90),f=0;if(180<a-d||a==d)f=1;return"M0,0 L"+c.x+","+c.y+" A"+b+","+b+" 0 "+f+" 1 "+e.x+","+e.y+" Z"};
CLMS.xiNET.RenderedProtein.prototype.getAnnotationPieSliceApproximatePath=function(a){var d=(a.start-1)/this.interactor.size*360;a=a.end/this.interactor.size*360;var b=this.getBlobRadius()-2;CLMS.xiNET.RenderedProtein.trig(b,d-90);CLMS.xiNET.RenderedProtein.trig(b,a-90);for(var c="M 0,0",e=0;e<=CLMS.xiNET.RenderedProtein.stepsInArc;e++)var f=CLMS.xiNET.RenderedProtein.trig(b,d+e/5*(a-d)-90),c=c+(" L "+f.x+","+f.y);return c+=" L 0,0  Z"};
CLMS.xiNET.RenderedProtein.prototype.getAnnotationRectPath=function(a){var d=CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,b=-CLMS.xiNET.RenderedProtein.STICKHEIGHT/2,c=this.getResXwithStickZoom(a.start-.5);a=(1+(a.end-a.start))*CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE*this.stickZoom;for(var e="M "+c+","+d,f=0;f<=CLMS.xiNET.RenderedProtein.stepsInArc;f++)e+=" L "+(c+f/CLMS.xiNET.RenderedProtein.stepsInArc*a)+","+b;return e+(" L "+(c+a)+","+d+" Z")};CLMS.xiNET.RenderedProtein.STICKHEIGHT=20;
CLMS.xiNET.RenderedProtein.MAXSIZE=100;CLMS.xiNET.RenderedProtein.UNITS_PER_RESIDUE=1;CLMS.xiNET.RenderedProtein.LABELMAXLENGTH=60;CLMS.xiNET.RenderedProtein.labelY=-5;CLMS.xiNET.RenderedProtein.domainColours=d3.scale.ordinal().range(colorbrewer.Paired[5]);CLMS.xiNET.RenderedProtein.transitionTime=650;CLMS.xiNET.RenderedProtein.stepsInArc=5;CLMS.xiNET.RenderedProteinLink=function(a,d,b,c){this.id=a;this.residueLinks=d3.map();this.controller=c;this.fromProtein=d;this.toProtein=b;this.ambig=!1;this.tooltip=this.id;this.hidden=this.shown=!1;this.selfLink()?(this.line=document.createElementNS(xiNET.svgns,"path"),this.highlightLine=document.createElementNS(xiNET.svgns,"path"),this.fatLine=document.createElementNS(xiNET.svgns,"path")):(this.line=document.createElementNS(xiNET.svgns,"line"),this.highlightLine=document.createElementNS(xiNET.svgns,
"line"),this.fatLine=document.createElementNS(xiNET.svgns,"line"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","black");this.line.setAttribute("stroke-width",1);this.line.setAttribute("stroke-linecap","round");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-linecap",
"round");this.highlightLine.setAttribute("stroke-opacity","0");this.fatLine.setAttribute("class","link");this.fatLine.setAttribute("fill","none");this.fatLine.setAttribute("stroke","lightgray");this.fatLine.setAttribute("stroke-linecap","round");this.fatLine.setAttribute("stroke-linejoin","round");var e=this;this.line.onmousedown=function(a){e.mouseDown(a)};this.line.onmouseover=function(a){e.mouseOver(a)};this.line.onmouseout=function(a){e.mouseOut(a)};this.line.ontouchstart=function(a){e.touchStart(a)};
this.highlightLine.onmousedown=function(a){e.mouseDown(a)};this.highlightLine.onmouseover=function(a){e.mouseOver(a)};this.highlightLine.onmouseout=function(a){e.mouseOut(a)};this.highlightLine.ontouchstart=function(a){e.touchStart(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmousedown=function(a){e.mouseDown(a)};this.fatLine.onmouseover=function(a){e.mouseOver(a)};this.fatLine.onmouseout=function(a){e.mouseOut(a)};this.fatLine.ontouchstart=function(a){e.touchStart(a)};
this.isSelected=!1};CLMS.xiNET.RenderedProteinLink.maxNoCrossLinks=0;CLMS.xiNET.RenderedProteinLink.prototype=new CLMS.xiNET.RenderedLink;CLMS.xiNET.RenderedProteinLink.prototype.selfLink=function(){return this.fromProtein===this.toProtein};CLMS.xiNET.RenderedProteinLink.prototype.initSelfLinkSVG=function(){var a=this.fromProtein.getAggregateSelfLinkPath();this.line.setAttribute("d",a);this.highlightLine.setAttribute("d",a);this.fatLine.setAttribute("d",a)};
CLMS.xiNET.RenderedProteinLink.prototype.getFromProtein=function(){return this.fromProtein};CLMS.xiNET.RenderedProteinLink.prototype.getToProtein=function(){return this.toProtein};
CLMS.xiNET.RenderedProteinLink.prototype.showHighlight=function(a,d){"undefined"===typeof d&&(d=!1);this.shown&&(a?(this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1")):(this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),0==this.isSelected&&this.highlightLine.setAttribute("stroke-opacity","0")));if(d&&this.ambig)for(var b=this.residueLinks.values().length,c=0;c<b;c++)for(var e=this.residueLinks.values()[c],
f=e.matches.length,g=0;g<f;g++){var l=e.matches[g][0];if(l.isAmbig())for(var h=l.residueLinks.length,k=0;k<h;k++)e=l.residueLinks[k],!0===e.shown&&0==e.isSelected&&e.showHighlight(a,!1),!0===e.proteinLink.shown&&e.proteinLink.showHighlight(a,!1)}};
CLMS.xiNET.RenderedProteinLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.controller.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","1"),this.controller.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.controller.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",
CLMS.xiNET.highlightColour.toRGB()),this.controller.linkSelectionChanged())};CLMS.xiNET.RenderedProteinLink.prototype.getFilteredMatches=function(){for(var a=this.residueLinks.values(),d=a.length,b=d3.map(),c=0;c<d;c++)for(var e=a[c],f=e.matches.length,g=0;g<f;g++){var l=e.matches[g];l.meetsFilterCriteria()&&b.set(l.id)}return b.keys()};
CLMS.xiNET.RenderedProteinLink.prototype.check=function(){if(this.fromProtein.isParked||null!==this.toProtein&&this.toProtein.isParked)return this.hide(),!1;if(this.selfLink()&&!1===this.controller.selfLinksShown){if(0===this.fromProtein.form)this.hide();else for(var a=this.residueLinks.values(),d=a.length,b=0;b<d;b++)a[b].hide();return!1}if(this.hidden){if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form)this.hide();else for(a=this.residueLinks.values(),d=a.length,b=0;b<
d;b++)a[b].hide();return!1}a=this.residueLinks.values();d=a.length;this.hd=!1;if(0===this.fromProtein.form&&null!==this.toProtein&&0===this.toProtein.form){this.ambig=!0;for(var c=[],e=d3.map(),f=d3.map(),b=0;b<d;b++){var g=a[b],l=!1;if(g.matches)for(var h=g.matches.length,k=0;k<h;k++){var n=g.matches[k][0];if(n.meetsFilterCriteria())if(!0===n.hd&&(this.hd=!0),!1===l&&(l=!0,c.push(g)),e.set(n.id,n),n.isAmbig())for(var m=0;m<n.residueLinks.length;m++)f.set(n.residueLinks[m].proteinLink.id);else this.ambig=
!1}else c.push(g)}b=c.length;if(0<b){this.tooltip=this.id+", "+b+" unique cross-link";1<b&&(this.tooltip+="s");this.tooltip+=" ("+e.keys().length;1===e.keys().length?this.tooltip+=" match)":this.tooltip+=" matches)";this.w=45/CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks*b;this.ambig=this.ambig&&1<altCLMS.xiNET.RenderedProteinLinks.keys().length;this.dashedLine(this.ambig);if(1<this.controller.groups.values().length&&5>this.controller.groups.values().length){a=d3.set();d=e.values();
e=d.length;for(b=0;b<e;b++)n=d[b],a.add(n.group);1==a.values().length?(b=this.controller.linkColours(a.values()[0]),this.line.setAttribute("stroke",b)):this.line.setAttribute("stroke","#000000")}else this.selfLink()&&(this.hd?(this.line.setAttribute("stroke",xiNET.homodimerLinkColour.toRGB()),this.line.setAttribute("stroke-width",xiNET.homodimerLinkWidth)):(this.line.setAttribute("stroke","black"),this.line.setAttribute("stroke-width",1)));this.show();return!0}this.hide();return!1}if(null!==this.toProtein||
0!==this.fromProtein.form){b=!1;for(n=0;n<d;n++)!0===a[n].check()&&(b=!0);return b}};CLMS.xiNET.RenderedProteinLink.prototype.dashedLine=function(a){1==this.controller.unambigLinkFound&&(a?!0===this.selfLink()?this.line.setAttribute("stroke-dasharray","4, 4"):this.line.setAttribute("stroke-dasharray",4*this.controller.z+", "+4*this.controller.z):a||this.line.removeAttribute("stroke-dasharray"))};
CLMS.xiNET.RenderedProteinLink.prototype.show=function(){this.shown||(this.shown=!0,this.selfLink()?(1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&(this.fatLine.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.controller.p_pLinksWide.appendChild(this.fatLine)),this.line.setAttribute("transform","translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")"),this.highlightLine.setAttribute("transform",
"translate("+this.fromProtein.x+" "+this.fromProtein.y+") scale("+this.controller.z+")")):(this.line.setAttribute("stroke-width",1*this.controller.z),this.highlightLine.setAttribute("stroke-width",10*this.controller.z),this.setLineCoordinates(this.fromProtein),this.setLineCoordinates(this.toProtein),1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&this.controller.p_pLinksWide.appendChild(this.fatLine)),this.controller.highlights.appendChild(this.highlightLine),this.controller.p_pLinks.appendChild(this.line));
1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&(this.selfLink()?this.fatLine.setAttribute("stroke-width",this.w):this.fatLine.setAttribute("stroke-width",this.controller.z*this.w))};CLMS.xiNET.RenderedProteinLink.prototype.hide=function(){this.shown&&(this.shown=!1,this.selfLink(),1<CLMS.xiNET.RenderedProteinLink.maxNoCLMS.xiNET.RenderedCrossLinks&&this.controller.p_pLinksWide.removeChild(this.fatLine),this.controller.highlights.removeChild(this.highlightLine),this.controller.p_pLinks.removeChild(this.line))};
CLMS.xiNET.RenderedProteinLink.prototype.setLineCoordinates=function(a){!1===this.selfLink()&&null!==this.getToProtein()&&this.shown&&(this.getFromProtein()===a?(this.line.setAttribute("x1",a.x),this.line.setAttribute("y1",a.y),this.highlightLine.setAttribute("x1",a.x),this.highlightLine.setAttribute("y1",a.y),this.fatLine.setAttribute("x1",a.x),this.fatLine.setAttribute("y1",a.y)):this.getToProtein()===a&&(this.line.setAttribute("x2",a.x),this.line.setAttribute("y2",a.y),this.highlightLine.setAttribute("x2",
a.x),this.highlightLine.setAttribute("y2",a.y),this.fatLine.setAttribute("x2",a.x),this.fatLine.setAttribute("y2",a.y)))};CLMS.xiNET.RenderedProteinLink.prototype.getOtherEnd=function(a){return this.fromProtein===a?this.toProtein:this.fromProtein};CLMS.xiNET.RenderedCrossLink=function(a,d){this.crossLink=a;this.crosslinkViewer=d;this.tooltip=this.crossLink.id;this.dashed=this.shown=!1;this.initSVG()};CLMS.xiNET.RenderedCrossLink.prototype=new CLMS.xiNET.RenderedLink;
CLMS.xiNET.RenderedCrossLink.prototype.initSVG=function(){if("undefined"===typeof this.line){!0===this.crossLink.isSelfLink()||null===this.proteinLink.toProtein?(this.line=document.createElementNS(CLMS.xiNET.svgns,"path"),this.highlightLine=document.createElementNS(CLMS.xiNET.svgns,"path")):(this.line=document.createElementNS(CLMS.xiNET.svgns,"line"),this.line.setAttribute("stroke",CLMS.xiNET.defaultInterLinkColour.toRGB()),this.line.setAttribute("stroke-linecap","round"),this.highlightLine=document.createElementNS(CLMS.xiNET.svgns,
"line"),this.highlightLine.setAttribute("stroke-linecap","round"));this.line.setAttribute("class","link");this.line.setAttribute("fill","none");this.line.setAttribute("stroke","#000000");this.highlightLine.setAttribute("class","link");this.highlightLine.setAttribute("fill","none");this.highlightLine.setAttribute("stroke",CLMS.xiNET.highlightColour.toRGB());this.highlightLine.setAttribute("stroke-width","10");this.highlightLine.setAttribute("stroke-opacity","0");"undefined"!==typeof this.colour&&this.line.setAttribute("stroke",
this.colour);var a=this;this.line.onmousedown=function(d){a.mouseDown(d)};this.line.onmouseover=function(d){a.mouseOver(d)};this.line.onmouseout=function(d){a.mouseOut(d)};this.line.ontouchstart=function(d){a.touchStart(d)};this.highlightLine.onmousedown=function(d){a.mouseDown(d)};this.highlightLine.onmouseover=function(d){a.mouseOver(d)};this.highlightLine.onmouseout=function(d){a.mouseOut(d)};this.highlightLine.ontouchstart=function(d){a.touchStart(d)}}this.isSelected=!1};
CLMS.xiNET.RenderedCrossLink.prototype.selfLink=function(){return this.crossLink.isSelfLink()};CLMS.xiNET.RenderedCrossLink.prototype.getFromProtein=function(){return this.crossLink.getFromProtein()};CLMS.xiNET.RenderedCrossLink.prototype.getToProtein=function(){return this.crossLink.getToProtein()};CLMS.xiNET.RenderedCrossLink.prototype.showHighlight=function(a,d){};
CLMS.xiNET.RenderedCrossLink.prototype.setSelected=function(a){!0===a&&!1===this.isSelected?(this.crosslinkViewer.selectedLinks.set(this.id,this),this.isSelected=!0,this.highlightLine.setAttribute("stroke",CLMS.xiNET.selectedColour.toRGB()),this.highlightLine.setAttribute("stroke-opacity","0.7"),this.crosslinkViewer.linkSelectionChanged()):!1===a&&!0===this.isSelected&&(this.crosslinkViewer.selectedLinks.remove(this.id),this.isSelected=!1,this.highlightLine.setAttribute("stroke-opacity","0"),this.highlightLine.setAttribute("stroke",
CLMS.xiNET.highlightColour.toRGB()),this.crosslinkViewer.linkSelectionChanged())};CLMS.xiNET.RenderedCrossLink.prototype.check=function(a){if(0<this.crossLink.filteredMatches.length)return this.show(),!0;this.hide();return!1};
CLMS.xiNET.RenderedCrossLink.prototype.dashedLine=function(a){1!=this.crosslinkViewer.unambigLinkFound||"undefined"===typeof this.line||isNaN(parseFloat(this.toResidue))||(a?!0===this.selfLink()?(this.dashed=!0,this.line.setAttribute("stroke-dasharray","4, 4")):(this.dashed=!0,this.line.setAttribute("stroke-dasharray",4*this.crosslinkViewer.z+", "+4*this.crosslinkViewer.z)):a||(this.dashed=!1,this.line.removeAttribute("stroke-dasharray")))};
CLMS.xiNET.RenderedCrossLink.prototype.show=function(){if(!this.shown)if(this.shown=!0,"undefined"===typeof this.line&&this.initSVG(),this.crossLink.isSelfLink()||null===this.proteinLink.toProtein){var a=this.crosslinkViewer.renderedProteins.get(this.crossLink.getFromProtein().id),d=a.getCrossLinkPath(this);this.line.setAttribute("d",d);this.highlightLine.setAttribute("d",d);a.selfLinksHighlights.appendChild(this.highlightLine);a.selfLinks.appendChild(this.line)}else this.line.setAttribute("stroke-width",
this.crosslinkViewer.z*xiNET.linkWidth),this.highlightLine.setAttribute("stroke-width",10*this.crosslinkViewer.z),this.setLineCoordinates(this.getFromProtein()),this.setLineCoordinates(this.getToProtein()),this.crosslinkViewer.highlights.appendChild(this.highlightLine),this.crosslinkViewer.res_resLinks.appendChild(this.line)};
CLMS.xiNET.RenderedCrossLink.prototype.hide=function(){if(this.shown)if(this.shown=!1,this.crossLink.isSelfLink()||null===this.proteinLink.toProtein){var a=this.crosslinkViewer.renderedProteins.get(this.crossLink.getFromProtein().id);a.selfLinksHighlights.removeChild(this.highlightLine);a.selfLinks.removeChild(this.line)}else this.crosslinkViewer.res_resLinks.removeChild(this.line),this.crosslinkViewer.highlights.removeChild(this.highlightLine)};
CLMS.xiNET.RenderedCrossLink.prototype.setLineCoordinates=function(a){if(null!=a.x&&null!=a.y&&!1===this.selfLink()&&null!==this.getToProtein()&&this.shown){var d;this.getFromProtein()===a?(0===a.form?(d=a.x,a=a.y):(a=this.getResidueCoordinates(this.fromResidue,a),d=a[0],a=a[1]),this.line.setAttribute("x1",d),this.line.setAttribute("y1",a),this.highlightLine.setAttribute("x1",d),this.highlightLine.setAttribute("y1",a)):this.getToProtein()===a&&(0===a.form?(d=a.x,a=a.y):(a=this.getResidueCoordinates(this.toResidue,
a),d=a[0],a=a[1]),this.line.setAttribute("x2",d),this.line.setAttribute("y2",a),this.highlightLine.setAttribute("x2",d),this.highlightLine.setAttribute("y2",a))}};
CLMS.xiNET.RenderedCrossLink.prototype.getResidueCoordinates=function(a,d){var b=d.getResXwithStickZoom(a)*this.crosslinkViewer.z,c=0;if(8<Protein.UNITS_PER_RESIDUE*d.stickZoom){var c=this.getFromProtein(),e=this.getToProtein(),f=Math.atan2(c.y-e.y,c.x-e.x)/(2*Math.PI)*360;0>f&&(f+=360);d===c?(c=f-c.rotation,0>c&&(c+=360),e=5,180>c&&(e=-5)):(c=f-e.rotation,0>c&&(c+=360),e=5,180<c&&(e=-5));c=e*this.crosslinkViewer.z}c=Protein.rotatePointAboutPoint([b,c],[0,0],d.rotation);b=c[0]+d.x;c=c[1]+d.y;return[b,
c]};CLMS.xiNET.RenderedCrossLink.prototype.leastAmbiguousMatches=function(){};CLMS.xiNET.RenderedCrossLink.prototype.toJSON=function(){for(var a=[],d=this.matches.length,b=0;b<d;b++)a.push(this.matches[b].id);return{}};CLMS.xiNET.Rotator=function(a,d,b){var c=this;this.ctrl=b;this.proteinOrPartThereof=a;this.upperOrLower=d;this.svg=document.createElementNS(CLMS.xiNET.svgns,"g");this.rotatorSymbol=document.createElementNS(CLMS.xiNET.svgns,"g");a=document.createElementNS(CLMS.xiNET.svgns,"circle");a.setAttribute("r",14);a.setAttribute("stroke","none");a.setAttribute("fill","gray");a.setAttribute("fill-opacity","0.0");this.svg.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"circle");a.setAttribute("r",
20);a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","none");this.rotatorSymbol.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");this.rotatorSymbol.appendChild(a);a=document.createElementNS(CLMS.xiNET.svgns,"path");a.setAttribute("d","M 19.818182,-3 L 16,3.10345 L 23.636363,3.10345 L 19.818182,-3 z ");
a.setAttribute("stroke","black");a.setAttribute("stroke-width","1");a.setAttribute("fill","black");a.setAttribute("transform","rotate(180)");this.rotatorSymbol.appendChild(a);this.rotatorSymbol.setAttribute("transform","rotate(45) scale (0.7, 0.7)");this.rotatorSymbol.setAttribute("display","none");this.inner=document.createElementNS(CLMS.xiNET.svgns,"g");this.inner.setAttribute("class","PV_rotator");this.inner.appendChild(this.rotatorSymbol);this.svg.appendChild(this.inner);this.svg.onmouseover=
function(a){c.rotatorMouseOver(a)};this.svg.onmouseout=function(a){c.rotatorMouseOut(a)};this.svg.onmousedown=function(a){c.rotatorMouseDown(a)}};CLMS.xiNET.Rotator.prototype.rotatorMouseOver=function(a){this.ctrl.rotating||this.rotatorSymbol.setAttribute("display","block")};CLMS.xiNET.Rotator.prototype.rotatorMouseOut=function(a){this.rotatorSymbol.setAttribute("display","none")};
CLMS.xiNET.Rotator.prototype.rotatorMouseDown=function(a){this.ctrl.state=CLMS.xiNET.Controller.ROTATING;this.ctrl.dragElement=this.proteinOrPartThereof;a=this.ctrl.getEventPoint(a);this.ctrl.mouseToSVG(a.x,a.y);this.ctrl.whichCLMS.xiNET.Rotator=this.upperOrLower;return!1};
